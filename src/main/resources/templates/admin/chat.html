<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Qu·∫£n tr·ªã vi√™n ¬∑ Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    :root{ --brand-grad: linear-gradient(90deg, #6f42c1 0%, #0d6efd 100%); }
    body{ background:#f5f7fb; }
    .page-header{
      background:var(--brand-grad); color:#fff; border-radius:16px; padding:16px 20px;
      box-shadow:0 6px 14px rgba(13,110,253,.15);
    }
    .chat-shell{ border-radius:16px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.08); }
    .chat-left{ background:#ffffff; border-right:1px solid #eef0f4; min-height:70vh; }
    .chat-right{ background:#fff; min-height:70vh; display:flex; flex-direction:column; }
    .chat-title{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #eef0f4; background:#fff; }
    .chat-box{
      padding:16px; height:58vh; overflow:auto;
      background:
        radial-gradient(1200px 300px at 100% -20%, rgba(13,110,253,.08), transparent 60%),
        radial-gradient(1200px 300px at -10% 100%, rgba(111,66,193,.08), transparent 60%),
        #fafbff;
    }
    .msg{ margin-bottom:.9rem; display:flex; flex-direction:column; align-items:flex-start; }
    .msg .meta{ font-size:.78rem; color:#6c757d; margin-bottom:.25rem; }
    .msg .bubble{
      background:#fff; border:1px solid #eff2f7; border-radius:14px; padding:.55rem .75rem;
      display:inline-block; max-width:78%; box-shadow:0 2px 6px rgba(0,0,0,.04);
    }
    .msg.me{ align-items:flex-end; }           /* tin c·ªßa admin (m√¨nh) sang ph·∫£i */
    .msg.me .bubble{ background:#d7e9ff; border-color:#cde1ff; }
    .thread-item{ border-radius:10px; padding:10px 12px; cursor:pointer; }
    .thread-item:hover{ background:#f4f7ff; }
    .thread-item.active{ background:#e9f1ff; border:1px solid #d6e6ff; }
    .list-scroll{ height:46vh; overflow:auto; }
    .search-input{ border-radius:12px; }
    .btn-soft{ background:#f1f4ff; border:1px solid #e3e9ff; color:#244; border-radius:10px; }
    .btn-soft:hover{ background:#e7edff; color:#122; }
    .badge-unread{ display:none; }
  </style>
</head>
<body>

<div class="container py-3">
  <div class="page-header mb-3">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <div class="fw-semibold">B·∫£ng ƒëi·ªÅu khi·ªÉn Chat</div>
        <div class="small opacity-75">Qu·∫£n tr·ªã vi√™n trao ƒë·ªïi 1-1 v·ªõi ng∆∞·ªùi d√πng</div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-light btn-sm" onclick="history.back()">‚üµ Quay v·ªÅ</button>
        <a class="btn btn-warning btn-sm" href="/admin/dashboard">üè† Trang ch·ªß Admin</a>
      </div>
    </div>
  </div>

  <div class="row g-3 chat-shell">
    <!-- LEFT -->
    <div class="col-lg-4 chat-left p-3">
      <div class="mb-3">
        <label class="form-label fw-semibold">T√¨m nhanh username ƒë·ªÉ m·ªü chat</label>
        <div class="input-group">
          <span class="input-group-text">üîé</span>
          <input id="partnerInput" class="form-control search-input" placeholder="vd: khoa1, BigKhoa...">
          <button class="btn btn-primary" id="btnOpen">M·ªü</button>
        </div>
      </div>

      <div class="d-flex align-items-center justify-content-between">
        <div class="fw-semibold">G·∫ßn ƒë√¢y</div>
        <button class="btn btn-outline-danger btn-sm" id="btnClearRecent">Xo√° danh s√°ch t·∫°m</button>
      </div>
      <div id="recentList" class="list-scroll mt-2"></div>

      <div class="mt-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="autoOpenToggle" checked>
          <label class="form-check-label" for="autoOpenToggle">T·ª± ƒë·ªông m·ªü cu·ªôc chat khi c√≥ tin m·ªõi</label>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="col-lg-8 chat-right p-0">
      <div class="chat-title">
        <div class="fw-semibold" id="chatTitle">H√£y ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ·ªü c·ªôt b√™n tr√°i, ho·∫∑c ƒë·ª£i user nh·∫Øn ‚Äì khung n√†y s·∫Ω t·ª± m·ªü.</div>
        <div class="d-flex gap-2">
          <span id="statusDot" class="badge text-bg-secondary">Socket: ƒêang k·∫øt n·ªëi‚Ä¶</span>
        </div>
      </div>

      <div id="chatBox" class="chat-box"></div>

      <div class="p-3 border-top">
        <form id="chatForm" class="d-flex gap-2">
          <input type="text" class="form-control" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn v√† nh·∫•n Enter‚Ä¶">
          <button class="btn btn-primary px-4" type="submit">G·ª≠i</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  // L·∫•y username t·ª´ server n·∫øu c√≥; n·∫øu kh√¥ng, v·∫´n OK v√¨ cƒÉn ph·∫£i d·ª±a tr√™n 'partner'
  const myUsername = /*[[${username}?:'ADMIN']]*/ 'ADMIN';
  window.currentUsername = myUsername;

  // === State ===
  let stompClient = null;
  let partner = null;                     // user ƒëang m·ªü ph√≤ng
  const RECENT_KEY = 'adminRecentChatPartners';
  const unreadMap = {};                   // { username: count }

  // === Utils ===
  function escapeHtml(s=''){ return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function normalize(m){
    return {
      from: (m.from ?? m.sender ?? '').toString(),
      to: (m.to ?? m.recipient ?? '').toString(),
      content: (m.content ?? '').toString(),
      timestamp: m.timestamp ?? m.sentAt ?? m.sent_at ?? null
    };
  }
  function timeStr(ts){ const d = ts?new Date(ts):new Date(); return d.toLocaleString('vi-VN'); }

  // === Recent threads (localStorage) ===
  function getRecent(){ try{ return JSON.parse(localStorage.getItem(RECENT_KEY)||'[]'); }catch{ return []; } }
  function setRecent(arr){ localStorage.setItem(RECENT_KEY, JSON.stringify(arr.slice(0,30))); }
  function pushRecent(name){
    if(!name) return;
    const arr = getRecent().filter(x=>x!==name);
    arr.unshift(name);
    setRecent(arr);
    renderRecent();
  }
  function clearRecent(){ localStorage.removeItem(RECENT_KEY); renderRecent(); }

  // === Badge helpers ===
  function setBadge(user, count){
    unreadMap[user] = Math.max(0, count||0);
    const el = document.querySelector(`[data-user="${CSS.escape(user)}"] .badge-unread`);
    if(!el) return;
    const val = unreadMap[user];
    if(val>0){
      el.style.display = 'inline-block';
      el.textContent = val>99 ? '99+' : String(val);
    }else{
      el.style.display = 'none';
      el.textContent = '';
    }
  }

  // === Render sidebar (c√≥ badge) ===
  function renderRecent(){
    const wrap = document.getElementById('recentList');
    const arr = getRecent();
    if(!arr.length){ wrap.innerHTML = '<div class="text-muted small">Ch∆∞a c√≥ l·ªãch s·ª≠ t·∫°m.</div>'; return; }
    wrap.innerHTML = '';
    arr.forEach(u=>{
      const div = document.createElement('div');
      div.className = 'thread-item d-flex align-items-center justify-content-between ' + (u===partner?'active':'');
      div.setAttribute('data-user', u);
      div.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <div class="badge text-bg-primary">U</div>
          <div class="fw-semibold">${escapeHtml(u)}</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge text-bg-danger badge-unread"></span>
          <button class="btn btn-soft btn-sm">M·ªü</button>
        </div>
      `;
      div.addEventListener('click', ()=> openConversation(u));
      wrap.appendChild(div);
      setBadge(u, unreadMap[u]||0);
    });
  }

  // === (Optional) Load t·ª´ server ===
  async function preloadRecentFromServer(){
    try{
      const res = await fetch('/api/chat/partners', { headers:{'Accept':'application/json'} });
      if(!res.ok) return;
      const list = await res.json(); // [{username,lastMessage,lastTime}]
      const serverUsers = list.map(x=>x.username);
      const merged = [...serverUsers, ...getRecent().filter(x=>!serverUsers.includes(x))];
      setRecent(merged);
      renderRecent();
    }catch(e){ }
  }
  async function preloadUnread(){
    try{
      const res = await fetch('/api/chat/unread-map', { headers:{'Accept':'application/json'} });
      if(!res.ok) return;
      const map = await res.json(); // { "userA": 2, "userB": 5 }
      Object.keys(map).forEach(u => setBadge(u, map[u]));
    }catch(e){ }
  }

  // === Chat UI ===
  function setStatus(text, ok){
    const el = document.getElementById('statusDot');
    el.textContent = text;
    el.className = 'badge ' + (ok ? 'text-bg-success' : 'text-bg-secondary');
  }

  function appendMessage(raw){
    const msg = normalize(raw);
    // ‚úÖ Quy t·∫Øc cƒÉn tr√°i/ph·∫£i:
    // N·∫øu ƒë√£ ch·ªçn 'partner': tin c√≥ from === partner => TR√ÅI, c√≤n l·∫°i => PH·∫¢I (admin)
    // N·∫øu ch∆∞a ch·ªçn partner (hi·∫øm khi) th√¨ fallback theo myUsername.
    const mine = partner ? (msg.from !== partner) : (msg.from === myUsername);

    const box = document.getElementById('chatBox');
    const div = document.createElement('div');
    div.className = 'msg' + (mine ? ' me' : '');
    const who = mine ? myUsername : msg.from || 'User';
    div.innerHTML = `
      <div class="meta">${escapeHtml(who)} ‚Ä¢ ${timeStr(msg.timestamp)}</div>
      <div class="bubble">${escapeHtml(msg.content)}</div>
    `;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  function renderHistory(list){
    const box = document.getElementById('chatBox');
    box.innerHTML = '';
    list.map(normalize)
        .sort((a,b)=> new Date(a.timestamp||0)-new Date(b.timestamp||0))
        .forEach(appendMessage);
  }

  async function loadHistory(){
    if(!partner) return;
    try{
      const res = await fetch('/api/chat/history?with=' + encodeURIComponent(partner), { headers:{'Accept':'application/json'} });
      if(!res.ok) return;
      renderHistory(await res.json());
      setBadge(partner, 0);
    }catch(e){ }
  }

  async function openConversation(name){
    partner = name;
    document.getElementById('chatTitle').textContent = 'Chat v·ªõi ' + name;
    pushRecent(name);
    await loadHistory();
    try{ await fetch('/api/chat/mark-read?with='+encodeURIComponent(name), { method:'POST' }); }catch(e){}
    setBadge(name, 0);
    setTimeout(()=> document.getElementById('chatInput').focus(), 0);
  }

  // === Socket ===
  function connectSocket(){
    const socket = new SockJS('/ws-chat');
    stompClient = Stomp.over(socket);
    stompClient.debug = null;

    stompClient.connect({}, () => {
      setStatus('Socket: ƒê√£ k·∫øt n·ªëi', true);

      stompClient.subscribe('/user/queue/messages', frame => {
        const msg = normalize(JSON.parse(frame.body));
        const from = msg.from;
        const to   = msg.to;

        if(from && from !== myUsername) pushRecent(from);

        const isCurrentRoomInbound = partner && from === partner && to === myUsername;
        const isCurrentRoomEchoOut = partner && from === myUsername && to === partner;

        // D√π 2 c·ªù tr√™n c√≥ sai v√¨ myUsername r·ªóng, ph·∫ßn cƒÉn ph·∫£i v·∫´n OK nh·ªù logic d·ª±a v√†o 'partner' trong appendMessage.
        if(partner && (from === partner || to === partner || from !== partner)){
          appendMessage(msg);
          if(partner){ fetch('/api/chat/mark-read?with=' + encodeURIComponent(partner), { method:'POST' }).catch(()=>{}); }
          if(from !== myUsername) setBadge(from, 0);
          return;
        }

        // Badge cho ph√≤ng kh√°c
        if(to === myUsername && from !== myUsername){
          setBadge(from, (unreadMap[from]||0)+1);
        }

        const autoOpen = document.getElementById('autoOpenToggle').checked;
        if(autoOpen && from && from !== myUsername && from !== partner){
          openConversation(from);
          return;
        }
      });
    }, () => setStatus('Socket: M·∫•t k·∫øt n·ªëi', false));
  }

  // === Events ===
  document.getElementById('btnOpen').addEventListener('click', () => {
    const v = document.getElementById('partnerInput').value.trim();
    if(v) openConversation(v);
  });
  document.getElementById('partnerInput').addEventListener('keyup', (e) => {
    if(e.key === 'Enter'){
      const v = e.target.value.trim();
      if(v) openConversation(v);
    }
  });
  document.getElementById('btnClearRecent').addEventListener('click', clearRecent);

  document.getElementById('chatForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('chatInput');
    const content = input.value.trim();
    if(!content) return;
    if(!stompClient || !stompClient.connected){ alert('Ch∆∞a k·∫øt n·ªëi socket. Vui l√≤ng t·∫£i l·∫°i trang.'); return; }
    if(!partner){ alert('H√£y ch·ªçn ng∆∞·ªùi d√πng tr∆∞·ªõc.'); return; }
    stompClient.send('/app/chat.send', {}, JSON.stringify({ to: partner, content }));
    input.value = '';
  });

  // === Boot ===
  renderRecent();
  preloadRecentFromServer();
  preloadUnread();
  connectSocket();
</script>
</body>
</html>
