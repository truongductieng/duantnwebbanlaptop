<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Quản trị viên · Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      :root {
        --brand-grad: linear-gradient(120deg, #4776e6 0%, #8e54e9 100%);
        --glass-bg: rgba(255, 255, 255, 0.95);
        --glass-border: rgba(255, 255, 255, 0.18);
        --msg-sent: linear-gradient(120deg, #4776e6 0%, #6b8dd6 100%);
        --msg-received: rgba(255, 255, 255, 0.8);
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
        --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.12);
        --transition: all 0.3s ease;
      }

      body {
        background: linear-gradient(135deg, #f5f7ff 0%, #f0f7ff 100%);
        min-height: 100vh;
      }

      /* Glass effect containers */
      .glass-container {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
      }

      .page-header {
        background: var(--brand-grad);
        color: #fff;
        border-radius: 24px;
        padding: 24px 32px;
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
      }

      .page-header h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
      }

      .chat-shell {
        border-radius: 24px;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
      }

      .chat-left {
        background: transparent;
        border-right: 1px solid var(--glass-border);
        min-height: 75vh;
        padding: 1.5rem;
      }

      .chat-right {
        background: transparent;
        min-height: 75vh;
        display: flex;
        flex-direction: column;
      }

      .chat-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.5rem;
        border-bottom: 1px solid var(--glass-border);
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }

      .chat-box {
        padding: 1.5rem;
        height: calc(75vh - 140px);
        overflow: auto;
        background: transparent;
      }

      /* Messages */
      .msg {
        margin-bottom: 1.2rem;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        animation: fadeIn 0.3s ease;
      }

      .msg .meta {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0.3rem;
        opacity: 0.8;
      }

      .msg .bubble {
        background: var(--msg-received);
        border-radius: 18px;
        padding: 0.8rem 1.2rem;
        display: inline-block;
        max-width: 80%;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--glass-border);
        transition: var(--transition);
      }

      .msg.me {
        align-items: flex-end;
      }

      .msg.me .bubble {
        background: var(--msg-sent);
        color: white;
        border: none;
      }

      /* Thread list */
      .thread-item {
        border-radius: 16px;
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid transparent;
        margin-bottom: 0.8rem;
        background: rgba(255, 255, 255, 0.5);
      }

      .thread-item:hover {
        background: rgba(255, 255, 255, 0.95);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(71, 118, 230, 0.1);
        border-color: rgba(71, 118, 230, 0.1);
      }

      .thread-item.active {
        background: white;
        border: 1px solid rgba(71, 118, 230, 0.2);
        box-shadow: 0 8px 16px rgba(71, 118, 230, 0.15);
      }

      .thread-item .btn-soft {
        opacity: 0.7;
        transform: translateX(5px);
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .thread-item:hover .btn-soft {
        opacity: 1;
        transform: translateX(0);
      }

      .thread-item .badge.text-bg-primary {
        background: var(--brand-grad) !important;
        padding: 0.6rem;
        transition: all 0.25s ease;
      }

      .thread-item:hover .badge.text-bg-primary {
        transform: scale(1.1);
      }

      .list-scroll {
        height: calc(75vh - 200px);
        overflow: auto;
        padding-right: 0.5rem;
      }

      .thread-item .fw-semibold {
        transition: all 0.25s ease;
      }

      .thread-item:hover .fw-semibold {
        color: #4776e6;
      }

      /* Custom scrollbar */
      .list-scroll::-webkit-scrollbar,
      .chat-box::-webkit-scrollbar {
        width: 6px;
      }

      .list-scroll::-webkit-scrollbar-track,
      .chat-box::-webkit-scrollbar-track {
        background: transparent;
      }

      .list-scroll::-webkit-scrollbar-thumb,
      .chat-box::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
      }

      /* Search and input */
      .search-input {
        border-radius: 16px;
        padding: 0.8rem 1.2rem;
        border: 1px solid var(--glass-border);
        background: rgba(255, 255, 255, 0.8);
        transition: var(--transition);
      }

      .search-input:focus {
        background: white;
        box-shadow: var(--shadow-sm);
        border-color: #4776e6;
      }

      .input-group {
        box-shadow: var(--shadow-sm);
        border-radius: 16px;
        overflow: hidden;
      }

      .input-group-text {
        background: transparent;
        border: none;
        padding-left: 1.2rem;
      }

      .btn {
        border-radius: 16px;
        padding: 0.8rem 1.5rem;
        font-weight: 500;
        transition: var(--transition);
      }

      .btn-primary {
        background: var(--brand-grad);
        border: none;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .btn-soft {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid var(--glass-border);
        color: #444;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .btn-soft:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(71, 118, 230, 0.15);
        border-color: rgba(71, 118, 230, 0.2);
        color: #4776e6;
      }

      .btn-soft:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(71, 118, 230, 0.1);
      }

      /* Form controls */
      .form-control {
        border-radius: 16px;
        padding: 0.8rem 1.2rem;
        border: 1px solid var(--glass-border);
        background: rgba(255, 255, 255, 0.8);
        transition: var(--transition);
      }

      .form-control:focus {
        background: white;
        box-shadow: var(--shadow-sm);
        border-color: #4776e6;
      }

      .badge {
        padding: 0.5rem 0.8rem;
        border-radius: 12px;
      }

      .badge-unread {
        display: none;
        background: #ff4757;
        color: white;
        font-weight: 600;
        padding: 0.3rem 0.6rem;
        min-width: 24px;
        text-align: center;
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Chat input area */
      .chat-input-area {
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-top: 1px solid var(--glass-border);
      }

      .chat-form {
        display: flex;
        gap: 1rem;
      }

      .chat-input {
        flex: 1;
        border-radius: 16px;
        padding: 0.8rem 1.2rem;
        border: 1px solid var(--glass-border);
        background: rgba(255, 255, 255, 0.8);
        transition: var(--transition);
      }

      .chat-input:focus {
        background: white;
        box-shadow: var(--shadow-sm);
        border-color: #4776e6;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="page-header">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h1 class="mb-1">Bảng điều khiển Chat</h1>
            <div class="text-white-50">
              Quản trị viên trao đổi 1-1 với người dùng
            </div>
          </div>
          <div class="d-flex gap-3">
            <button class="btn btn-light" onclick="history.back()">
              <i class="bi bi-arrow-left"></i> Quay về
            </button>
            <a class="btn btn-light" href="/admin/dashboard">
              <i class="bi bi-house-fill"></i> Trang chủ
            </a>
          </div>
        </div>
      </div>

      <div class="row g-4 chat-shell">
        <!-- LEFT SIDEBAR -->
        <div class="col-lg-4 chat-left">
          <div class="mb-4">
            <label class="form-label h6 mb-3">Tìm kiếm người dùng</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="bi bi-search"></i>
              </span>
              <input
                id="partnerInput"
                class="form-control search-input"
                placeholder="Nhập username để tìm kiếm..."
              />
              <button class="btn btn-primary" id="btnOpen">
                <i class="bi bi-arrow-right-circle-fill me-1"></i>
                Mở chat
              </button>
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between mb-3">
            <h6 class="mb-0">Cuộc trò chuyện gần đây</h6>
            <button class="btn btn-soft btn-sm" id="btnClearRecent">
              <i class="bi bi-trash3"></i> Xoá tất cả
            </button>
          </div>

          <div id="recentList" class="list-scroll"></div>

          <div class="mt-4">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="autoOpenToggle"
                checked
              />
              <label class="form-check-label" for="autoOpenToggle">
                Tự động mở chat khi có tin nhắn mới
              </label>
            </div>
          </div>
        </div>

        <!-- RIGHT CHAT AREA -->
        <div class="col-lg-8 chat-right">
          <div class="chat-title">
            <div class="d-flex align-items-center gap-3">
              <div class="h6 mb-0" id="chatTitle">
                Hãy chọn một cuộc trò chuyện hoặc đợi tin nhắn mới
              </div>
              <span id="statusDot" class="badge bg-secondary">
                <i class="bi bi-circle-fill me-1"></i>
                Đang kết nối...
              </span>
            </div>
          </div>

          <div id="chatBox" class="chat-box"></div>

          <div class="chat-input-area">
            <form id="chatForm" class="chat-form">
              <input
                type="text"
                class="chat-input"
                id="chatInput"
                placeholder="Nhập tin nhắn của bạn..."
              />
              <button class="btn btn-primary" type="submit">
                <i class="bi bi-send-fill me-1"></i>
                Gửi
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      // Lấy username từ server nếu có; nếu không, vẫn OK vì căn phải dựa trên 'partner'
      const myUsername = /*[[${username}?:'ADMIN']]*/ "ADMIN";
      window.currentUsername = myUsername;

      // === State ===
      let stompClient = null;
      let partner = null; // user đang mở phòng
      const RECENT_KEY = "adminRecentChatPartners";
      const unreadMap = {}; // { username: count }

      // === Utils ===
      function escapeHtml(s = "") {
        return s.replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }
      function normalize(m) {
        return {
          from: (m.from ?? m.sender ?? "").toString(),
          to: (m.to ?? m.recipient ?? "").toString(),
          content: (m.content ?? "").toString(),
          timestamp: m.timestamp ?? m.sentAt ?? m.sent_at ?? null,
        };
      }
      function timeStr(ts) {
        const d = ts ? new Date(ts) : new Date();
        return d.toLocaleString("vi-VN");
      }

      // === Recent threads (localStorage) ===
      function getRecent() {
        try {
          return JSON.parse(localStorage.getItem(RECENT_KEY) || "[]");
        } catch {
          return [];
        }
      }
      function setRecent(arr) {
        localStorage.setItem(RECENT_KEY, JSON.stringify(arr.slice(0, 30)));
      }
      function pushRecent(name) {
        if (!name) return;
        const arr = getRecent().filter((x) => x !== name);
        arr.unshift(name);
        setRecent(arr);
        renderRecent();
      }
      function clearRecent() {
        localStorage.removeItem(RECENT_KEY);
        renderRecent();
      }

      // === Badge helpers ===
      function setBadge(user, count) {
        unreadMap[user] = Math.max(0, count || 0);
        const el = document.querySelector(
          `[data-user="${CSS.escape(user)}"] .badge-unread`
        );
        if (!el) return;
        const val = unreadMap[user];
        if (val > 0) {
          el.style.display = "inline-block";
          el.textContent = val > 99 ? "99+" : String(val);
        } else {
          el.style.display = "none";
          el.textContent = "";
        }
      }

      // === Render sidebar (có badge) ===
      function renderRecent() {
        const wrap = document.getElementById("recentList");
        const arr = getRecent();
        if (!arr.length) {
          wrap.innerHTML =
            '<div class="text-muted small">Chưa có lịch sử tạm.</div>';
          return;
        }
        wrap.innerHTML = "";
        arr.forEach((u) => {
          const div = document.createElement("div");
          div.className =
            "thread-item d-flex align-items-center justify-content-between " +
            (u === partner ? "active" : "");
          div.setAttribute("data-user", u);
          div.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <div class="badge text-bg-primary">U</div>
          <div class="fw-semibold">${escapeHtml(u)}</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge text-bg-danger badge-unread"></span>
          <button class="btn btn-soft btn-sm">Mở</button>
        </div>
      `;
          div.addEventListener("click", () => openConversation(u));
          wrap.appendChild(div);
          setBadge(u, unreadMap[u] || 0);
        });
      }

      // === (Optional) Load từ server ===
      async function preloadRecentFromServer() {
        try {
          const res = await fetch("/api/chat/partners", {
            headers: { Accept: "application/json" },
          });
          if (!res.ok) return;
          const list = await res.json(); // [{username,lastMessage,lastTime}]
          const serverUsers = list.map((x) => x.username);
          const merged = [
            ...serverUsers,
            ...getRecent().filter((x) => !serverUsers.includes(x)),
          ];
          setRecent(merged);
          renderRecent();
        } catch (e) {}
      }
      async function preloadUnread() {
        try {
          const res = await fetch("/api/chat/unread-map", {
            headers: { Accept: "application/json" },
          });
          if (!res.ok) return;
          const map = await res.json(); // { "userA": 2, "userB": 5 }
          Object.keys(map).forEach((u) => setBadge(u, map[u]));
        } catch (e) {}
      }

      // === Chat UI ===
      function setStatus(text, ok) {
        const el = document.getElementById("statusDot");
        el.textContent = text;
        el.className =
          "badge " + (ok ? "text-bg-success" : "text-bg-secondary");
      }

      function appendMessage(raw) {
        const msg = normalize(raw);
        // ✅ Quy tắc căn trái/phải:
        // Nếu đã chọn 'partner': tin có from === partner => TRÁI, còn lại => PHẢI (admin)
        // Nếu chưa chọn partner (hiếm khi) thì fallback theo myUsername.
        const mine = partner ? msg.from !== partner : msg.from === myUsername;

        const box = document.getElementById("chatBox");
        const div = document.createElement("div");
        div.className = "msg" + (mine ? " me" : "");
        const who = mine ? myUsername : msg.from || "User";
        div.innerHTML = `
      <div class="meta">${escapeHtml(who)} • ${timeStr(msg.timestamp)}</div>
      <div class="bubble">${escapeHtml(msg.content)}</div>
    `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
      }

      function renderHistory(list) {
        const box = document.getElementById("chatBox");
        box.innerHTML = "";
        list
          .map(normalize)
          .sort(
            (a, b) => new Date(a.timestamp || 0) - new Date(b.timestamp || 0)
          )
          .forEach(appendMessage);
      }

      async function loadHistory() {
        if (!partner) return false;
        try {
          const res = await fetch(
            "/api/chat/history?with=" + encodeURIComponent(partner),
            { headers: { Accept: "application/json" } }
          );
          if (!res.ok) {
            if (res.status === 404) {
              return false; // User không tồn tại
            }
            return true; // Lỗi khác, có thể là tạm thời
          }
          renderHistory(await res.json());
          setBadge(partner, 0);
          return true;
        } catch (e) {
          console.error("Error loading history:", e);
          return false;
        }
      }

      async function openConversation(name) {
        const oldPartner = partner;
        partner = name;
        document.getElementById("chatTitle").textContent = "Chat với " + name;

        const historyLoaded = await loadHistory();
        if (!historyLoaded) {
          partner = oldPartner; // Restore old partner if failed
          document.getElementById("chatTitle").textContent = oldPartner
            ? "Chat với " + oldPartner
            : "Hãy chọn một cuộc trò chuyện ở cột bên trái, hoặc đợi user nhắn – khung này sẽ tự mở.";
          alert("Username không tồn tại trong hệ thống!");
          return;
        }

        pushRecent(name);
        try {
          await fetch("/api/chat/mark-read?with=" + encodeURIComponent(name), {
            method: "POST",
          });
        } catch (e) {}
        setBadge(name, 0);
        setTimeout(() => document.getElementById("chatInput").focus(), 0);
      }

      // === Socket ===
      function connectSocket() {
        const socket = new SockJS("/ws-chat");
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect(
          {},
          () => {
            setStatus("Socket: Đã kết nối", true);

            stompClient.subscribe("/user/queue/messages", (frame) => {
              const msg = normalize(JSON.parse(frame.body));
              const from = msg.from;
              const to = msg.to;

              if (from && from !== myUsername) pushRecent(from);

              const isCurrentRoomInbound =
                partner && from === partner && to === myUsername;
              const isCurrentRoomEchoOut =
                partner && from === myUsername && to === partner;

              // Dù 2 cờ trên có sai vì myUsername rỗng, phần căn phải vẫn OK nhờ logic dựa vào 'partner' trong appendMessage.
              if (
                partner &&
                (from === partner || to === partner || from !== partner)
              ) {
                appendMessage(msg);
                if (partner) {
                  fetch(
                    "/api/chat/mark-read?with=" + encodeURIComponent(partner),
                    { method: "POST" }
                  ).catch(() => {});
                }
                if (from !== myUsername) setBadge(from, 0);
                return;
              }

              // Badge cho phòng khác
              if (to === myUsername && from !== myUsername) {
                setBadge(from, (unreadMap[from] || 0) + 1);
              }

              const autoOpen =
                document.getElementById("autoOpenToggle").checked;
              if (autoOpen && from && from !== myUsername && from !== partner) {
                openConversation(from);
                return;
              }
            });
          },
          () => setStatus("Socket: Mất kết nối", false)
        );
      }

      // === Check username exists ===
      let availableUsers = []; // Lưu cache danh sách users

      async function loadAvailableUsers() {
        try {
          const res = await fetch("/api/chat/partners", {
            headers: { Accept: "application/json" },
          });
          if (!res.ok) return [];
          const data = await res.json();
          return data.map((x) => x.username);
        } catch (e) {
          console.error("Error loading users:", e);
          return [];
        }
      }

      async function checkUsernameExists(username) {
        // Refresh danh sách users
        availableUsers = await loadAvailableUsers();
        console.log("Available users:", availableUsers);

        // Kiểm tra username có trong danh sách không
        return availableUsers.includes(username);
      }

      // === Events ===
      async function handleOpenChat(username) {
        const v = username.trim();
        if (!v) return;

        try {
          if (await checkUsernameExists(v)) {
            openConversation(v);
          } else {
            alert(
              "Username không tồn tại trong hệ thống hoặc không có quyền chat!"
            );
          }
        } catch (e) {
          console.error("Error in handleOpenChat:", e);
          alert("Có lỗi xảy ra khi kiểm tra username. Vui lòng thử lại sau.");
        }
      }

      document.getElementById("btnOpen").addEventListener("click", () => {
        const v = document.getElementById("partnerInput").value.trim();
        if (v) handleOpenChat(v);
      });

      document.getElementById("partnerInput").addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
          const v = e.target.value.trim();
          if (v) handleOpenChat(v);
        }
      });
      document
        .getElementById("btnClearRecent")
        .addEventListener("click", clearRecent);

      document.getElementById("chatForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const input = document.getElementById("chatInput");
        const content = input.value.trim();
        if (!content) return;
        if (!stompClient || !stompClient.connected) {
          alert("Chưa kết nối socket. Vui lòng tải lại trang.");
          return;
        }
        if (!partner) {
          alert("Hãy chọn người dùng trước.");
          return;
        }
        stompClient.send(
          "/app/chat.send",
          {},
          JSON.stringify({ to: partner, content })
        );
        input.value = "";
      });

      // === Boot ===
      renderRecent();
      preloadRecentFromServer();
      preloadUnread();
      connectSocket();
    </script>
  </body>
</html>
