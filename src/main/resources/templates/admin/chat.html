<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Quản trị viên · Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/vi.js"></script>
    <style>
      :root {
        /* Messenger colors */
        --messenger-blue: #0084ff;
        --messenger-blue-light: #00a2ff;
        --messenger-grey: #f0f2f5;
        --messenger-grey-dark: #e4e6eb;

        /* Custom variables */
        --brand-grad: linear-gradient(120deg, #0084ff 0%, #00a2ff 100%);
        --brand-grad-hover: linear-gradient(120deg, #0073e6 0%, #0091e6 100%);
        --brand-grad-soft: linear-gradient(
          120deg,
          rgba(0, 132, 255, 0.1) 0%,
          rgba(0, 162, 255, 0.1) 100%
        );
        --glass-bg: rgb(255, 255, 255);
        --glass-border: #e4e6eb;
        --msg-sent: var(--messenger-blue);
        --msg-received: var(--messenger-grey);
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.07);
        --shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.1);
        --shadow-hover: 0 12px 32px rgba(0, 132, 255, 0.15);
        --transition: all 0.2s ease;
        --bs-primary-rgb: 0, 132, 255;
        --bs-font-sans-serif: "Segoe UI", system-ui, -apple-system, sans-serif;
        --text-primary: #050505;
        --text-secondary: #65676b;
        --text-muted: #8a8d91;
        --border-color: #ced0d4;
      }

      body {
        background: var(--messenger-grey);
        min-height: 100vh;
        font-family: var(--bs-font-sans-serif);
        line-height: 1.4;
        color: var(--text-primary);
        -webkit-font-smoothing: antialiased;
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        color: var(--text-primary);
        font-weight: 600;
        letter-spacing: -0.01em;
      }

      .text-muted {
        color: var(--text-secondary) !important;
      }

      /* Glass effect containers */
      .glass-container {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        transition: var(--transition);
      }

      .glass-container:hover {
        box-shadow: var(--shadow-md);
        border-color: rgba(71, 118, 230, 0.1);
      }

      .page-header {
        background: var(--brand-grad);
        color: #fff;
        border-radius: 24px;
        padding: 32px;
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
      }

      .page-header::before {
        content: "";
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: linear-gradient(rgba(255, 255, 255, 0.1), transparent);
        transform: rotate(45deg);
        animation: shimmer 6s linear infinite;
      }

      @keyframes shimmer {
        from {
          transform: rotate(45deg) translateX(-150%);
        }
        to {
          transform: rotate(45deg) translateX(150%);
        }
      }

      .page-header .btn-light {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
      }

      .page-header .btn-light:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .page-header h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
      }

      .chat-shell {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
      }

      .chat-shell:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .chat-left {
        background: transparent;
        border-right: 1px solid var(--glass-border);
        min-height: 75vh;
        padding: 1.5rem;
      }

      .chat-right {
        background: transparent;
        min-height: 75vh;
        display: flex;
        flex-direction: column;
      }

      .chat-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.5rem;
        border-bottom: 1px solid var(--glass-border);
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }

      .chat-box {
        padding: 1.5rem;
        height: calc(75vh - 140px);
        overflow: auto;
        background: transparent;
        scroll-behavior: smooth;
      }

      .chat-box::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      .chat-box::-webkit-scrollbar-track {
        background: transparent;
      }

      .chat-box::-webkit-scrollbar-thumb {
        background: rgba(71, 118, 230, 0.2);
        border-radius: 3px;
        transition: var(--transition);
      }

      .chat-box::-webkit-scrollbar-thumb:hover {
        background: rgba(71, 118, 230, 0.4);
      }

      /* Empty state */
      .chat-box:empty::before {
        content: "👋 Chọn một cuộc trò chuyện hoặc đợi tin nhắn mới";
        display: block;
        text-align: center;
        color: var(--text-muted);
        padding: 2rem;
        font-size: 0.95rem;
      }

      /* Messages */
      .msg {
        margin-bottom: 1.2rem;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        max-width: 85%;
      }

      .msg.me {
        margin-left: auto;
      }

      .msg:not(.me) {
        margin-right: auto;
      }

      @media (min-width: 768px) {
        .msg {
          max-width: 70%;
        }
      }

      .msg .meta {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0.3rem;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .msg:hover .meta {
        opacity: 0.8;
      }

      .msg .bubble {
        background: var(--msg-received);
        border-radius: 20px;
        padding: 8px 12px;
        display: inline-block;
        max-width: 80%;
        transition: var(--transition);
        position: relative;
        font-size: 0.9375rem;
        line-height: 1.3333;
      }

      .msg .bubble:first-child {
        border-top-left-radius: 4px;
      }

      .msg .bubble + .bubble {
        margin-top: 2px;
        border-top-left-radius: 20px;
      }

      .msg.me {
        align-items: flex-end;
      }

      .msg.me .bubble {
        background: var(--msg-sent);
        color: white;
        border: none;
        position: relative;
      }

      .msg.me .bubble:first-child {
        border-top-right-radius: 4px;
        border-top-left-radius: 20px;
      }

      .msg.me .bubble + .bubble {
        border-top-right-radius: 20px;
      }

      /* Emoji size */
      .msg .bubble .emoji {
        font-size: 1.4em;
        line-height: 1;
        vertical-align: -0.1em;
      }

      /* Link style */
      .msg .bubble a {
        color: inherit;
        text-decoration: underline;
        text-underline-offset: 2px;
        opacity: 0.9;
      }

      .msg .bubble a:hover {
        opacity: 1;
      }

      /* Thread list */
      .thread-item {
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        transition: var(--transition);
        margin-bottom: 2px;
        background: transparent;
        position: relative;
      }

      .thread-item:hover {
        background: var(--messenger-grey-dark);
      }

      .thread-item.active {
        background: var(--messenger-grey-dark);
      }

      .thread-item .badge.text-bg-primary {
        width: 36px;
        height: 36px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        background: var(--messenger-blue) !important;
      }

      .thread-item.active::before {
        opacity: 0.03;
      }

      .thread-item .badge.text-bg-primary {
        background: var(--brand-grad) !important;
        border: none;
        box-shadow: var(--shadow-sm);
        transform-origin: center;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(71, 118, 230, 0.4);
        }
        70% {
          transform: scale(1.05);
          box-shadow: 0 0 0 10px rgba(71, 118, 230, 0);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(71, 118, 230, 0);
        }
      }

      .thread-item .btn-soft {
        opacity: 0.7;
        transform: translateX(5px);
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        z-index: 1;
      }

      .thread-item .badge-unread {
        animation: bounce 1s infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-3px);
        }
      }
      .thread-item:hover .btn-soft {
        opacity: 1;
        transform: translateX(0);
      }

      .thread-item .badge.text-bg-primary {
        background: var(--brand-grad) !important;
        padding: 0.6rem;
        transition: all 0.25s ease;
      }

      .thread-item:hover .badge.text-bg-primary {
        transform: scale(1.1);
      }

      .list-scroll {
        height: calc(75vh - 200px);
        overflow: auto;
        padding-right: 0.5rem;
      }

      .thread-item .fw-semibold {
        transition: all 0.25s ease;
      }

      .thread-item:hover .fw-semibold {
        color: #4776e6;
      }

      /* Custom scrollbar */
      .list-scroll::-webkit-scrollbar,
      .chat-box::-webkit-scrollbar {
        width: 6px;
      }

      .list-scroll::-webkit-scrollbar-track,
      .chat-box::-webkit-scrollbar-track {
        background: transparent;
      }

      .list-scroll::-webkit-scrollbar-thumb,
      .chat-box::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
      }

      /* Search and input */
      .search-input {
        border-radius: 16px;
        padding: 0.8rem 1.2rem;
        border: 1px solid var(--glass-border);
        background: rgba(255, 255, 255, 0.8);
        transition: var(--transition);
      }

      .search-input:focus {
        background: white;
        box-shadow: var(--shadow-sm);
        border-color: #4776e6;
      }

      .input-group {
        box-shadow: var(--shadow-sm);
        border-radius: 16px;
        overflow: hidden;
      }

      .input-group-text {
        background: transparent;
        border: none;
        padding-left: 1.2rem;
      }

      .btn {
        border-radius: 16px;
        padding: 0.8rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .btn::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 120%;
        height: 120%;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transform: translate(-50%, -50%) scale(0);
        transition: transform 0.5s ease;
        pointer-events: none;
      }

      .btn:active::after {
        transform: translate(-50%, -50%) scale(1);
        transition: transform 0s;
      }

      .btn-primary {
        background: var(--brand-grad);
        border: none;
        position: relative;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
        background: var(--brand-grad-hover);
      }

      .btn-primary:active {
        transform: translateY(1px);
      }

      .btn-soft {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid var(--glass-border);
        color: #444;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .btn-soft:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(71, 118, 230, 0.15);
        border-color: rgba(71, 118, 230, 0.2);
        color: #4776e6;
      }

      .btn-soft:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(71, 118, 230, 0.1);
      }

      /* Form controls */
      .form-control {
        border-radius: 16px;
        padding: 0.8rem 1.2rem;
        border: 2px solid var(--glass-border);
        background: rgba(255, 255, 255, 0.8);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.95rem;
      }

      .form-control:focus {
        background: white;
        box-shadow: 0 0 0 4px rgba(71, 118, 230, 0.1);
        border-color: #4776e6;
        outline: none;
      }

      .form-control::placeholder {
        color: #6c757d;
        opacity: 0.7;
        transition: opacity 0.3s ease;
      }

      .form-control:focus::placeholder {
        opacity: 0.4;
      }

      .badge {
        padding: 0.5rem 0.8rem;
        border-radius: 12px;
        font-weight: 500;
        letter-spacing: 0.02em;
      }

      .badge-unread {
        display: none;
        background: #ff4757;
        color: white;
        font-weight: 600;
        padding: 0.3rem 0.6rem;
        min-width: 24px;
        text-align: center;
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(15px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* Chat input area */
      .chat-input-area {
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-top: 1px solid var(--glass-border);
        position: relative;
      }

      .chat-input-area::before {
        content: "";
        position: absolute;
        top: -1px;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          to right,
          transparent,
          rgba(71, 118, 230, 0.2),
          transparent
        );
      }

      .chat-form {
        display: flex;
        gap: 1rem;
        position: relative;
      }

      .chat-input {
        flex: 1;
        border-radius: 20px;
        padding: 8px 12px 8px 40px;
        border: none;
        background: var(--messenger-grey);
        transition: var(--transition);
        font-size: 0.9375rem;
        line-height: 1.3333;
      }

      .chat-input:focus {
        background: var(--messenger-grey);
        outline: none;
        box-shadow: none;
      }

      .chat-form::before {
        content: "\F60C";
        font-family: "bootstrap-icons";
        position: absolute;
        left: 1.2rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        opacity: 0.7;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .chat-form:focus-within::before {
        opacity: 1;
        color: #4776e6;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="page-header">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h1 class="mb-1">
              <i class="bi bi-chat-dots-fill me-2"></i>
              Bảng điều khiển Chat
            </h1>
            <div class="text-white-50">
              <i class="bi bi-people-fill me-1"></i>
              Quản trị viên trao đổi 1-1 với người dùng
            </div>
          </div>
          <div class="d-flex gap-3">
            <button class="btn btn-light" onclick="history.back()">
              <i class="bi bi-arrow-left"></i>
              <span class="ms-1">Quay về</span>
            </button>
            <a class="btn btn-light" href="/admin/dashboard">
              <i class="bi bi-house-fill"></i>
              <span class="ms-1">Dashboard</span>
            </a>
          </div>
        </div>
      </div>

      <div class="row g-4 chat-shell">
        <!-- LEFT SIDEBAR -->
        <div class="col-lg-4 chat-left">
          <div class="mb-4">
            <label class="form-label h6 mb-3">Tìm kiếm người dùng</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="bi bi-search"></i>
              </span>
              <input
                id="partnerInput"
                class="form-control search-input"
                placeholder="Nhập username để tìm kiếm..."
              />
              <button class="btn btn-primary" id="btnOpen">
                <i class="bi bi-arrow-right-circle-fill me-1"></i>
                Mở chat
              </button>
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between mb-3">
            <h6 class="mb-0">Cuộc trò chuyện gần đây</h6>
            <button class="btn btn-soft btn-sm" id="btnClearRecent">
              <i class="bi bi-trash3"></i> Xoá tất cả
            </button>
          </div>

          <div id="recentList" class="list-scroll"></div>

          <div class="mt-4">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="autoOpenToggle"
                checked
              />
              <label class="form-check-label" for="autoOpenToggle">
                Tự động mở chat khi có tin nhắn mới
              </label>
            </div>
          </div>
        </div>

        <!-- RIGHT CHAT AREA -->
        <div class="col-lg-8 chat-right">
          <div class="chat-title">
            <div class="d-flex align-items-center gap-3">
              <div class="h6 mb-0" id="chatTitle">
                Hãy chọn một cuộc trò chuyện hoặc đợi tin nhắn mới
              </div>
              <span id="statusDot" class="badge bg-secondary">
                <i class="bi bi-circle-fill me-1"></i>
                Đang kết nối...
              </span>
            </div>
          </div>

          <div id="chatBox" class="chat-box"></div>

          <div class="chat-input-area">
            <form id="chatForm" class="chat-form">
              <input
                type="text"
                class="chat-input"
                id="chatInput"
                placeholder="Nhập tin nhắn của bạn..."
              />
              <button class="btn btn-primary" type="submit">
                <i class="bi bi-send-fill me-1"></i>
                Gửi
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      // Lấy username từ server nếu có; nếu không, vẫn OK vì căn phải dựa trên 'partner'
      const myUsername = /*[[${username}?:'ADMIN']]*/ "ADMIN";
      window.currentUsername = myUsername;

      // === State ===
      let stompClient = null;
      let partner = null; // user đang mở phòng
      const RECENT_KEY = "adminRecentChatPartners";
      const unreadMap = {}; // { username: count }

      // === Utils ===
      function escapeHtml(s = "") {
        return s.replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }
      function normalize(m) {
        return {
          from: (m.from ?? m.sender ?? "").toString(),
          to: (m.to ?? m.recipient ?? "").toString(),
          content: (m.content ?? "").toString(),
          timestamp: m.timestamp ?? m.sentAt ?? m.sent_at ?? null,
        };
      }

      function formatMessageContent(content) {
        if (!content) return "";

        // Escape HTML first
        let text = escapeHtml(content);

        // Convert URLs to clickable links
        text = text.replace(
          /(https?:\/\/[^\s]+)/g,
          '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-primary">$1</a>'
        );

        // Convert emojis to larger size
        text = text.replace(
          /([\u{1F300}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}])/gu,
          '<span class="emoji">$1</span>'
        );

        return text;
      }
      function timeStr(ts) {
        const d = ts ? new Date(ts) : new Date();
        // Format time using moment.js with Vietnamese locale
        return moment(d).locale("vi").fromNow();
      }

      // Format absolute time for tooltip
      function absoluteTimeStr(ts) {
        const d = ts ? new Date(ts) : new Date();
        return moment(d).locale("vi").format("LLL");
      }

      // === Recent threads (localStorage) ===
      function getRecent() {
        try {
          return JSON.parse(localStorage.getItem(RECENT_KEY) || "[]");
        } catch {
          return [];
        }
      }
      function setRecent(arr) {
        localStorage.setItem(RECENT_KEY, JSON.stringify(arr.slice(0, 30)));
      }
      function pushRecent(name) {
        if (!name) return;
        const arr = getRecent().filter((x) => x !== name);
        arr.unshift(name);
        setRecent(arr);
        renderRecent();
      }
      async function deleteConversation(username, event) {
        event.stopPropagation(); // Ngăn việc mở cuộc trò chuyện khi nhấn nút xóa

        try {
          const result = await Swal.fire({
            title: "Xác nhận xóa?",
            text: `Bạn có chắc muốn xóa vĩnh viễn cuộc trò chuyện với ${username}? Dữ liệu sẽ bị xóa hoàn toàn và không thể khôi phục.`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#dc3545",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "Xóa vĩnh viễn",
            cancelButtonText: "Hủy",
          });

          if (result.isConfirmed) {
            // Hiển thị loading
            Swal.fire({
              title: "Đang xóa...",
              text: "Vui lòng đợi trong giây lát",
              allowOutsideClick: false,
              allowEscapeKey: false,
              allowEnterKey: false,
              showConfirmButton: false,
              didOpen: () => {
                Swal.showLoading();
              },
            });

            // Lấy CSRF token
            const csrfToken = document
              .querySelector('meta[name="_csrf"]')
              .getAttribute("content");
            const csrfHeader = document
              .querySelector('meta[name="_csrf_header"]')
              .getAttribute("content");

            // Gọi API để xóa dữ liệu trên server
            const response = await fetch("/api/chat/delete-conversation", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfToken,
              },
              body: JSON.stringify({
                username: username,
              }),
            });

            if (!response.ok) {
              const errorData = await response.text();
              throw new Error(errorData || "Lỗi khi xóa dữ liệu trên server");
            }

            // Xóa khỏi danh sách gần đây trong localStorage
            const arr = getRecent().filter((x) => x !== username);
            setRecent(arr);

            // Xóa số tin nhắn chưa đọc
            delete unreadMap[username];

            // Nếu đang trong cuộc trò chuyện bị xóa, làm trống khung chat
            if (partner === username) {
              partner = null;
              document.getElementById("chatBox").innerHTML = "";
              document.getElementById("chatTitle").textContent =
                "Hãy chọn một cuộc trò chuyện hoặc đợi tin nhắn mới";
            }

            renderRecent();

            // Thông báo thành công
            await Swal.fire({
              icon: "success",
              title: "Đã xóa thành công!",
              text: `Cuộc trò chuyện với ${username} đã được xóa vĩnh viễn khỏi hệ thống.`,
              confirmButtonText: "Đóng",
              confirmButtonColor: "#4776e6",
            });
          }
        } catch (error) {
          console.error("Lỗi khi xóa chat:", error);
          await Swal.fire({
            icon: "error",
            title: "Lỗi!",
            text: "Không thể xóa dữ liệu chat. Vui lòng thử lại sau.",
            confirmButtonText: "Đóng",
            confirmButtonColor: "#dc3545",
          });
        }
      }
      function clearRecent() {
        Swal.fire({
          title: "Xác nhận xóa?",
          text: "Bạn có chắc muốn xóa tất cả lịch sử chat không?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#dc3545",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Xóa tất cả",
          cancelButtonText: "Hủy",
        }).then((result) => {
          if (result.isConfirmed) {
            localStorage.removeItem(RECENT_KEY);
            renderRecent();
            partner = null;
            document.getElementById("chatBox").innerHTML = "";
            document.getElementById("chatTitle").textContent =
              "Hãy chọn một cuộc trò chuyện hoặc đợi tin nhắn mới";
            Swal.fire(
              "Đã xóa!",
              "Lịch sử chat đã được xóa thành công.",
              "success"
            );
          }
        });
      }

      // === Badge helpers ===
      function setBadge(user, count) {
        unreadMap[user] = Math.max(0, count || 0);
        const el = document.querySelector(
          `[data-user="${CSS.escape(user)}"] .badge-unread`
        );
        if (!el) return;
        const val = unreadMap[user];
        if (val > 0) {
          el.style.display = "inline-block";
          el.textContent = val > 99 ? "99+" : String(val);

          // Add notification sound
          const audio = new Audio("/sounds/notification.mp3");
          audio.volume = 0.5;
          audio.play().catch(() => {});

          // Desktop notification
          if (Notification.permission === "granted") {
            new Notification("Tin nhắn mới", {
              body: `Bạn có ${val} tin nhắn mới từ ${user}`,
              icon: "/images/chat-icon.png",
            });
          }
        } else {
          el.style.display = "none";
          el.textContent = "";
        }
      }

      // === Render sidebar (có badge) ===
      function renderRecent() {
        const wrap = document.getElementById("recentList");
        const arr = getRecent();
        if (!arr.length) {
          wrap.innerHTML =
            '<div class="text-muted small">Chưa có lịch sử tạm.</div>';
          return;
        }
        wrap.innerHTML = "";
        arr.forEach((u) => {
          const div = document.createElement("div");
          div.className =
            "thread-item d-flex align-items-center justify-content-between " +
            (u === partner ? "active" : "");
          div.setAttribute("data-user", u);
          div.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <div class="badge text-bg-primary">U</div>
          <div class="fw-semibold">${escapeHtml(u)}</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge text-bg-danger badge-unread"></span>
          <button class="btn btn-soft btn-sm" onclick="openConversation('${escapeHtml(
            u
          )}')">
            <i class="bi bi-chat-dots-fill me-1"></i>Mở
          </button>
          <button class="btn btn-danger btn-sm" onclick="deleteConversation('${escapeHtml(
            u
          )}', event)" title="Xóa cuộc trò chuyện">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      `;
          div.addEventListener("click", () => openConversation(u));
          wrap.appendChild(div);
          setBadge(u, unreadMap[u] || 0);
        });
      }

      // === (Optional) Load từ server ===
      async function preloadRecentFromServer() {
        try {
          const res = await fetch("/api/chat/partners", {
            headers: { Accept: "application/json" },
          });
          if (!res.ok) return;
          const list = await res.json(); // [{username,lastMessage,lastTime}]
          const serverUsers = list.map((x) => x.username);
          const merged = [
            ...serverUsers,
            ...getRecent().filter((x) => !serverUsers.includes(x)),
          ];
          setRecent(merged);
          renderRecent();
        } catch (e) {}
      }
      async function preloadUnread() {
        try {
          const res = await fetch("/api/chat/unread-map", {
            headers: { Accept: "application/json" },
          });
          if (!res.ok) return;
          const map = await res.json(); // { "userA": 2, "userB": 5 }
          Object.keys(map).forEach((u) => setBadge(u, map[u]));
        } catch (e) {}
      }

      // === Chat UI ===
      function setStatus(text, ok) {
        const el = document.getElementById("statusDot");
        el.textContent = text;
        el.className =
          "badge " + (ok ? "text-bg-success" : "text-bg-secondary");
      }

      function appendMessage(raw) {
        const msg = normalize(raw);
        // ✅ Quy tắc căn trái/phải:
        // Nếu đã chọn 'partner': tin có from === partner => TRÁI, còn lại => PHẢI (admin)
        // Nếu chưa chọn partner (hiếm khi) thì fallback theo myUsername.
        const mine = partner ? msg.from !== partner : msg.from === myUsername;

        const box = document.getElementById("chatBox");
        const div = document.createElement("div");
        div.className = "msg" + (mine ? " me" : "");
        const who = mine ? myUsername : msg.from || "User";
        const time = timeStr(msg.timestamp);
        const absoluteTime = absoluteTimeStr(msg.timestamp);

        div.innerHTML = `
          <div class="meta" title="${absoluteTime}">
            <i class="bi ${mine ? "bi-person-circle" : "bi-person"} me-1"></i>
            ${escapeHtml(who)} • ${time}
          </div>
          <div class="bubble" data-timestamp="${msg.timestamp}">
            ${formatMessageContent(msg.content)}
          </div>
        `;

        // Link preview if message contains URL
        if (msg.content.match(/https?:\/\/[^\s]+/)) {
          const url = msg.content.match(/https?:\/\/[^\s]+/)[0];
          const previewDiv = document.createElement("div");
          previewDiv.className = "link-preview mt-2";
          previewDiv.innerHTML = `
            <a href="${url}" target="_blank" rel="noopener noreferrer" 
               class="d-flex align-items-center p-2 rounded bg-light text-decoration-none">
              <i class="bi bi-link-45deg me-2 text-primary"></i>
              <span class="text-truncate">${url}</span>
              <i class="bi bi-box-arrow-up-right ms-2 text-muted"></i>
            </a>
          `;
          div.appendChild(previewDiv);
        }
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
      }

      function renderHistory(list) {
        const box = document.getElementById("chatBox");
        box.innerHTML = "";
        list
          .map(normalize)
          .sort(
            (a, b) => new Date(a.timestamp || 0) - new Date(b.timestamp || 0)
          )
          .forEach(appendMessage);
      }

      async function loadHistory() {
        if (!partner) return false;
        try {
          const res = await fetch(
            "/api/chat/history?with=" + encodeURIComponent(partner),
            { headers: { Accept: "application/json" } }
          );
          if (!res.ok) {
            if (res.status === 404) {
              return false; // User không tồn tại
            }
            return true; // Lỗi khác, có thể là tạm thời
          }
          renderHistory(await res.json());
          setBadge(partner, 0);
          return true;
        } catch (e) {
          console.error("Error loading history:", e);
          return false;
        }
      }

      async function openConversation(name) {
        const oldPartner = partner;
        partner = name;
        document.getElementById("chatTitle").textContent = "Chat với " + name;

        const historyLoaded = await loadHistory();
        if (!historyLoaded) {
          partner = oldPartner; // Restore old partner if failed
          document.getElementById("chatTitle").textContent = oldPartner
            ? "Chat với " + oldPartner
            : "Hãy chọn một cuộc trò chuyện ở cột bên trái, hoặc đợi user nhắn – khung này sẽ tự mở.";
          Swal.fire({
            icon: "error",
            title: "Không tìm thấy",
            text: "Username không tồn tại trong hệ thống!",
            confirmButtonText: "Đóng",
            confirmButtonColor: "#4776e6",
          });
          return;
        }

        pushRecent(name);
        try {
          await fetch("/api/chat/mark-read?with=" + encodeURIComponent(name), {
            method: "POST",
            headers: {
              [document
                .querySelector('meta[name="_csrf_header"]')
                .getAttribute("content")]: document
                .querySelector('meta[name="_csrf"]')
                .getAttribute("content"),
            },
          });
        } catch (e) {}
        setBadge(name, 0);

        // Focus input with smooth scroll
        setTimeout(() => {
          const input = document.getElementById("chatInput");
          input.focus();
          input.scrollIntoView({ behavior: "smooth" });
        }, 100);
      }

      // === Socket ===
      function connectSocket() {
        const socket = new SockJS("/ws-chat");
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect(
          {},
          () => {
            setStatus("Socket: Đã kết nối", true);

            stompClient.subscribe("/user/queue/messages", (frame) => {
              const msg = normalize(JSON.parse(frame.body));

              // Kiểm tra nếu là thông báo xóa chat
              if (msg.content === "CHAT_DELETED") {
                const deletedPartner =
                  msg.from === myUsername ? msg.to : msg.from;

                // Xóa khỏi recent list
                const arr = getRecent().filter((x) => x !== deletedPartner);
                setRecent(arr);

                // Reset chat box nếu đang mở chat với người bị xóa
                if (partner === deletedPartner) {
                  partner = null;
                  document.getElementById("chatBox").innerHTML = "";
                  document.getElementById("chatTitle").textContent =
                    "Hãy chọn một cuộc trò chuyện hoặc đợi tin nhắn mới";
                }

                // Xóa badge
                delete unreadMap[deletedPartner];

                // Render lại UI
                renderRecent();
                return;
              }

              const from = msg.from;
              const to = msg.to;

              if (from && from !== myUsername) pushRecent(from);

              const isCurrentRoomInbound =
                partner && from === partner && to === myUsername;
              const isCurrentRoomEchoOut =
                partner && from === myUsername && to === partner;

              // Dù 2 cờ trên có sai vì myUsername rỗng, phần căn phải vẫn OK nhờ logic dựa vào 'partner' trong appendMessage.
              if (
                partner &&
                (from === partner || to === partner || from !== partner)
              ) {
                appendMessage(msg);
                if (partner) {
                  fetch(
                    "/api/chat/mark-read?with=" + encodeURIComponent(partner),
                    { method: "POST" }
                  ).catch(() => {});
                }
                if (from !== myUsername) setBadge(from, 0);
                return;
              }

              // Badge cho phòng khác
              if (to === myUsername && from !== myUsername) {
                setBadge(from, (unreadMap[from] || 0) + 1);
              }

              const autoOpen =
                document.getElementById("autoOpenToggle").checked;
              if (autoOpen && from && from !== myUsername && from !== partner) {
                openConversation(from);
                return;
              }
            });
          },
          () => setStatus("Socket: Mất kết nối", false)
        );
      }

      // === Check username exists ===
      let availableUsers = []; // Lưu cache danh sách users

      async function loadAvailableUsers() {
        try {
          const res = await fetch("/api/chat/partners", {
            headers: { Accept: "application/json" },
          });
          if (!res.ok) return [];
          const data = await res.json();
          return data.map((x) => x.username);
        } catch (e) {
          console.error("Error loading users:", e);
          return [];
        }
      }

      async function checkUsernameExists(username) {
        // Refresh danh sách users
        availableUsers = await loadAvailableUsers();
        console.log("Available users:", availableUsers);

        // Kiểm tra username có trong danh sách không
        return availableUsers.includes(username);
      }

      // === Events ===
      async function handleOpenChat(username) {
        const v = username.trim();
        if (!v) return;

        try {
          if (await checkUsernameExists(v)) {
            openConversation(v);
          } else {
            alert(
              "Username không tồn tại trong hệ thống hoặc không có quyền chat!"
            );
          }
        } catch (e) {
          console.error("Error in handleOpenChat:", e);
          alert("Có lỗi xảy ra khi kiểm tra username. Vui lòng thử lại sau.");
        }
      }

      document.getElementById("btnOpen").addEventListener("click", () => {
        const v = document.getElementById("partnerInput").value.trim();
        if (v) handleOpenChat(v);
      });

      document.getElementById("partnerInput").addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
          const v = e.target.value.trim();
          if (v) handleOpenChat(v);
        }
      });
      document
        .getElementById("btnClearRecent")
        .addEventListener("click", clearRecent);

      document.getElementById("chatForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const input = document.getElementById("chatInput");
        const content = input.value.trim();
        if (!content) return;
        if (!stompClient || !stompClient.connected) {
          alert("Chưa kết nối socket. Vui lòng tải lại trang.");
          return;
        }
        if (!partner) {
          alert("Hãy chọn người dùng trước.");
          return;
        }
        stompClient.send(
          "/app/chat.send",
          {},
          JSON.stringify({ to: partner, content })
        );
        input.value = "";
      });

      // === Boot ===
      renderRecent();
      preloadRecentFromServer();
      preloadUnread();
      connectSocket();
    </script>
  </body>
</html>
