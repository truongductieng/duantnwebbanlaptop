
    
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard</title>

    <!-- CSRF cho AJAX -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet" />
    <!-- Admin Dashboard CSS -->
    <link rel="stylesheet" th:href="@{/css/admin-dashboard.css}" />
  </head>
  <body>
    <!-- ===== NAVBAR ===== -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4 fixed-top">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" th:href="@{/admin/dashboard}">
          <!DOCTYPE html>
          <html xmlns:th="http://www.thymeleaf.org">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <title>Admin Dashboard</title>

              <!-- CSRF cho AJAX -->
              <meta name="_csrf" th:content="${_csrf.token}" />
              <meta name="_csrf_header" th:content="${_csrf.headerName}" />

              <!-- Google Font -->
              <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />
              <!-- Bootstrap CSS -->
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
              <!-- FontAwesome -->
              <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet" />
              <!-- Admin Dashboard CSS -->
              <link rel="stylesheet" th:href="@{/css/admin-dashboard.css}" />
            </head>
            <body>
              <!-- ===== NAVBAR ===== -->
              <nav class="navbar navbar-expand-lg navbar-dark mb-4 fixed-top">
                <div class="container">
                  <a class="navbar-brand d-flex align-items-center" th:href="@{/admin/dashboard}">
                    <i class="fas fa-gem me-2 text-light"></i>
                    ADMIN
                  </a>

                  <div class="ms-auto d-flex align-items-center gap-2">
                    <button id="sideNavToggle" class="btn btn-outline-light" title="Menu">
                      <i class="fas fa-bars"></i>
                    </button>
                    <a class="btn btn-outline-light" th:href="@{/}" title="Trang chủ">
                      <i class="fas fa-home"></i>
                    </a>
                    <form th:action="@{/logout}" method="post" class="d-inline">
                      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                      <button type="submit" class="btn btn-outline-light" title="Đăng xuất">
                        <i class="fas fa-sign-out-alt"></i>
                      </button>
                    </form>
                  </div>
                </div>
              </nav>

              <!-- Side Navigation -->
              <div id="sideNav" class="side-nav">
                <div class="side-nav-header">
                  <h5 class="mb-0">Menu</h5>
                  <button id="sideNavClose" class="btn btn-sm btn-light">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <nav class="side-nav-menu">
                  <a href="#orders" data-target="orders" class="side-nav-item">
                    <i class="fa-solid fa-box-open"></i>
                    <span>Đơn hàng</span>
                  </a>
                  <a th:href="@{/admin/returns}" class="side-nav-item">
                    <i class="fa-solid fa-rotate-left"></i>
                    <span>Quản lý trả hàng</span>
                  </a>
                  <a href="#reports" data-target="reports" class="side-nav-item">
                    <i class="fa-solid fa-chart-column"></i>
                    <span>Thống kê</span>
                  </a>
                  <a href="#products" data-target="products" class="side-nav-item">
                    <i class="fa-solid fa-cubes-stacked"></i>
                    <span>Sản phẩm</span>
                  </a>
                  <a href="#users" data-target="users" class="side-nav-item">
                    <i class="fa-solid fa-user-group"></i>
                    <span>Người dùng</span>
                  </a>
                  <a href="#discounts" data-target="discounts" class="side-nav-item">
                    <i class="fa-solid fa-ticket"></i>
                    <span>Mã giảm giá</span>
                  </a>
                  <a th:href="@{/admin/ann}" class="side-nav-item">
                    <i class="fa-solid fa-photo-film"></i>
                    <span>Thông báo ảnh</span>
                  </a>
                  <a th:href="@{/admin/reviews}" class="side-nav-item">
                    <i class="fa-solid fa-comments"></i>
                    <span>Đánh giá & bình luận</span>
                  </a>
                  <a th:href="@{/admin/chat}" class="side-nav-item">
                    <i class="fa-solid fa-comments"></i>
                    <span>Chat người dùng</span>
                  </a>
                  <a th:href="@{/admin/brands}" class="side-nav-item">
                    <i class="fa-solid fa-tags"></i>
                    <span>Quản lý Brand</span>
                  </a>
                </nav>
              </div>
    
                <!-- MENU -->
                <div class="row g-4 mb-5" id="menu">
                  <div class="col-md-3"><a href="#orders" data-target="orders" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-box-open"></i></div><h5>Đơn hàng</h5></a></div>
                  <div class="col-md-3"><a href="#reports" data-target="reports" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-chart-column"></i></div><h5>Thống kê</h5></a></div>
                  <div class="col-md-3"><a href="#products" data-target="products" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-cubes-stacked"></i></div><h5>Sản phẩm</h5></a></div>
                  <div class="col-md-3"><a href="#users" data-target="users" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-user-group"></i></div><h5>Người dùng</h5></a></div>
                  <div class="col-md-3"><a href="#discounts" data-target="discounts" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-ticket"></i></div><h5>Mã giảm giá</h5></a></div>
                  <div class="col-md-3"><a th:href="@{/admin/ann}" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-photo-film"></i></div><h5>Thông báo ảnh</h5></a></div>
                  <div class="col-md-3"><a th:href="@{/admin/reviews}" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-comments"></i></div><h5>Đánh giá</h5></a></div>
                  <div class="col-md-3"><a th:href="@{/admin/chat}" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-comments"></i></div><h5>Chat</h5></a></div>
                </div>
                <div class="kpi-card p-3">
                  <div class="d-flex align-items-center gap-3">
                    <div class="icon-wrapper"><i class="fas fa-truck-fast"></i></div>
                    <div>
                      <div class="label">Đã bán</div>
                      <div id="soldCount" class="value">0</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="kpi-card p-3">
                  <div class="d-flex align-items-center gap-3">
                    <div class="icon-wrapper"><i class="fas fa-users"></i></div>
                    <div>
                      <div class="label">Khách mới</div>
                      <div id="newCusCount" class="value">0</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- MENU -->
          <div class="row g-4 mb-5" id="menu">
            <div class="col-md-3"><a href="#orders" data-target="orders" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-box-open"></i></div><h5>Đơn hàng</h5></a></div>
            <div class="col-md-3"><a href="#reports" data-target="reports" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-chart-column"></i></div><h5>Thống kê</h5></a></div>
            <div class="col-md-3"><a href="#products" data-target="products" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-cubes-stacked"></i></div><h5>Sản phẩm</h5></a></div>
            <div class="col-md-3"><a href="#users" data-target="users" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-user-group"></i></div><h5>Người dùng</h5></a></div>
            <div class="col-md-3"><a href="#discounts" data-target="discounts" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-ticket"></i></div><h5>Mã giảm giá</h5></a></div>
            <div class="col-md-3"><a th:href="@{/admin/ann}" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-photo-film"></i></div><h5>Thông báo ảnh</h5></a></div>
            <div class="col-md-3"><a th:href="@{/admin/reviews}" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-comments"></i></div><h5>Đánh giá</h5></a></div>
            <div class="col-md-3"><a th:href="@{/admin/chat}" class="menu-card"><div class="menu-icon"><i class="fa-solid fa-comments"></i></div><h5>Chat</h5></a></div>
          </div>

          <!-- ORDERS -->
          <section id="orders" class="feature-section card mb-5">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Đơn hàng (Pending)</h5>
              <a class="btn btn-primary" th:href="@{/admin/orders}">
                <i class="fas fa-list-alt me-1"></i>Xem tất cả
              </a>
            </div>
            <div class="card-body p-0">
              <table class="table table-hover mb-0">
                <thead>
                  <tr><th>#</th><th>ID</th><th>Khách hàng</th><th class="text-end">Tổng tiền</th><th>Ngày tạo</th><th>Hành động</th></tr>
                </thead>
                <tbody id="pendingOrdersTbody">
                  <tr th:each="order, idx : ${orders}">
                    <td th:text="${idx.count}"></td>
                    <td th:text="${order.id}" class="fw-semibold text-primary"></td>
                    <td th:text="${order.customer != null ? order.customer.username : 'Khách'}">user</td>
                    <td class="text-end fw-semibold text-success" th:text="${#numbers.formatDecimal(order.total,0,'COMMA',2,'POINT')} + '₫'">0₫</td>
                    <td th:text="${#temporals.format(order.createdAt,'dd/MM/yyyy HH:mm')}">--/--/---- --:--</td>
                    <td class="text-center">
                      <form th:action="@{/admin/orders/{id}/status(id=${order.id})}" method="post" class="d-inline">
                        <input type="hidden" name="status" th:value="${T(com.ductieng.model.OrderStatus).CONFIRMED}"/>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-sm btn-success me-1 btn-confirm" th:attr="data-id=${order.id}"><i class="fas fa-check-circle me-1"></i> Xác nhận</button>
                      </form>
                    </td>
                  </tr>
                  <tr th:if="${#lists.isEmpty(orders)}">
                    <td colspan="6" class="text-center text-muted py-3">Chưa có đơn PENDING</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- REPORTS -->
          <section id="reports" class="feature-section mb-5">
            <div class="card mb-4">
              <div class="card-body">
                <form id="reportFilterForm" th:action="@{/admin/dashboard}" method="get" class="row g-3 align-items-end">
                  <div class="col-auto">
                    <label class="form-label">Loại</label>
                    <select name="type" class="form-select">
                      <option value="daily" th:selected="${type=='daily'}">Ngày</option>
                      <option value="monthly" th:selected="${type=='monthly'}">Tháng</option>
                    </select>
                  </div>
                  <div class="col-auto" th:style="${type != 'daily'} ? 'display: none;' : ''">
                    <label class="form-label">Từ ngày</label>
                    <input type="date" name="start" class="form-control" th:value="${start}" />
                  </div>
                  <div class="col-auto" th:style="${type != 'daily'} ? 'display: none;' : ''">
                    <label class="form-label">Đến ngày</label>
                    <input type="date" name="end" class="form-control" th:value="${end}" />
                  </div>
                  <div class="col-auto" th:style="${type == 'daily'} ? 'display: none;' : ''">
                    <label class="form-label">Từ tháng</label>
                    <input type="month" name="startMonth" class="form-control" th:value="${startMonth}" />
                  </div>
                  <div class="col-auto" th:style="${type == 'daily'} ? 'display: none;' : ''">
                    <label class="form-label">Đến tháng</label>
                    <input type="month" name="endMonth" class="form-control" th:value="${endMonth}" />
                  </div>
                  <div class="col-auto">
                    <button class="btn btn-primary"><i class="fas fa-filter me-1"></i>Lọc</button>
                    <a th:href="@{/admin/dashboard}" class="btn btn-outline-secondary"><i class="fas fa-undo me-1"></i>Đặt lại</a>
                  </div>
                </form>
              </div>
            </div>

            <div class="card">
              <div class="card-header"><i class="fas fa-table me-2"></i>Doanh thu chi tiết</div>
              <div class="table-responsive p-3">
                <table class="table table-striped mb-0">
                  <thead>
                    <tr>
                      <th th:text="${type=='daily'?'Ngày':'Tháng'}">Thời gian</th>
                      <th class="text-end">Doanh thu</th>
                    </tr>
                  </thead>
                  <tbody th:if="${type=='daily'}">
                    <th:block th:each="rd : ${revenueData}">
                      <tr>
                        <td>
                          <button class="btn btn-sm btn-outline-primary toggle-day" th:attr="data-day=${rd.period}">
                            <i class="fa fa-chevron-right me-1"></i>
                            <span th:text="${rd.period}">2025-08-23</span>
                          </button>
                        </td>
                        <td class="text-end" th:text="${#numbers.formatDecimal(rd.revenue,0,'COMMA',2,'POINT')} + '₫'">0₫</td>
                      </tr>
                      <tr class="detail-row d-none" th:attr="id=${'detail-' + rd.period}">
                        <td colspan="2">
                          <div class="p-3 small">
                            <span class="spinner-border spinner-border-sm me-2"></span>Đang tải...
                          </div>
                        </td>
                      </tr>
                    </th:block>
                    <tr th:if="${#lists.isEmpty(revenueData)}">
                      <td colspan="2" class="text-center text-muted py-3">Không có dữ liệu</td>
                    </tr>
                  </tbody>
                  <tbody th:if="${type!='daily'}">
                    <tr th:each="rd : ${revenueData}">
                      <td th:text="${rd.period}"></td>
                      <td class="text-end" th:text="${#numbers.formatDecimal(rd.revenue,0,'COMMA',2,'POINT')} + '₫'"></td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(revenueData)}">
                      <td colspan="2" class="text-center text-muted py-3">Không có dữ liệu</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- PRODUCTS (simplified for readability) -->
          <section id="products" class="card border-0 shadow-lg mb-5 rounded-4" style="background: linear-gradient(135deg, #5B21B6, #4F46E5); color: white;">
            <div class="card-header border-0 d-flex justify-content-between align-items-center px-4 py-3" style="background: rgba(255, 255, 255, 0.1); border-radius: 1rem 1rem 0 0;">
              <h4 class="mb-0 fw-bold"><i class="fas fa-box-open me-2"></i>Danh sách sản phẩm</h4>
              <a class="btn btn-light fw-semibold text-primary px-3 py-2 rounded-pill shadow-sm" th:href="@{/admin/product/new}">
                <i class="fas fa-plus-circle me-1"></i>Thêm mới
              </a>
            </div>
            <div class="card-body bg-white rounded-bottom-4 p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                  <thead style="background-color: #4F46E5; color: white;">
                    <tr>
                      <th class="ps-4">ID</th>
                      <th>Tên</th>
                      <th>Hãng</th>
                      <th>Giá</th>
                      <th>Số lượng</th>
                      <th class="text-center pe-4">Hành động</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="p : ${list}" class="table-row">
                      <td class="ps-4 fw-semibold text-dark" th:text="${p.id}"></td>
                      <td th:text="${p.name}" class="text-secondary"></td>
                      <td th:text="${p.brand}" class="text-secondary"></td>
                      <td th:text="${#numbers.formatDecimal(p.price,0,'COMMA',2,'POINT')}" class="text-success fw-semibold"></td>
                      <td th:text="${p.quantity}" class="text-secondary"></td>
                      <td class="text-center pe-4">
                        <a class="btn btn-sm btn-outline-primary me-1 rounded-pill px-3 py-1 fw-semibold" th:href="@{/admin/product/{id}/edit(id=${p.id})}"><i class="fas fa-edit me-1"></i>Sửa</a>
                        <form th:action="@{/admin/product/{id}/delete(id=${p.id})}" method="post" class="d-inline" onsubmit="return confirm('Xác nhận xóa sản phẩm này?');">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                          <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill px-3 py-1 fw-semibold"><i class="fas fa-trash-alt me-1"></i>Xóa</button>
                        </form>
                      </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(list)}">
                      <td colspan="6" class="text-center py-4 text-muted"><i class="fas fa-info-circle me-1"></i>Chưa có sản phẩm nào</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- USERS -->
          <section id="users" class="feature-section card mb-5">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-users me-2"></i>Người dùng</h5>
              <a class="btn btn-primary" th:href="@{/admin/user/new}"><i class="fas fa-user-plus me-1"></i>Thêm mới</a>
            </div>
            <div class="card-body p-0">
              <table class="table table-hover mb-0">
                <thead><tr><th>ID</th><th>Username</th><th>Role</th><th>Hành động</th></tr></thead>
                <tbody>
                  <tr th:each="u : ${users}">
                    <td th:text="${u.id}"></td>
                    <td th:text="${u.username}"></td>
                    <td th:text="${u.role}"></td>
                    <td>
                      <a class="btn btn-sm btn-warning me-1" th:href="@{/admin/user/{id}/edit(id=${u.id})}"><i class="fas fa-edit"></i></a>
                      <form th:action="@{/admin/user/{id}/delete(id=${u.id})}" method="post" class="d-inline" onsubmit="return confirm('Xác nhận xóa người dùng này?');">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash-alt"></i></button>
                      </form>
                    </td>
                  </tr>
                  <tr th:if="${#lists.isEmpty(users)}"><td colspan="4" class="text-center py-4">Chưa có người dùng</td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- DISCOUNTS -->
          <section id="discounts" class="feature-section card mb-5">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Mã giảm giá</h5>
              <div class="d-flex gap-2">
                <a class="btn btn-outline-light" th:href="@{/admin/discounts/new}"><i class="fas fa-plus-circle me-1"></i>Thêm mã</a>
                <a class="btn btn-primary" th:href="@{/admin/discounts}"><i class="fas fa-sliders-h me-1"></i>Quản lý</a>
              </div>
            </div>
            <div class="card-body">
              <div class="row g-3 align-items-center">
                <div class="col-md-8">
                  <p class="mb-2 text-muted">Tạo, chỉnh sửa và vô hiệu hóa mã giảm giá để chạy campaign nhanh.</p>
                  <div class="d-flex flex-wrap gap-2"><span class="badge bg-primary">OFF10</span><span class="badge bg-success">FREESHIP</span><span class="badge bg-warning text-dark">Học Sinh/Sinh Viên</span><span class="badge bg-info text-dark">NEWUSER</span></div>
                </div>
                <div class="col-md-4">
                  <div class="row text-center">
                    <div class="col-6"><div class="small text-muted">Đang hoạt động</div><div class="h5 mb-0" th:text="${activeDiscounts != null ? activeDiscounts : 0}">0</div></div>
                    <div class="col-6"><div class="small text-muted">Hết hạn/Vô hiệu</div><div class="h5 mb-0" th:text="${inactiveDiscounts != null ? inactiveDiscounts : 0}">0</div></div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- JS for dashboard interactions -->
        <script th:inline="javascript">
          const fmtVND = (n) => Number(n || 0).toLocaleString('vi-VN',{style:'currency',currency:'VND',maximumFractionDigits:0});
          document.querySelectorAll('.money').forEach(el=>{
            const v = el.getAttribute('data-vnd');
            if (v !== null) el.textContent = fmtVND(v);
          });

          const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
          const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

          // Load KPI
          async function loadMetrics(dateStr){
            try{
              const res = await fetch(`/admin/api/dashboard/metrics?date=${dateStr}`, { headers: csrfToken && csrfHeader ? { [csrfHeader]: csrfToken } : {} });
              const m = await res.json();
              document.getElementById('revDate') && (document.getElementById('revDate').textContent = m.dateLabel);
              document.getElementById('revValue') && (document.getElementById('revValue').textContent = fmtVND(m.revenue));
              document.getElementById('ordersCount') && (document.getElementById('ordersCount').textContent = m.ordersCount);
              document.getElementById('soldCount') && (document.getElementById('soldCount').textContent = m.soldItems);
              document.getElementById('cancelCount') && (document.getElementById('cancelCount').textContent = m.canceledOrders);
              document.getElementById('newCusCount') && (document.getElementById('newCusCount').textContent = m.newCustomers);
            }catch(e){console.error('loadMetrics error', e);}
          }

          // Toggle & hash logic + side nav
          (function () {
            const sectionIds = ["orders", "reports", "products", "users", "discounts"];
            const sections = Object.fromEntries(sectionIds.map(id => [id, document.getElementById(id)]));
            const cards = Array.from(document.querySelectorAll('.menu-card'));
            const sideToggle = document.getElementById('sideNavToggle');
            const sideNav = document.getElementById('sideNav');
            const sideClose = document.getElementById('sideNavClose');
            const overlay = document.getElementById('sideNavOverlay');

            sideToggle?.addEventListener('click', ()=> { sideNav.classList.toggle('open'); overlay.classList.toggle('active'); });
            sideClose?.addEventListener('click', ()=> { sideNav.classList.remove('open'); overlay.classList.remove('active'); });
            overlay?.addEventListener('click', ()=> { sideNav.classList.remove('open'); overlay.classList.remove('active'); });

            function showSection(id, {scroll=true} = {}){
              sectionIds.forEach(k=> sections[k]?.classList.remove('active'));
              cards.forEach(c => c.classList.remove('active'));
              if (sections[id]) { sections[id].classList.add('active'); const card = cards.find(c=> c.dataset.target===id); if (card) card.classList.add('active'); if (location.hash !== '#'+id) history.replaceState(null,'','#'+id); if (scroll) sections[id].scrollIntoView({behavior:'smooth', block:'start'}); }
            }

            cards.forEach(card=>{ card.addEventListener('click', function(e){ const href = this.getAttribute('href') || ''; if (href.startsWith('#')){ e.preventDefault(); const target = this.dataset.target || href.substring(1); showSection(target); } }); });

            function initFromHash(){ const target = location.hash?.replace('#',''); if (sectionIds.includes(target)) showSection(target, {scroll:false}); }
            window.addEventListener('hashchange', initFromHash); initFromHash();

            // Filter form handling
            const reportForm = document.getElementById('reportFilterForm');
            if (reportForm){ const typeSelect = reportForm.querySelector('select[name="type"]'); if (typeSelect){ typeSelect.addEventListener('change', function(){ const isDaily = this.value === 'daily'; reportForm.querySelectorAll('.col-auto').forEach(div => { const label = div.querySelector('label')?.textContent || ''; const hasDateInputs = label.includes('Từ ngày') || label.includes('Đến ngày'); const hasMonthInputs = label.includes('Từ tháng') || label.includes('Đến tháng'); if (hasDateInputs){ div.style.display = isDaily ? 'block' : 'none'; } else if (hasMonthInputs){ div.style.display = isDaily ? 'none' : 'block'; } }); }); typeSelect.dispatchEvent(new Event('change')); }
              reportForm.addEventListener('submit', function(e){ const base = reportForm.getAttribute('action') || window.location.pathname; const fd = new FormData(reportForm); const params = new URLSearchParams(fd).toString(); const url = base + (params ? ('?' + params) : '') + '#reports'; window.location.href = url; e.preventDefault(); return false; });
            }
          })();

          // Pending order interactions
          (function(){
            const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
            const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';
            const tbody = document.getElementById('pendingOrdersTbody');
            const badge = document.querySelector('[data-pending-count]');

            function refreshPendingBadge(){ if (!tbody || !badge) return 0; const count = tbody.querySelectorAll('tr:not(.placeholder-row)').length; badge.textContent = String(count); return count; }
            function renumber(){ if (!tbody) return; let i = 1; tbody.querySelectorAll('tr:not(.placeholder-row)').forEach(tr => { const firstCell = tr.querySelector('td'); if (firstCell) firstCell.textContent = i++; }); }
            function ensurePlaceholder(){ const hasRow = !!tbody.querySelector('tr:not(.placeholder-row)'); if (!hasRow){ tbody.innerHTML = `<tr class="placeholder-row"><td colspan="6" class="text-center text-muted">Chưa có đơn PENDING</td></tr>`; } }

            function bindConfirmButtons(scope){ (scope || document).querySelectorAll('.btn-confirm').forEach(btn => { if (btn.dataset.bound === '1') return; btn.dataset.bound = '1'; btn.addEventListener('click', async () =>{ const id = btn.getAttribute('data-id'); if (!id) return; if (!confirm('Xác nhận đơn này?')) return; try{ const res = await fetch(`/admin/orders/${id}/status`, { method:'POST', headers: { 'Content-Type':'application/x-www-form-urlencoded', [CSRF_HEADER]: CSRF_TOKEN }, body: new URLSearchParams({ status: 'CONFIRMED' }).toString() }); if (res.ok){ // remove row
                    const row = btn.closest('tr'); if (row) row.remove(); renumber(); refreshPendingBadge(); } else { alert('Xác nhận thất bại'); } } catch(e){ console.error('confirm error', e); alert('Lỗi mạng'); } }); }); }

            bindConfirmButtons(); ensurePlaceholder(); renumber(); refreshPendingBadge();
          })();
        </script>
      </body>
    </html>

        // Xử lý submit để giữ hash
        reportForm.addEventListener('submit', function (e) {
          const base = reportForm.getAttribute('action') || window.location.pathname;
          const fd = new FormData(reportForm);
          const params = new URLSearchParams(fd).toString();
          const url = base + (params ? ('?' + params) : '') + '#reports';
          window.location.href = url;
          e.preventDefault();
          return false;
        });

        const resetLink = reportForm.closest('.card-body')?.querySelector('a.btn.btn-outline-secondary');
        if (resetLink) {
          const href = resetLink.getAttribute('href') || '/admin/dashboard';
          resetLink.setAttribute('href', href + '#reports');
        }
      }

      // Về dashboard vẫn giữ tab hiện tại
      const keepHashLinks = document.querySelectorAll('a[href$="/admin/dashboard"], a[href$="dashboard"]');
      keepHashLinks.forEach(a => {
        a.addEventListener('click', function (e) {
          const hash = location.hash;
          if (hash) {
            e.preventDefault();
            window.location.href = this.getAttribute('href') + hash;
          }
        });
      });
    })();
  </script>

  <!-- AJAX xác nhận đơn trong khung nhỏ -->
<script>
(function (){
  const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
  const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';
  const tbody = document.getElementById('pendingOrdersTbody');
  const badge = document.querySelector('[data-pending-count]');

  // Đếm số dòng thực sự đang hiển thị (bỏ qua placeholder)
  function refreshPendingBadge() {
    if (!tbody || !badge) return 0;
    const count = tbody.querySelectorAll('tr:not(.placeholder-row)').length;
    badge.textContent = String(count);
    return count;
  }

  function renumber() {
    if (!tbody) return;
    let i = 1;
    tbody.querySelectorAll('tr:not(.placeholder-row)').forEach(tr => {
      const firstCell = tr.querySelector('td');
      if (firstCell) firstCell.textContent = i++;
    });
  }

  function ensurePlaceholder() {
    const hasRow = !!tbody.querySelector('tr:not(.placeholder-row)');
    if (!hasRow) {
      tbody.innerHTML = `
        <tr class="placeholder-row">
          <td colspan="6" class="text-center text-muted">Chưa có đơn PENDING</td>
        </tr>`;
    }
  }

  function bindConfirmButtons(scope) {
    (scope || document).querySelectorAll('.btn-confirm').forEach(btn => {
      if (btn.dataset.bound === '1') return;
      btn.dataset.bound = '1';

      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        if (!id) return;

        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang xử lý';

        try {
          const res = await fetch(`/admin/api/orders/${id}/status`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              [CSRF_HEADER]: CSRF_TOKEN,
              'Accept': 'application/json'
            },
            body: 'status=CONFIRMED'
          });

          const data = await res.json().catch(()=> ({}));
          if (!res.ok || data.ok !== true) {
            throw new Error(data.error || ('HTTP ' + res.status));
          }

          // Xoá đúng 1 dòng
          const row = document.getElementById(`row-${id}`);
          if (row) row.remove();

          // Cập nhật badge theo DOM hiện tại
          const count = refreshPendingBadge();
          if (count === 0) ensurePlaceholder();
          else renumber();

        } catch (e) {
          alert('Xác nhận thất bại: ' + (e.message || e));
          btn.disabled = false;
          btn.innerHTML = originalHTML;
        }
      });
    });
  }

  if (tbody) {
    bindConfirmButtons(tbody);
    // Lần đầu vào trang, đồng bộ lại badge theo DOM (phòng khi Thymeleaf render sai/khác)
    refreshPendingBadge();
  }
})();
</script>


  <!-- Chi tiết doanh thu theo ngày: bấm để bung ra ĐƠN + SẢN PHẨM -->
  <script>
    const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

    function renderDayDetail(data){
      let html = '';
      html += `<div class="fw-semibold mb-2">Đơn hàng (${data.orders.length}) — Doanh thu: ${fmtVND(data.revenue)}</div>`;
      html += `<div class="accordion" id="acc-${data.date}">`;

      data.orders.forEach((o, i) => {
        const cid = `acc-${data.date}-${i}`;
        html += `
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${cid}">
                ĐH #${o.id} — ${esc(o.customer)}${o.customerPhone ? ' — ' + esc(o.customerPhone) : ''} — Tổng: ${fmtVND(o.total)}
              </button>
            </h2>
            <div id="${cid}" class="accordion-collapse collapse">
              <div class="accordion-body p-0">
                ${
                  (o.discountCode || o.discountAmount || (o.discountPercent !== null && o.discountPercent !== undefined)) ? `
                  <div class="p-2 bg-light border-bottom small d-flex flex-wrap gap-2">
                    ${o.discountCode ? `<span class="badge bg-info text-dark">Mã giảm: ${esc(o.discountCode)}</span>` : ``}
                    ${o.discountAmount ? `<span class="badge bg-success">Giảm: ${fmtVND(o.discountAmount)}</span>` : ``}
                    ${(o.discountPercent !== null && o.discountPercent !== undefined)
                        ? `<span class="badge bg-secondary">${Number(o.discountPercent).toFixed(2)}%</span>` : ``}
                  </div>` : ``
                }
                ${ o.shippingAddress ? `
                  <div class="p-2 border-bottom small">
                    <i class="fa-solid fa-location-dot me-1"></i> <strong>Địa chỉ:</strong> ${esc(o.shippingAddress)}
                  </div>` : `` }

                <table class="table table-sm mb-0">
                  <thead>
                    <tr>
                      <th>Sản phẩm</th>
                      <th class="text-end">SL</th>
                      <th class="text-end">Đơn giá</th>
                      <th class="text-end">Thành tiền</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${o.items.map(it => `
                      <tr>
                        <td>${esc(it.productName)}</td>
                        <td class="text-end">${it.quantity}</td>
                        <td class="text-end">${fmtVND(it.unitPrice)}</td>
                        <td class="text-end">${fmtVND(it.lineTotal)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>`;
      });

      html += `</div>`;
      return html;
    }

    (function(){
      const rows = document.querySelectorAll('#reports .toggle-day');
      if (!rows.length) return;

      const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

      rows.forEach(btn => {
        btn.addEventListener('click', async () => {
          const day = btn.dataset.day;
          const detailRow = document.getElementById(`detail-${day}`);
          const icon = btn.querySelector('i');

          if (!detailRow.dataset.loaded) {
            try {
              const res = await fetch(`/admin/api/reports/day?date=${encodeURIComponent(day)}`, {
                headers: csrfHeader && csrfToken ? { [csrfHeader]: csrfToken } : {}
              });
              const data = await res.json();
              detailRow.querySelector('div').innerHTML = renderDayDetail(data);
              detailRow.dataset.loaded = '1';
            } catch (e) {
              detailRow.querySelector('div').innerHTML = `<span class="text-danger">Tải dữ liệu thất bại.</span>`;
            }
          }

          detailRow.classList.toggle('d-none');
          icon.classList.toggle('fa-chevron-right');
          icon.classList.toggle('fa-chevron-down');
        });
      });
    })();
  </script>

  <!-- Side Nav Toggle Script -->
  <script>
    (function() {
      const toggle = document.getElementById('sideNavToggle');
      const close = document.getElementById('sideNavClose');
      const sideNav = document.getElementById('sideNav');
      const overlay = document.getElementById('sideNavOverlay');
      const items = document.querySelectorAll('.side-nav-item');

      function openSideNav() {
        sideNav.classList.add('open');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeSideNav() {
        sideNav.classList.remove('open');
        overlay.classList.remove('active');
        document.body.style.overflow = 'auto';
      }

      toggle?.addEventListener('click', openSideNav);
      close?.addEventListener('click', closeSideNav);
      overlay?.addEventListener('click', closeSideNav);

      // Đóng khi click vào item (sau khi xử lý href)
      items.forEach(item => {
        item.addEventListener('click', () => {
          setTimeout(closeSideNav, 100);
        });
      });

      // Đóng khi nhấn ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeSideNav();
      });
    })();
  </script>

</body>
</html>
