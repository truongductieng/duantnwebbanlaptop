<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üî• Admin ‚Äì Qu·∫£n l√Ω ƒë∆°n h√†ng</title>

  <!-- CSRF cho AJAX -->
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />

  <!-- Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet"/>

  <style>
    body { font-family: 'Poppins', sans-serif; background: #f0f2f5; }
    .navbar { background: linear-gradient(90deg, #1d2671, #c33764) !important; }
    .card { border: none; border-radius: 1rem; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .card-header { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; font-weight: 500; }
    .btn-primary   { background: linear-gradient(135deg, #ff416c, #ff4b2b); border: none; }
    .btn-success   { background: linear-gradient(135deg, #28a745, #218838); border: none; }
    .btn-warning   { background: linear-gradient(135deg, #fbc531, #4cd137); border: none; }
    .btn-danger    { background: linear-gradient(135deg, #c0392b, #e74c3c); border: none; }
    .table thead th{ background: linear-gradient(135deg, #2980b9, #6dd5fa); color: #fff; border: none; }
    .table tbody tr:hover { background: rgba(0,0,0,0.03); }
    .badge { font-size:.9rem; }
    .spinner-inline { width: 1rem; height: 1rem; }
  </style>
</head>

<nav class="navbar navbar-expand-lg navbar-dark mb-4 fixed-top">
    <div class="container">
      <a class="navbar-brand" th:href="@{/admin/dashboard}">
        <i class="fas fa-gem me-2"></i>ADMIN MANAGER
      </a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <a class="btn btn-outline-light" th:href="@{/}"><i class="fas fa-home"></i></a>
        <form th:action="@{/logout}" method="post" class="d-inline">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
          <button type="submit" class="btn btn-outline-light" title="Logout">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </form>
      </div>
    </div>
  </nav>

<body class="bg-light">
  <div class="container py-5">

    <a th:href="${backUrl}" class="btn btn-secondary mb-3">‚Üê Quay l·∫°i</a>
    <h2 class="mb-4">Qu·∫£n l√Ω ƒë∆°n h√†ng</h2>

    <div id="ajaxAlert" class="alert d-none" role="alert"></div>

    <!-- B·ªô l·ªçc tr·∫°ng th√°i + T√¨m theo ID -->
    <form class="row g-3 mb-4 align-items-end" th:action="@{/admin/orders}" method="get" id="filterForm">
      <div class="col-auto">
        <label for="statusFilter" class="col-form-label">Tr·∫°ng th√°i:</label>
      </div>
      <div class="col-auto">
        <select id="statusFilter" name="status" class="form-select">
          <option th:each="s : ${allStatuses}"
                  th:value="${s}"
                  th:selected="${s == selectedStatus}"
                  th:text="${s.label}">
          </option>
        </select>
      </div>

      <div class="col-auto">
        <label for="orderIdInput" class="col-form-label">T√¨m ID:</label>
      </div>
      <div class="col-auto">
        <input id="orderIdInput" class="form-control" type="number" name="orderId"
               placeholder="VD: 1024" th:value="${searchOrderId}">
      </div>

      <div class="col-auto">
        <button class="btn btn-primary"><i class="fa fa-filter me-1"></i> √Åp d·ª•ng</button>
      </div>
      <div class="col-auto" th:if="${searchOrderId != null}">
        <a th:href="@{/admin/orders}" class="btn btn-outline-secondary">X√≥a t√¨m ID</a>
      </div>
    </form>

    <!-- Alert khi kh√¥ng t√¨m th·∫•y ID -->
    <div th:if="${notFound}" class="alert alert-warning mb-4">
      Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng v·ªõi ID <strong th:text="${searchOrderId}"></strong>.
    </div>

    <div class="card">
      <div class="card-header">
        <span th:if="${searchOrderId != null}">
          ƒê∆°n h√†ng #<span th:text="${searchOrderId}">?</span>
        </span>
        <span th:if="${searchOrderId == null}">
          Danh s√°ch ƒë∆°n
          <span class="text-white-50"
                th:text="${selectedStatus != null ? selectedStatus.label : 'PENDING'}">PENDING</span>
        </span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle mb-0" id="ordersTable">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Kh√°ch h√†ng</th>
                <th>Ng√†y t·∫°o</th>
                <th>T·ªïng ti·ªÅn</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="ordersTbody">
              <tr th:each="o : ${orders}" th:attr="data-id=${o.id}">
                <td th:text="${o.id}">1</td>
                <td>
                  <a th:href="@{/admin/orders/user/{uid}(uid=${o.customer.id})}"
                     th:text="${o.customer != null ? o.customer.username : 'Kh√°ch'}">t√™n kh√°ch</a>
                </td>
                <td th:text="${#temporals.format(o.createdAt, 'dd/MM/yyyy HH:mm')}">16/07/2025 20:30</td>
                <td th:text="${#numbers.formatDecimal(o.total,0,'COMMA',2,'POINT')} + '‚Ç´'">10.000.000‚Ç´</td>

                <td>
                  <span class="status-badge"
                        th:data-status="${o.status}"
                        th:class="${o.status == T(com.bigkhoa.model.OrderStatus).PENDING ? 'badge bg-warning text-dark'
                                  : o.status == T(com.bigkhoa.model.OrderStatus).CONFIRMED ? 'badge bg-info'
                                  : o.status == T(com.bigkhoa.model.OrderStatus).SHIPPED ? 'badge bg-primary'
                                  : o.status == T(com.bigkhoa.model.OrderStatus).DELIVERED ? 'badge bg-success'
                                  : o.status == T(com.bigkhoa.model.OrderStatus).COMPLETED ? 'badge bg-success'
                                  : o.status == T(com.bigkhoa.model.OrderStatus).CANCELED ? 'badge bg-danger'
                                  : 'badge bg-secondary'}"
                        th:text="${o.status == T(com.bigkhoa.model.OrderStatus).PENDING ? 'ƒêang ch·ªù'
                                  : o.status == T(com.bigkhoa.model.OrderStatus).CONFIRMED ? 'ƒê√£ x√°c nh·∫≠n'
                                  : o.status == T(com.bigkhoa.model.OrderStatus).SHIPPED ? 'ƒêang giao h√†ng'
                                  : o.status == T(com.bigkhoa.model.OrderStatus).DELIVERED ? 'ƒê√£ giao h√†ng'
                                  : o.status == T(com.bigkhoa.model.OrderStatus).COMPLETED ? 'Ho√†n t·∫•t'
                                  : o.status == T(com.bigkhoa.model.OrderStatus).CANCELED ? 'ƒê√£ h·ªßy'
                                  : 'Kh√¥ng x√°c ƒë·ªãnh'}">
                  </span>

                  <i th:if="${o.status == T(com.bigkhoa.model.OrderStatus).CANCELED}"
                     class="fa fa-circle-info text-muted ms-1"
                     th:title="|H·ªßy l√∫c: ${o.canceledAt != null ? #temporals.format(o.canceledAt,'dd/MM/yyyy HH:mm') : '-'} ‚Ä¢ L√Ω do: ${o.cancelReason != null ? o.cancelReason : '-'}|">
                  </i>
                </td>

                <td>
                  <div class="btn-group" role="group">
                    <a th:href="@{|/admin/orders/${o.id}|}" class="btn btn-sm btn-outline-primary me-1">Chi ti·∫øt</a>

                    <button th:if="${o.status == T(com.bigkhoa.model.OrderStatus).PENDING}"
                            class="btn btn-sm btn-outline-success me-1 btn-status"
                            data-next="CONFIRMED">X√°c nh·∫≠n</button>

                    <button th:if="${o.status == T(com.bigkhoa.model.OrderStatus).CONFIRMED}"
                            class="btn btn-sm btn-outline-primary me-1 btn-status"
                            data-next="SHIPPED">Giao h√†ng</button>

                    <!-- ƒê·ªïi n√∫t: SHIPPED -> DELIVERED (ƒê√£ giao) -->
                    <button th:if="${o.status == T(com.bigkhoa.model.OrderStatus).SHIPPED}"
                            class="btn btn-sm btn-outline-dark me-1 btn-status"
                            data-next="DELIVERED">ƒê√£ giao</button>

                    <button th:if="${o.status == T(com.bigkhoa.model.OrderStatus).PENDING
                                    or o.status == T(com.bigkhoa.model.OrderStatus).CONFIRMED}"
                            class="btn btn-sm btn-danger ms-1"
                            data-bs-toggle="modal" data-bs-target="#adminCancelModal"
                            th:attr="data-orderid=${o.id}">
                      <i class="fa fa-ban"></i> H·ªßy
                    </button>

                    <button th:if="${o.status == T(com.bigkhoa.model.OrderStatus).CANCELED}"
                            class="btn btn-sm btn-outline-danger btn-delete">X√≥a</button>
                  </div>

                  <!-- ·∫®n select n·∫øu CANCELED ho·∫∑c COMPLETED -->
                  <div th:if="${o.status != T(com.bigkhoa.model.OrderStatus).CANCELED
                               and o.status != T(com.bigkhoa.model.OrderStatus).COMPLETED}" class="mt-2">
                    <select class="form-select form-select-sm select-status">
                      <option th:each="s : ${allStatuses}"
                              th:value="${s}"
                              th:selected="${s == o.status}"
                              th:text="${s.label}">
                      </option>
                    </select>
                  </div>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(orders)}">
                <td colspan="6" class="text-center text-muted py-4">Kh√¥ng c√≥ ƒë∆°n ph√π h·ª£p.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal H·ªßy ƒë∆°n (ADMIN) -->
  <div class="modal fade" id="adminCancelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="adminCancelForm" method="post">
          <div class="modal-header">
            <h5 class="modal-title">H·ªßy ƒë∆°n #<span id="adminCancelOrderIdText">?</span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">L√Ω do h·ªßy</label>
              <textarea name="reason" class="form-control" rows="3"
                        placeholder="VD: Kh√°ch y√™u c·∫ßu, thanh to√°n kh√¥ng th√†nh c√¥ng‚Ä¶"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button type="submit" class="btn btn-danger">X√°c nh·∫≠n h·ªßy</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
(() => {
  // ===== CSRF & DOM =====
  const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content || '';
  const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';
  const $tbody = document.getElementById('ordersTbody');

  // ===== UI helpers =====
  const STATUS_TEXT = {
    PENDING:   'ƒêang ch·ªù',
    CONFIRMED: 'ƒê√£ x√°c nh·∫≠n',
    SHIPPED:   'ƒêang giao h√†ng',
    DELIVERED: 'ƒê√£ giao h√†ng',
    COMPLETED: 'Ho√†n t·∫•t', // v·∫´n gi·ªØ ƒë·ªÉ hi·ªÉn th·ªã l·ªãch s·ª≠
    CANCELED:  'ƒê√£ h·ªßy'
  };
  const STATUS_CLASS = {
    PENDING:   'badge bg-warning text-dark',
    CONFIRMED: 'badge bg-info',
    SHIPPED:   'badge bg-primary',
    DELIVERED: 'badge bg-success',
    COMPLETED: 'badge bg-success',
    CANCELED:  'badge bg-danger'
  };

  function showAlert(type, msg){
    const box = document.getElementById('ajaxAlert');
    if (!box) { if (type === 'danger') alert(msg); return; }
    box.className = 'alert alert-' + (type === 'danger' ? 'danger' : 'success');
    box.textContent = msg;
    box.classList.remove('d-none');
    setTimeout(()=> box.classList.add('d-none'), 2800);
  }

  function getSelectedStatus(){
    const q = new URLSearchParams(location.search);
    // N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô t√¨m theo ID ‚Üí kh√¥ng t·ª± lo·∫°i d√≤ng khi ƒë·ªïi tr·∫°ng th√°i
    if (q.get('orderId')) return '';
    const sel = document.getElementById('statusFilter');
    if (sel && sel.value) return sel.value.trim();
    return (q.get('status') || '').trim();
  }

  async function postStatus(id, next){
    const res = await fetch(`/admin/api/orders/${id}/status`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded', [CSRF_HEADER]: CSRF_TOKEN },
      body: 'status=' + encodeURIComponent(next)
    });
    const data = await res.json().catch(()=>({}));
    if (!res.ok || data.ok === false) throw new Error(data.error || ('HTTP '+res.status));
    return data.newStatus || next;
  }

  // ===== Update 1 d√≤ng sau khi server OK =====
  function updateRowUI(tr, newStatus){
    // 1) Badge tr·∫°ng th√°i
    const badge = tr.querySelector('.status-badge');
    if (badge){
      badge.textContent = STATUS_TEXT[newStatus] || newStatus;
      badge.className = 'status-badge ' + (STATUS_CLASS[newStatus] || 'badge bg-secondary');
      badge.dataset.status = newStatus;
    }

    // 2) L√†m l·∫°i c√°c n√∫t h√†nh ƒë·ªông theo tr·∫°ng th√°i m·ªõi
    tr.querySelectorAll('.btn-status').forEach(b => b.remove());
    const actions = tr.querySelector('.btn-group');

    if (actions){
      if (newStatus === 'CONFIRMED'){
        actions.insertAdjacentHTML('beforeend',
          `<button class="btn btn-sm btn-outline-primary me-1 btn-status" data-next="SHIPPED">Giao h√†ng</button>`);
      } else if (newStatus === 'SHIPPED'){
        actions.insertAdjacentHTML('beforeend',
          `<button class="btn btn-sm btn-outline-dark me-1 btn-status" data-next="DELIVERED">ƒê√£ giao</button>`);
      }
      // KH√îNG t·∫°o n√∫t DELIVERED ‚Üí COMPLETED n·ªØa

      // N·∫øu ƒë√£ h·ªßy / ho√†n t·∫•t: ·∫©n select, ·∫©n n√∫t h·ªßy, th√™m n√∫t x√≥a (n·∫øu ch∆∞a c√≥)
      if (newStatus === 'CANCELED' || newStatus === 'COMPLETED'){
        tr.querySelector('.select-status')?.closest('div')?.remove();
        tr.querySelector('[data-bs-target="#adminCancelModal"]')?.remove();
        if (!actions.querySelector('.btn-delete')){
          actions.insertAdjacentHTML('beforeend',
            `<button class="btn btn-sm btn-outline-danger btn-delete">X√≥a</button>`);
        }
      }
    }

    // 3) ƒê·ªìng b·ªô dropdown
    const sel = tr.querySelector('.select-status');
    if (sel) sel.value = newStatus;

    // 4) N·∫øu ƒëang l·ªçc theo 1 tr·∫°ng th√°i kh√°c ‚Üí x√≥a d√≤ng ngay
    const filter = getSelectedStatus();
    if (filter && filter !== newStatus){
      tr.remove();
    } else {
      // g·∫Øn l·∫°i event cho c√°c n√∫t m·ªõi t·∫°o
      bindRow(tr);
    }
  }

  // ===== G·∫Øn s·ª± ki·ªán cho 1 d√≤ng =====
  function bindRow(tr){
    // N√∫t chuy·ªÉn tr·∫°ng th√°i
    tr.querySelectorAll('.btn-status').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id   = tr.dataset.id;
        const next = btn.getAttribute('data-next');
        const old  = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        try{
          const newStatus = await postStatus(id, next);
          updateRowUI(tr, newStatus);
          showAlert('success', `ƒê√£ c·∫≠p nh·∫≠t ƒë∆°n #${id} ‚Üí ${STATUS_TEXT[newStatus] || newStatus}`);
        }catch(e){
          showAlert('danger', `C·∫≠p nh·∫≠t th·∫•t b·∫°i: ${e.message}`);
        }finally{
          if (document.body.contains(btn)) { btn.disabled = false; btn.innerHTML = old; }
        }
      });
    });

    // Dropdown ƒë·ªïi tr·∫°ng th√°i
    const sel = tr.querySelector('.select-status');
    if (sel){
      sel.addEventListener('change', async ()=>{
        const id = tr.dataset.id;
        const next = sel.value;
        sel.disabled = true;
        try{
          const newStatus = await postStatus(id, next);
          updateRowUI(tr, newStatus);
          showAlert('success', `ƒê√£ c·∫≠p nh·∫≠t ƒë∆°n #${id} ‚Üí ${STATUS_TEXT[newStatus] || newStatus}`);
        }catch(e){
          showAlert('danger', `C·∫≠p nh·∫≠t th·∫•t b·∫°i: ${e.message}`);
          const cur = tr.querySelector('.status-badge')?.dataset.status || '';
          if (cur) sel.value = cur;
        }finally{
          if (document.body.contains(sel)) sel.disabled = false;
        }
      });
    }

    // X√≥a ƒë∆°n
    const btnDelete = tr.querySelector('.btn-delete');
    if (btnDelete){
      btnDelete.addEventListener('click', async ()=>{
        const id = tr.dataset.id;
        if (!confirm(`X√≥a ƒë∆°n #${id}?`)) return;
        btnDelete.disabled = true;
        try{
          const res = await fetch(`/admin/orders/${id}/delete`, {
            method: 'POST', headers: { [CSRF_HEADER]: CSRF_TOKEN }
          });
          if (res.status >= 200 && res.status < 400){
            tr.remove();
            showAlert('success', `ƒê√£ x√≥a ƒë∆°n #${id}`);
          } else {
            throw new Error('HTTP ' + res.status);
          }
        }catch(e){
          showAlert('danger', `X√≥a th·∫•t b·∫°i: ${e.message}`);
          btnDelete.disabled = false;
        }
      });
    }
  }

  // G·∫Øn s·ª± ki·ªán cho t·∫•t c·∫£ d√≤ng c√≥ s·∫µn
  $tbody.querySelectorAll('tr[data-id]').forEach(bindRow);

  // ===== Modal H·ªßy (ADMIN) d√πng API JSON =====
  const adminCancelModal = document.getElementById('adminCancelModal');
  const adminCancelForm  = document.getElementById('adminCancelForm');
  const adminCancelOrderIdText = document.getElementById('adminCancelOrderIdText');
  let cancelOrderId = null;

  adminCancelModal?.addEventListener('show.bs.modal', (ev)=>{
    const btn = ev.relatedTarget;
    cancelOrderId = btn?.getAttribute('data-orderid') || null;
    if (adminCancelOrderIdText) adminCancelOrderIdText.textContent = cancelOrderId || '?';
  });

  adminCancelForm?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = cancelOrderId; if (!id) return;
    const fd = new FormData(adminCancelForm);
    const reason = (fd.get('reason') || '').toString();

    const submitBtn = adminCancelForm.querySelector('button[type="submit"]');
    const old = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try{
      const res = await fetch(`/admin/api/orders/${id}/cancel`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', [CSRF_HEADER]: CSRF_TOKEN },
        body: 'reason=' + encodeURIComponent(reason)
      });
      const data = await res.json().catch(()=>({}));
      if (!res.ok || data.ok === false) throw new Error(data.error || ('HTTP '+res.status));

      const tr = $tbody.querySelector(`tr[data-id="${id}"]`);
      if (tr) updateRowUI(tr, 'CANCELED');

      const modal = bootstrap.Modal.getInstance(adminCancelModal);
      modal?.hide();
      adminCancelForm.reset();
      showAlert('success', `ƒê√£ h·ªßy ƒë∆°n #${id}`);
    }catch(e){
      showAlert('danger', `H·ªßy th·∫•t b·∫°i: ${e.message}`);
    }finally{
      submitBtn.disabled = false;
      submitBtn.innerHTML = old;
    }
  });
})();
</script>

</body>

<footer th:fragment="admin-footer">
  <div class="container text-center py-4 border-top mt-5">
    <p class="mb-1">&copy; <span th:text="${T(java.time.Year).now()}">2025</span> ADMIN MANAGER </p>
    <p class="text-muted small">H·ªá th·ªëng qu·∫£n tr·ªã d√†nh cho qu·∫£n l√Ω s·∫£n ph·∫©m, ƒë∆°n h√†ng v√† ng∆∞·ªùi d√πng.</p>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</footer>
</html>
