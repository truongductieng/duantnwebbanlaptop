<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title th:text="${product.id == null ? 'Thêm sản phẩm mới' : 'Chỉnh sửa sản phẩm'}">Quản lý sản phẩm</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet"/>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet"/>

  <style>
    :root {
      --primary: #4F46E5;
      --primary-dark: #4338CA;
      --secondary: #6B7280;
      --success: #059669;
      --danger: #DC2626;
      --warning: #F59E0B;
      --info: #3B82F6;
      --light: #F3F4F6;
      --dark: #111827;
      --background: #F9FAFB;
      --border: #E5E7EB;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --radius: 1rem;
      --transition: all 0.3s ease;
    }

    body { 
      font-family: 'Poppins', sans-serif; 
      background: var(--background);
      color: var(--dark);
      padding-top: 60px;
    }

    /* Navbar */
    .navbar {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark)) !important;
      box-shadow: var(--shadow);
    }

    .navbar-brand {
      font-weight: 700;
      letter-spacing: 1px;
    }

    .navbar .btn {
      transition: var(--transition);
    }

    .navbar .btn:hover {
      transform: translateY(-2px);
    }

    /* Card */
    .card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .card-header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      font-weight: 500;
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);
      border-bottom: none;
    }

    /* Forms */
    .form-control, .form-select {
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.625rem 1rem;
      transition: var(--transition);
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-label {
      font-weight: 500;
      color: var(--dark);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Buttons */
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: var(--transition);
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border: none;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--secondary);
      border: none;
    }

    .btn-outline-primary {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-outline-primary:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
    }

    /* Images */
    .img-preview {
      width: 100%;
      max-width: 140px;
      height: 140px;
      margin-top: 0.75rem;
      border-radius: 0.75rem;
      object-fit: cover;
      border: 2px solid var(--border);
      background: white;
      padding: 0.25rem;
      transition: var(--transition);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .img-preview:hover {
      transform: scale(1.05);
      border-color: var(--primary);
    }

    /* Configuration Panel */
    .cfg-panel {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      transition: var(--transition);
    }

    .cfg-panel:hover {
      border-color: var(--primary);
    }

    .cfg-header {
      background: var(--light);
      padding: 1rem;
      border-radius: var(--radius) var(--radius) 0 0;
      font-weight: 500;
    }

    /* Features */
    .featured-flag {
      font-size: 0.875rem;
      color: var(--secondary);
      transition: var(--transition);
    }

    .featured-flag:hover {
      color: var(--primary);
    }

    .form-check-input:checked {
      background-color: var(--primary);
      border-color: var(--primary);
    }

    /* Alerts */
    .alert {
      border: none;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .alert-success {
      background: #ECFDF5;
      color: var(--success);
    }

    .alert-danger {
      background: #FEE2E2;
      color: var(--danger);
    }

    /* Animations */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      animation: slideIn 0.3s ease;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .card {
        border-radius: 0.75rem;
      }

      .btn {
        width: 100%;
        margin-bottom: 0.5rem;
      }

      .d-flex {
        flex-direction: column;
      }

      .img-preview {
        max-width: 100%;
        height: 200px;
      }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark mb-4 fixed-top">
    <div class="container">
      <a class="navbar-brand" th:href="@{/admin/dashboard}">
        <i class="fas fa-gem me-2"></i>ADMIN MANAGER
      </a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <a class="btn btn-outline-light" th:href="@{/}"><i class="fas fa-home"></i></a>
        <form th:action="@{/logout}" method="post" class="d-inline">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
          <button type="submit" class="btn btn-outline-light" title="Logout">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </form>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a th:href="@{/admin/dashboard}" class="text-decoration-none">
            <i class="fas fa-home"></i>
            <span class="ms-1">Trang chủ</span>
          </a>
        </li>
        <li class="breadcrumb-item">
          <a th:href="@{/admin/products}" class="text-decoration-none">Sản phẩm</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page" 
            th:text="${product.id == null ? 'Thêm mới' : 'Chỉnh sửa'}">
          Form
        </li>
      </ol>
    </nav>

    <div class="card mx-auto" style="max-width: 820px;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <div class="rounded-circle bg-white p-2 me-3">
            <i class="fas fa-box-open text-primary"></i>
          </div>
          <h5 class="mb-0" th:text="${product.id == null ? 'Thêm sản phẩm mới' : 'Chỉnh sửa sản phẩm'}">
            Form sản phẩm
          </h5>
        </div>
        <a th:href="@{/admin/dashboard}" class="btn btn-outline-light btn-sm">
          <i class="fas fa-times me-1"></i>
          Đóng
        </a>
      </div>

      <div class="card-body">
        <!-- Progress Bar -->
        <div class="progress mb-4" style="height: 4px;">
          <div class="progress-bar bg-primary" role="progressbar" style="width: 0%;" id="formProgress"></div>
        </div>

        <!-- FLASH MESSAGES -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show mb-4" role="alert">
          <div class="d-flex">
            <div class="me-3">
              <i class="fas fa-check-circle fa-2x"></i>
            </div>
            <div>
              <h6 class="alert-heading mb-1">Thành công!</h6>
              <span th:text="${success}">Thao tác thành công</span>
            </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
          <div class="d-flex">
            <div class="me-3">
              <i class="fas fa-exclamation-triangle fa-2x"></i>
            </div>
            <div>
              <h6 class="alert-heading mb-1">Đã xảy ra lỗi!</h6>
              <span th:text="${error}">Chi tiết lỗi</span>
            </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <!-- /FLASH MESSAGES -->

        <form th:action="@{/admin/product/save}"
              th:object="${product}"
              method="post"
              enctype="multipart/form-data"
              onsubmit="return confirm('Bạn có chắc chắn muốn lưu sản phẩm này không?');">

          <!-- CSRF -->
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

          <!-- Nếu edit, gửi kèm ID -->
          <input type="hidden" th:if="${product.id != null}" th:field="*{id}"/>

          <!-- Thông tin cơ bản -->
          <div class="card bg-light border mb-4">
            <div class="card-header bg-transparent border-bottom">
              <h6 class="mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Thông tin cơ bản
              </h6>
            </div>
            <div class="card-body">
              <div class="row g-4">
                <div class="col-md-6">
                  <div class="form-floating mb-3">
                    <input type="text" class="form-control" th:field="*{name}" 
                           placeholder="Nhập tên sản phẩm" required
                           id="productName"/>
                    <label for="productName">
                      <i class="fas fa-laptop me-2"></i>
                      Tên sản phẩm
                    </label>
                    <div th:if="${#fields.hasErrors('name')}" 
                         class="invalid-feedback d-block mt-1" th:errors="*{name}">
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="brandName" class="form-label">
                      <i class="fas fa-building me-2"></i>
                      Hãng sản xuất
                    </label>
                    <select class="form-select" th:field="*{brand}" id="brandName" required>
                      <option value="">-- Chọn hãng sản xuất --</option>
                      <option th:each="brandObj : ${brands}" 
                              th:value="${brandObj.name}" 
                              th:text="${brandObj.name}">
                        Brand
                      </option>
                    </select>
                    <div th:if="${#fields.hasErrors('brand')}" 
                         class="invalid-feedback d-block mt-1" th:errors="*{brand}">
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="form-floating mb-3">
                    <input type="number" step="0.01" min="0" class="form-control" 
                           th:field="*{price}" placeholder="Nhập giá" required
                           id="productPrice"/>
                    <label for="productPrice">
                      <i class="fas fa-tag me-2"></i>
                      Giá bán
                    </label>
                    <div th:if="${#fields.hasErrors('price')}" 
                         class="invalid-feedback d-block mt-1" th:errors="*{price}">
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="form-floating mb-3">
                    <input type="number" min="0" class="form-control" 
                           th:field="*{quantity}" placeholder="Nhập tồn kho" required
                           id="productQuantity"/>
                    <label for="productQuantity">
                      <i class="fas fa-boxes me-2"></i>
                      Số lượng tồn
                    </label>
                    <div th:if="${#fields.hasErrors('quantity')}" 
                         class="invalid-feedback d-block mt-1" th:errors="*{quantity}">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Phân loại sản phẩm -->
          <div class="card bg-light border mb-4">
            <div class="card-header bg-transparent border-bottom">
              <h6 class="mb-0">
                <i class="fas fa-tags me-2"></i>
                Phân loại sản phẩm
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-floating mb-3">
                    <!-- Dùng danh sách từ controller nếu có -->
                    <th:block th:if="${categories != null and !#lists.isEmpty(categories)}">
                      <select id="category" class="form-select" th:field="*{category.id}" required>
                        <option value="" disabled th:selected="${product.category == null}">
                          -- Chọn danh mục --
                        </option>
                        <option th:each="c : ${categories}"
                                th:value="${c.id}"
                                th:text="${c.name}">
                        </option>
                      </select>
                    </th:block>

                    <!-- Fallback: 3 danh mục cố định -->
                    <th:block th:unless="${categories != null and !#lists.isEmpty(categories)}">
                      <select id="category" class="form-select" th:field="*{category.id}" required>
                        <option value="" disabled th:selected="${product.category == null}">
                          -- Chọn danh mục --
                        </option>
                        <option value="1">Laptop văn phòng</option>
                        <option value="2">Laptop gaming</option>
                        <option value="3">Laptop sinh viên</option>
                      </select>
                    </th:block>
                    <label for="category">
                      <i class="fas fa-folder me-2"></i>
                      Danh mục sản phẩm
                    </label>
                    <div th:if="${#fields.hasErrors('category')}" 
                         class="invalid-feedback d-block mt-1" th:errors="*{category}">
                    </div>
                    <div th:if="${#fields.hasErrors('category.id')}" 
                         class="invalid-feedback d-block mt-1" th:errors="*{category.id}">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Cấu hình sản phẩm -->
          <div class="card bg-light border mb-4">
            <div class="card-header bg-transparent border-bottom">
              <h6 class="mb-0">
                <i class="fas fa-microchip me-2"></i>
                Cấu hình sản phẩm
              </h6>
            </div>
            <div class="card-body">
              <div class="form-floating mb-3">
                <textarea class="form-control" th:field="*{configuration}" rows="2" id="configText"
                         style="min-height: 100px"
                         placeholder="Intel Core i5-1135G7, 8GB RAM, 512GB SSD, 13.3&quot; FHD, Windows 11 ...">
                </textarea>
                <label for="configText">
                  <i class="fas fa-cog me-2"></i>
                  Cấu hình tổng hợp
                </label>
                <div class="form-text mt-2">
                  <i class="fas fa-info-circle me-1"></i>
                  Nhập tay hoặc sử dụng công cụ tạo cấu hình bên dưới
                </div>
              </div>

              <!-- Công cụ tạo cấu hình -->
              <div class="cfg-panel">
                <div class="cfg-header d-flex align-items-center justify-content-between" 
                     data-bs-toggle="collapse" data-bs-target="#cfgCollapse" 
                     style="cursor: pointer;">
                  <div>
                    <i class="fas fa-tools me-2"></i>
                    Công cụ tạo cấu hình
                  </div>
                  <i class="fas fa-chevron-down"></i>
                </div>
              <div id="cfgCollapse" class="collapse">
                <div class="p-3">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <div class="form-floating">
                        <select class="form-select cfg-select" data-label="" id="cpuSelect">
                          <option value="">-- Chọn CPU --</option>
                          <option>Intel Core i5-1240P</option>
                          <option>Intel Core i7-1360P</option>
                          <option>Intel Core Ultra 5 125H</option>
                          <option>AMD Ryzen 5 7640U</option>
                          <option>AMD Ryzen 7 7840U</option>
                        </select>
                        <label for="cpuSelect">
                          <i class="fas fa-microchip me-2"></i>
                          CPU
                        </label>
                      </div>
                    </div>

                    <div class="col-md-4">
                      <div class="form-floating">
                        <select class="form-select cfg-select" data-label="RAM" id="ramSelect">
                          <option value="">-- Chọn RAM --</option>
                          <option>8GB DDR4 3200MHz</option>
                          <option>16GB DDR5 4800MHz</option>
                          <option>16GB DDR5 5200MHz</option>
                          <option>32GB DDR5 5600MHz</option>
                        </select>
                        <label for="ramSelect">
                          <i class="fas fa-memory me-2"></i>
                          RAM
                        </label>
                      </div>
                    </div>

                    <div class="col-md-4">
                      <div class="form-floating">
                        <select class="form-select cfg-select" data-label="" id="storageSelect">
                          <option value="">-- Chọn ổ lưu trữ --</option>
                          <option>512GB NVMe</option>
                          <option>1TB NVMe</option>
                          <option>512GB NVMe / 1TB SSD</option>
                        </select>
                        <label for="storageSelect">
                          <i class="fas fa-hdd me-2"></i>
                          Lưu trữ
                        </label>
                      </div>
                    </div>

                    <div class="col-md-4">
                      <div class="form-floating">
                        <select class="form-select cfg-select" data-label="" id="gpuSelect">
                          <option value="">-- Chọn GPU --</option>
                          <option>iGPU</option>
                          <option>RTX 3050 6GB</option>
                          <option>RTX 4050 6GB</option>
                          <option>RTX 4060 8GB</option>
                        </select>
                        <label for="gpuSelect">
                          <i class="fas fa-desktop me-2"></i>
                          GPU
                        </label>
                      </div>
                    </div>

                    <div class="col-md-4">
                      <div class="form-floating">
                        <select class="form-select cfg-select" data-label="" id="displaySelect">
                          <option value="">-- Chọn màn hình --</option>
                          <option>14&quot; FHD IPS 60Hz</option>
                          <option>14&quot; 2.8K 90Hz OLED</option>
                          <option>15.6&quot; FHD 144Hz</option>
                          <option>16&quot; 2.5K 165Hz</option>
                        </select>
                        <label for="displaySelect">
                          <i class="fas fa-tv me-2"></i>
                          Màn hình
                        </label>
                      </div>
                    </div>

                    <div class="col-md-4">
                      <div class="form-floating">
                        <select class="form-select cfg-select" data-label="" id="osSelect">
                          <option value="">-- Chọn hệ điều hành --</option>
                          <option>Windows 11 Home</option>
                          <option>Windows 11 Pro</option>
                          <option>Ubuntu 22.04</option>
                          <option>FreeDOS</option>
                        </select>
                        <label for="osSelect">
                          <i class="fab fa-windows me-2"></i>
                          Hệ điều hành
                        </label>
                      </div>
                    </div>
                  </div>

                  <div class="mt-4 p-3 bg-white rounded-3 border">
                    <div class="mb-2">
                      <i class="fas fa-eye me-2"></i>
                      <span class="fw-medium">Xem trước cấu hình:</span>
                    </div>
                    <div id="cfg-preview" class="fst-italic text-primary"></div>
                  </div>

                  <div class="mt-3 d-flex gap-2">
                    <button type="button" class="btn btn-primary" id="btn-apply-cfg">
                      <i class="fas fa-check me-2"></i>
                      Áp dụng cấu hình này
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="btn-clear-cfg">
                      <i class="fas fa-times me-2"></i>
                      Xóa lựa chọn
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Quản lý hình ảnh -->
          <div class="card bg-light border mb-4">
            <div class="card-header bg-transparent border-bottom">
              <h6 class="mb-0">
                <i class="fas fa-images me-2"></i>
                Quản lý hình ảnh sản phẩm
              </h6>
            </div>
            <div class="card-body">
              <!-- Ảnh hiện có -->
              <div class="mb-4" th:if="${product.id != null}">
                <h6 class="fw-medium mb-3">
                  <i class="fas fa-photo-video me-2"></i>
                  Ảnh đã tải lên
                </h6>
                <div class="row g-3">
                  <div class="col-6 col-md-4 col-lg-3" th:each="i : ${#numbers.sequence(1,5)}">
                    <div class="position-relative">
                      <img class="img-preview shadow-sm"
                           th:src="@{/product/{id}/image/{i}(id=${product.id}, i=${i})}"
                           th:alt="${'Ảnh ' + i}"
                           onerror="this.style.display='none'"/>
                      <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-info" th:if="${product.featuredIndex == i}">
                          <i class="fas fa-star me-1"></i>
                          Ảnh đại diện
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Upload ảnh mới -->
              <div>
                <h6 class="fw-medium mb-3">
                  <i class="fas fa-upload me-2"></i>
                  Tải lên ảnh mới
                </h6>
                <div class="alert alert-info mb-3">
                  <div class="d-flex">
                    <div class="me-3">
                      <i class="fas fa-info-circle fa-2x"></i>
                    </div>
                    <div>
                      <h6 class="alert-heading mb-1">Hướng dẫn tải ảnh</h6>
                      <ul class="mb-0 ps-3">
                        <li>Tải lên tối đa 5 ảnh cho mỗi sản phẩm</li>
                        <li>Chọn 1 ảnh làm ảnh đại diện hiển thị ngoài trang chủ</li>
                        <li>Định dạng hỗ trợ: JPG, PNG, GIF</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="row g-4">
                  <!-- Ảnh 1 -->
                  <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <div class="card h-100">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                          <h6 class="mb-0">Ảnh 1</h6>
                          <div class="form-check">
                            <input class="form-check-input" type="radio" name="featuredIndex" value="1"
                                   th:checked="${product.featuredIndex == null ? true : (product.featuredIndex == 1)}"
                                   id="featured1"/>
                            <label class="form-check-label small" for="featured1">
                              Đặt làm đại diện
                            </label>
                          </div>
                        </div>
                        
                        <div class="upload-zone p-3 bg-light rounded text-center mb-3">
                          <input type="file" class="form-control d-none" id="imageFile1" 
                                 name="imageFiles" accept="image/*"
                                 th:attr="required=${product.id == null}"/>
                          <label for="imageFile1" class="mb-0" style="cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                            <br/>
                            <span class="small">Click để chọn ảnh</span>
                          </label>
                        </div>
                        
                        <div class="preview-zone">
                          <img class="img-preview shadow-sm" th:if="${product.id != null}"
                               th:src="@{/product/{id}/image/1(id=${product.id})}" 
                               alt="Ảnh 1" onerror="this.style.display='none'"/>
                          <img class="img-preview shadow-sm" id="preview1" 
                               style="display:none" alt="Preview 1"/>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Ảnh 2 -->
                  <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <div class="card h-100">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                          <h6 class="mb-0">Ảnh 2</h6>
                          <div class="form-check">
                            <input class="form-check-input" type="radio" name="featuredIndex" value="2"
                                   th:checked="${product.featuredIndex != null and product.featuredIndex == 2}"
                                   id="featured2"/>
                            <label class="form-check-label small" for="featured2">
                              Đặt làm đại diện
                            </label>
                          </div>
                        </div>
                        
                        <div class="upload-zone p-3 bg-light rounded text-center mb-3">
                          <input type="file" class="form-control d-none" id="imageFile2" 
                                 name="imageFiles" accept="image/*"/>
                          <label for="imageFile2" class="mb-0" style="cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                            <br/>
                            <span class="small">Click để chọn ảnh</span>
                          </label>
                        </div>
                        
                        <div class="preview-zone">
                          <img class="img-preview shadow-sm" th:if="${product.id != null}"
                               th:src="@{/product/{id}/image/2(id=${product.id})}" 
                               alt="Ảnh 2" onerror="this.style.display='none'"/>
                          <img class="img-preview shadow-sm" id="preview2" 
                               style="display:none" alt="Preview 2"/>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Ảnh 3 -->
                  <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <div class="card h-100">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                          <h6 class="mb-0">Ảnh 3</h6>
                          <div class="form-check">
                            <input class="form-check-input" type="radio" name="featuredIndex" value="3"
                                   th:checked="${product.featuredIndex != null and product.featuredIndex == 3}"
                                   id="featured3"/>
                            <label class="form-check-label small" for="featured3">
                              Đặt làm đại diện
                            </label>
                          </div>
                        </div>
                        
                        <div class="upload-zone p-3 bg-light rounded text-center mb-3">
                          <input type="file" class="form-control d-none" id="imageFile3" 
                                 name="imageFiles" accept="image/*"/>
                          <label for="imageFile3" class="mb-0" style="cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                            <br/>
                            <span class="small">Click để chọn ảnh</span>
                          </label>
                        </div>
                        
                        <div class="preview-zone">
                          <img class="img-preview shadow-sm" th:if="${product.id != null}"
                               th:src="@{/product/{id}/image/3(id=${product.id})}" 
                               alt="Ảnh 3" onerror="this.style.display='none'"/>
                          <img class="img-preview shadow-sm" id="preview3" 
                               style="display:none" alt="Preview 3"/>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Ảnh 4 -->
                  <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <div class="card h-100">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                          <h6 class="mb-0">Ảnh 4</h6>
                          <div class="form-check">
                            <input class="form-check-input" type="radio" name="featuredIndex" value="4"
                                   th:checked="${product.featuredIndex != null and product.featuredIndex == 4}"
                                   id="featured4"/>
                            <label class="form-check-label small" for="featured4">
                              Đặt làm đại diện
                            </label>
                          </div>
                        </div>
                        
                        <div class="upload-zone p-3 bg-light rounded text-center mb-3">
                          <input type="file" class="form-control d-none" id="imageFile4" 
                                 name="imageFiles" accept="image/*"/>
                          <label for="imageFile4" class="mb-0" style="cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                            <br/>
                            <span class="small">Click để chọn ảnh</span>
                          </label>
                        </div>
                        
                        <div class="preview-zone">
                          <img class="img-preview shadow-sm" th:if="${product.id != null}"
                               th:src="@{/product/{id}/image/4(id=${product.id})}" 
                               alt="Ảnh 4" onerror="this.style.display='none'"/>
                          <img class="img-preview shadow-sm" id="preview4" 
                               style="display:none" alt="Preview 4"/>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Ảnh 5 -->
                  <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <div class="card h-100">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                          <h6 class="mb-0">Ảnh 5</h6>
                          <div class="form-check">
                            <input class="form-check-input" type="radio" name="featuredIndex" value="5"
                                   th:checked="${product.featuredIndex != null and product.featuredIndex == 5}"
                                   id="featured5"/>
                            <label class="form-check-label small" for="featured5">
                              Đặt làm đại diện
                            </label>
                          </div>
                        </div>
                        
                        <div class="upload-zone p-3 bg-light rounded text-center mb-3">
                          <input type="file" class="form-control d-none" id="imageFile5" 
                                 name="imageFiles" accept="image/*"/>
                          <label for="imageFile5" class="mb-0" style="cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                            <br/>
                            <span class="small">Click để chọn ảnh</span>
                          </label>
                        </div>
                        
                        <div class="preview-zone">
                          <img class="img-preview shadow-sm" th:if="${product.id != null}"
                               th:src="@{/product/{id}/image/5(id=${product.id})}" 
                               alt="Ảnh 5" onerror="this.style.display='none'"/>
                          <img class="img-preview shadow-sm" id="preview5" 
                               style="display:none" alt="Preview 5"/>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between mt-4">
            <div class="d-flex gap-2">
              <button type="submit" name="action" value="save" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>
                <span th:text="${product.id == null ? 'Tạo mới' : 'Cập nhật'}">Lưu</span>
              </button>
              <button type="submit" name="action" value="save_list" class="btn btn-outline-secondary">
                <i class="fas fa-list me-1"></i> Lưu &amp; về trang chủ
              </button>
            </div>
            <a th:href="@{/admin/dashboard}" class="btn btn-secondary"
               onclick="return confirm('Bạn có chắc chắc muốn hủy không?');">
              <i class="fas fa-times me-1"></i>Hủy
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <footer th:fragment="admin-footer">
    <div class="container text-center py-4 border-top mt-5">
      <p class="mb-1">&copy; <span th:text="${T(java.time.Year).now()}">2025</span> ADMIN MANAGER - All rights reserved.</p>
      <p class="text-muted small">Hệ thống quản trị dành cho quản lý sản phẩm, đơn hàng và người dùng.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Preview ảnh mới chọn
    function bindPreview(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      if (!input || !preview) return;
      input.addEventListener('change', e => {
        const file = e.target.files && e.target.files[0];
        if (!file) { preview.style.display = 'none'; preview.src = ''; return; }
        const reader = new FileReader();
        reader.onload = ev => { preview.src = ev.target.result; preview.style.display = 'block'; };
        reader.readAsDataURL(file);
      });
    }
    bindPreview('imageFile1','preview1');
    bindPreview('imageFile2','preview2');
    bindPreview('imageFile3','preview3');
    bindPreview('imageFile4','preview4');
    bindPreview('imageFile5','preview5');
  </script>

  <!-- JS ghép cấu hình -->
  <script>
  (function(){
    const configField = document.getElementById('configuration') || document.querySelector('[name="configuration"]');
    const selects     = document.querySelectorAll('.cfg-select');
    const preview     = document.getElementById('cfg-preview');
    const applyBtn    = document.getElementById('btn-apply-cfg');
    const clearBtn    = document.getElementById('btn-clear-cfg');

    function buildConfig() {
      const parts = [];
      selects.forEach(s => {
        const val = (s.value || '').trim();
        if (!val) return;
        const label = (s.dataset.label || '').trim();
        parts.push(label ? `${val.replace(/, *$/,'')}, ${label}` : val);
      });
      return parts.join(', ');
    }

    function updatePreviewAndField() {
      const text = buildConfig();
      if (preview) preview.textContent = text;
      if (configField) configField.value = text;
    }

    selects.forEach(s => s.addEventListener('change', updatePreviewAndField));

    applyBtn && applyBtn.addEventListener('click', function(){
      const text = buildConfig();
      if (configField) configField.value = text;
      if (preview) preview.textContent = text;
    });

    clearBtn && clearBtn.addEventListener('click', function(){
      selects.forEach(s => s.value = '');
      updatePreviewAndField();
    });

    if (configField && configField.value) {
      const savedParts = configField.value.split(',').map(p => p.trim().toLowerCase());
      selects.forEach(s => {
        for (let opt of s.options) {
          if (savedParts.includes(opt.text.trim().toLowerCase())) {
            s.value = opt.text;
            break;
          }
        }
      });
      updatePreviewAndField();
    } else {
      updatePreviewAndField();
    }
  })();
  </script>

    <!-- Image Management Scripts -->
    <script>
      // Initialize Dropzone for upload modal
      function initDropzone() {
        const uploadZone = document.querySelector('.upload-zone');
        const uploadInput = document.getElementById('uploadInput');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          uploadZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
          uploadZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
          uploadZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
          uploadZone.classList.add('border', 'border-primary');
        }

        function unhighlight(e) {
          uploadZone.classList.remove('border', 'border-primary');
        }

        uploadZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;
          handleFiles(files);
        }

        uploadInput.addEventListener('change', function() {
          handleFiles(this.files);
        });
      }

      // Image preview and validation
      for (let i = 1; i <= 5; i++) {
        const imageInput = document.getElementById(`imageFile${i}`);
        const previewImage = document.getElementById(`preview${i}`);
        const uploadZone = imageInput.closest('.upload-zone');
        const previewZone = imageInput.closest('.card-body').querySelector('.preview-zone');

        imageInput.addEventListener('change', function () {
          const file = this.files[0];
          if (file) {
            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
              showError('Vui lòng chọn file ảnh định dạng JPG, PNG hoặc GIF');
              this.value = '';
              return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
              showError('Kích thước ảnh không được vượt quá 5MB');
              this.value = '';
              return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
              previewImage.src = e.target.result;
              previewImage.style.display = 'block';
              uploadZone.classList.add('d-none');
              previewZone.classList.remove('d-none');
              
              // Add remove button
              if (!previewZone.querySelector('.remove-btn')) {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0 m-2 remove-btn';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.onclick = function(e) {
                  e.preventDefault();
                  resetImageUpload(i);
                };
                previewZone.appendChild(removeBtn);
              }
            }
            reader.readAsDataURL(file);
          }
        });
      }

      // Reset image upload
      function resetImageUpload(index) {
        const imageInput = document.getElementById(`imageFile${index}`);
        const previewImage = document.getElementById(`preview${index}`);
        const uploadZone = imageInput.closest('.upload-zone');
        const previewZone = imageInput.closest('.card-body').querySelector('.preview-zone');
        
        imageInput.value = '';
        previewImage.style.display = 'none';
        uploadZone.classList.remove('d-none');
        previewZone.classList.add('d-none');
        
        const removeBtn = previewZone.querySelector('.remove-btn');
        if (removeBtn) {
          removeBtn.remove();
        }
      }

      // Show error message using SweetAlert2
      function showError(message) {
        Swal.fire({
          icon: 'error',
          title: 'Lỗi',
          text: message,
          confirmButtonColor: '#3085d6'
        });
      }

      // Initialize tooltips
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      const tooltipList = [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));

      // Add custom styles
      const style = document.createElement('style');
      style.textContent = `
        .upload-zone {
          transition: all 0.3s ease;
          border: 2px dashed #dee2e6;
        }
        .upload-zone:hover {
          border-color: var(--bs-primary);
        }
        .preview-zone {
          position: relative;
        }
        .preview-zone img {
          width: 100%;
          height: auto;
          border-radius: 0.25rem;
        }
        .remove-btn {
          transition: all 0.2s ease;
          opacity: 0;
        }
        .preview-zone:hover .remove-btn {
          opacity: 1;
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>