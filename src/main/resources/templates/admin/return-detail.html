<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chi tiết yêu cầu trả hàng · Admin</title>

    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary-color: #4f46e5;
        --secondary-color: #7c3aed;
        --success-color: #059669;
        --danger-color: #dc2626;
        --warning-color: #d97706;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: #f9fafb;
        color: #111827;
        padding-top: 70px;
      }

      .navbar {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        ) !important;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      }

      .card {
        border: 1px solid #e5e7eb;
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      }

      .card-header {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: #fff;
        font-weight: 500;
        padding: 1rem 1.5rem;
      }

      .info-label {
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 0.25rem;
      }

      .info-value {
        font-size: 1.1rem;
        color: #111827;
      }

      .badge {
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-weight: 500;
      }

      .product-img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
      }

      .photo-thumbnail {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .photo-thumbnail:hover {
        transform: scale(1.05);
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="/admin/dashboard">
          <i class="fas fa-tachometer-alt me-2"></i>Admin Panel
        </a>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/admin/returns">
              <i class="fas fa-arrow-left me-1"></i>Quay lại
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
      <div class="row">
        <!-- Left: Return Info -->
        <div class="col-lg-8">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-undo me-2"></i>Yêu cầu trả hàng #<span
                  th:text="${returnRequest.id}"
                ></span>
              </h5>
            </div>
            <div class="card-body">
              <!-- Status & Dates -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="info-label">Trạng thái</div>
                  <div>
                    <span
                      class="badge"
                      th:classappend="${returnRequest.status.name() == 'REQUESTED' ? 'bg-info' :
                                       returnRequest.status.name() == 'APPROVED' ? 'bg-success' :
                                       returnRequest.status.name() == 'REJECTED' ? 'bg-danger' :
                                       returnRequest.status.name() == 'ITEM_RECEIVED' ? 'bg-primary' :
                                       returnRequest.status.name() == 'REFUNDED' ? 'bg-success' : 'bg-secondary'}"
                      th:text="${returnRequest.status.label}"
                    >
                    </span>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="info-label">Ngày tạo</div>
                  <div
                    class="info-value"
                    th:text="${#temporals.format(returnRequest.createdAt, 'dd/MM/yyyy HH:mm')}"
                  ></div>
                </div>
              </div>

              <!-- Order & Customer -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="info-label">Đơn hàng</div>
                  <div class="info-value">
                    <a
                      th:href="@{'/admin/orders/' + ${returnRequest.order.id}}"
                      class="text-decoration-none"
                    >
                      #<span th:text="${returnRequest.order.id}"></span>
                    </a>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="info-label">Khách hàng</div>
                  <div
                    class="info-value"
                    th:text="${returnRequest.customer.username}"
                  ></div>
                </div>
              </div>

              <!-- Reason -->
              <div class="mb-3">
                <div class="info-label">Lý do trả hàng</div>
                <div
                  class="alert alert-light mb-0"
                  th:text="${returnRequest.reason}"
                ></div>
              </div>

              <!-- Return Items -->
              <div class="mb-3">
                <div class="info-label">Sản phẩm trả</div>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead class="table-light">
                      <tr>
                        <th>Sản phẩm</th>
                        <th>Giá</th>
                        <th>SL trả</th>
                        <th>Thành tiền</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr th:each="item : ${returnItems}">
                        <td
                          th:with="orderItem=${returnRequest.order.items.stream().filter(oi -> oi.id == item.orderItemId).findFirst().orElse(null)}"
                        >
                          <span
                            th:if="${orderItem != null}"
                            th:text="${orderItem.product.name}"
                            >Product</span
                          >
                        </td>
                        <td
                          th:with="orderItem=${returnRequest.order.items.stream().filter(oi -> oi.id == item.orderItemId).findFirst().orElse(null)}"
                        >
                          <span
                            th:if="${orderItem != null}"
                            th:text="${#numbers.formatDecimal(orderItem.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' đ'"
                          ></span>
                        </td>
                        <td th:text="${item.quantity}"></td>
                        <td
                          th:with="orderItem=${returnRequest.order.items.stream().filter(oi -> oi.id == item.orderItemId).findFirst().orElse(null)}"
                        >
                          <strong
                            th:if="${orderItem != null}"
                            th:text="${#numbers.formatDecimal(orderItem.unitPrice * item.quantity, 0, 'COMMA', 0, 'POINT')} + ' đ'"
                          >
                          </strong>
                        </td>
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr class="table-warning fw-bold">
                        <td colspan="3" class="text-end">Tổng hoàn trả:</td>
                        <td
                          th:text="${#numbers.formatDecimal(returnRequest.refundAmount, 0, 'COMMA', 0, 'POINT')} + ' đ'"
                        ></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              <!-- Photos -->
              <div
                class="mb-3"
                th:if="${returnRequest.photos != null and !returnRequest.photos.isEmpty()}"
              >
                <div class="info-label">Ảnh chứng minh</div>
                <div class="d-flex gap-2 flex-wrap">
                  <img
                    th:each="photo : ${returnRequest.photos.split(',')}"
                    th:src="@{'/' + ${photo}}"
                    class="photo-thumbnail"
                    alt="Evidence photo"
                    data-bs-toggle="modal"
                    data-bs-target="#photoModal"
                    th:onclick="'showPhoto(\'' + ${photo} + '\')'"
                  />
                </div>
              </div>

              <!-- Admin Note -->
              <div
                class="mb-3"
                th:if="${returnRequest.adminNote != null and !returnRequest.adminNote.isEmpty()}"
              >
                <div class="info-label">Ghi chú của admin</div>
                <div
                  class="alert alert-warning mb-0"
                  th:text="${returnRequest.adminNote}"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Actions -->
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Hành động</h6>
            </div>
            <div class="card-body">
              <!-- Approve (khi REQUESTED) -->
              <button
                th:if="${returnRequest.status.name() == 'REQUESTED'}"
                class="btn btn-success w-100 mb-2"
                onclick="handleAction('approve', 'Bạn chắc chắn muốn phê duyệt yêu cầu này?')"
              >
                <i class="fas fa-check me-1"></i>Phê duyệt
              </button>

              <!-- Reject (khi REQUESTED) -->
              <button
                th:if="${returnRequest.status.name() == 'REQUESTED'}"
                class="btn btn-danger w-100 mb-2"
                data-bs-toggle="modal"
                data-bs-target="#rejectModal"
              >
                <i class="fas fa-times me-1"></i>Từ chối
              </button>

              <!-- Mark as Received (khi APPROVED) -->
              <button
                th:if="${returnRequest.status.name() == 'APPROVED'}"
                class="btn btn-primary w-100 mb-2"
                onclick="handleAction('received', 'Bạn đã nhận được hàng trả? Hành động này sẽ cập nhật kho.')"
              >
                <i class="fas fa-box me-1"></i>Đánh dấu đã nhận hàng
              </button>

              <!-- Mark as Refunded (khi ITEM_RECEIVED) -->
              <button
                th:if="${returnRequest.status.name() == 'ITEM_RECEIVED'}"
                class="btn btn-success w-100 mb-2"
                onclick="handleAction('refund', 'Xác nhận đã hoàn tiền cho khách hàng?')"
              >
                <i class="fas fa-money-bill me-1"></i>Xác nhận hoàn tiền
              </button>

              <hr />

              <!-- Timeline -->
              <div class="small">
                <div class="mb-2">
                  <strong>Lịch sử:</strong>
                </div>
                <div class="mb-1" th:if="${returnRequest.createdAt != null}">
                  <i class="fas fa-calendar text-muted me-1"></i>
                  Tạo:
                  <span
                    th:text="${#temporals.format(returnRequest.createdAt, 'dd/MM HH:mm')}"
                  ></span>
                </div>
                <div class="mb-1" th:if="${returnRequest.processedAt != null}">
                  <i class="fas fa-check text-muted me-1"></i>
                  Xử lý:
                  <span
                    th:text="${#temporals.format(returnRequest.processedAt, 'dd/MM HH:mm')}"
                  ></span>
                </div>
                <div class="mb-1" th:if="${returnRequest.receivedAt != null}">
                  <i class="fas fa-box text-muted me-1"></i>
                  Nhận hàng:
                  <span
                    th:text="${#temporals.format(returnRequest.receivedAt, 'dd/MM HH:mm')}"
                  ></span>
                </div>
                <div class="mb-1" th:if="${returnRequest.refundedAt != null}">
                  <i class="fas fa-money-bill text-muted me-1"></i>
                  Hoàn tiền:
                  <span
                    th:text="${#temporals.format(returnRequest.refundedAt, 'dd/MM HH:mm')}"
                  ></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reject Modal -->
    <div class="modal fade" id="rejectModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Từ chối yêu cầu</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <label class="form-label fw-bold"
              >Lý do từ chối <span class="text-danger">*</span></label
            >
            <textarea
              id="rejectReasonInput"
              class="form-control"
              rows="3"
              placeholder="Nhập lý do từ chối..."
            ></textarea>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Hủy
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="submitReject()"
            >
              Xác nhận từ chối
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Photo Modal -->
    <div class="modal fade" id="photoModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-body p-0">
            <img id="photoModalImg" src="" class="w-100" alt="Photo" />
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
      const returnId = /*[[${returnRequest.id}]]*/ 0;
      const csrfToken = document
        .querySelector('meta[name="_csrf"]')
        ?.getAttribute("content");
      const csrfHeader = document
        .querySelector('meta[name="_csrf_header"]')
        ?.getAttribute("content");

      function showPhoto(photoPath) {
        document.getElementById("photoModalImg").src = "/" + photoPath;
      }

      async function handleAction(action, confirmMsg) {
        if (!confirm(confirmMsg)) return;

        const headers = { "Content-Type": "application/json" };
        if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

        try {
          const response = await fetch(`/admin/returns/${returnId}/${action}`, {
            method: "POST",
            headers: headers,
          });

          const result = await response.json();

          if (result.success) {
            alert(result.message);
            window.location.reload();
          } else {
            alert("Lỗi: " + result.message);
          }
        } catch (error) {
          console.error(error);
          alert("Có lỗi xảy ra. Vui lòng thử lại!");
        }
      }

      async function submitReject() {
        const reason = document
          .getElementById("rejectReasonInput")
          .value.trim();
        if (!reason) {
          alert("Vui lòng nhập lý do từ chối!");
          return;
        }

        const headers = { "Content-Type": "application/x-www-form-urlencoded" };
        if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

        try {
          const response = await fetch(`/admin/returns/${returnId}/reject`, {
            method: "POST",
            headers: headers,
            body: "adminNote=" + encodeURIComponent(reason),
          });

          const result = await response.json();

          if (result.success) {
            alert(result.message);
            window.location.reload();
          } else {
            alert("Lỗi: " + result.message);
          }
        } catch (error) {
          console.error(error);
          alert("Có lỗi xảy ra. Vui lòng thử lại!");
        }
      }
    </script>
  </body>
</html>
