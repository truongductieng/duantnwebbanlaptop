<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H·ªó tr·ª£ tr·ª±c tuy·∫øn</title>

  <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>

  <style>
    :root{
      --brand:#5865f2;
      --bg:#f6f7fb;
      --me:#e7f0ff;
      --peer:#f1f3f5;
      --text:#2e2e2e;
    }
    body{background:var(--bg); color:var(--text);}
    .chat-wrap{max-width:960px; margin:24px auto; padding:0 12px;}
    .card-chat{border:none; border-radius:18px; overflow:hidden; box-shadow:0 .75rem 2rem rgba(0,0,0,.08);}
    .chat-header{
      background:linear-gradient(135deg,var(--brand),#7a86ff);
      color:#fff; padding:.9rem 1.1rem;
      display:flex; align-items:center; justify-content:space-between;
    }
    .peer{
      display:flex; align-items:center; gap:.75rem;
    }
    .avatar{
      width:40px; height:40px; border-radius:50%;
      display:grid; place-items:center;
      background:#fff; color:var(--brand); font-weight:800;
      box-shadow:0 .25rem .5rem rgba(0,0,0,.15);
    }
    .peer .name{font-weight:700; letter-spacing:.2px}
    .peer .sub{opacity:.9; font-size:.86rem}
    .status-dot{
      width:10px; height:10px; border-radius:50%; background:#22c55e; display:inline-block; margin-right:.35rem;
      box-shadow:0 0 0 2px rgba(255,255,255,.6);
    }

    .chat-body{
      background:#fff; height: calc(100vh - 260px); /* responsive height */
      min-height: 420px;
      overflow-y:auto; padding:1rem;
    }
    @media (max-width: 576px){
      .chat-body{height: calc(100vh - 240px);}
    }

    .msg-row{display:flex; margin:.4rem 0;}
    .msg-row.me{justify-content:flex-end;}
    .bubble{
      max-width:75%;
      padding:.6rem .75rem;
      border-radius:16px; line-height:1.35;
      box-shadow:0 .35rem 1rem rgba(0,0,0,.06);
      word-wrap: break-word; white-space: pre-wrap;
    }
    .msg-row.me .bubble{
      background:var(--me); color:#0d47a1;
      border-top-right-radius:6px;
    }
    .msg-row.peer .bubble{
      background:var(--peer); color:#1f2937;
      border-top-left-radius:6px;
    }
    .meta{
      font-size:.8rem; opacity:.7; margin-top:.15rem; user-select:none;
    }

    .chat-input{
      background:#fff; border-top:1px solid #eef0f4; padding:.75rem;
    }
    .chat-input .form-control{
      border-radius:12px;
    }
    .chat-input .btn{
      border-radius:12px; padding:.55rem .9rem;
    }

    .offline{
      background:#fff7ed; color:#9a3412; border:1px dashed #fdba74;
      margin:8px 12px 0; padding:.5rem .75rem; border-radius:10px; display:none;
    }
    .offline.show{display:block;}

    .empty{
      text-align:center; opacity:.6; padding:2rem 1rem;
    }
  </style>
</head>
<body>
  <div class="chat-wrap">
    <div class="card card-chat">
      <div class="chat-header">
        <div class="peer">
          <div class="avatar" id="peerAvatar">A</div>
          <div>
            <div class="name">
              H·ªó tr·ª£: <span id="peerName" th:text="${adminUsername}">admin</span>
            </div>
            <div class="sub"><span class="status-dot"></span>Tr·ª±c tuy·∫øn</div>
          </div>
        </div>
        <div class="d-flex gap-2">
          <a th:href="@{/}" class="btn btn-light btn-sm"><i class="bi bi-house"></i> Trang ch·ªß</a>
        </div>
      </div>

      <div id="offlineBar" class="offline">M·∫•t k·∫øt n·ªëi, ƒëang th·ª≠ n·ªëi l·∫°i‚Ä¶</div>

      <div id="messages" class="chat-body">
        <div class="empty" id="emptyState">
          <i class="bi bi-chat-dots" style="font-size:2rem;"></i>
          <div class="mt-2">Ch√†o <span th:text="${username}">b·∫°n</span> üëã<br/>H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán v·ªõi ch√∫ng t√¥i.</div>
        </div>
      </div>

      <div class="chat-input">
        <div class="input-group">
          <input id="textInput" type="text" class="form-control" placeholder="Nh·∫≠p tin nh·∫Øn v√† nh·∫•n Enter‚Ä¶" autocomplete="off" />
          <button id="sendBtn" class="btn btn-primary" type="button" disabled>
            <i class="bi bi-send"></i> G·ª≠i
          </button>
        </div>
      </div>
    </div>
  </div>

  <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <!-- Bi·∫øn model Thymeleaf -->
  <script th:inline="javascript">
    const ME             = /*[[${username}]]*/ 'user';
    const ADMIN_USERNAME = /*[[${adminUsername}]]*/ 'admin';
  </script>

  <script>
    // UI helpers
    const $messages  = document.getElementById('messages');
    const $input     = document.getElementById('textInput');
    const $send      = document.getElementById('sendBtn');
    const $offline   = document.getElementById('offlineBar');
    const $empty     = document.getElementById('emptyState');
    const $peerName  = document.getElementById('peerName');
    const $peerAvatar= document.getElementById('peerAvatar');

    // Avatar = k√Ω t·ª± ƒë·∫ßu c·ªßa admin
    (function(){
      const n = ($peerName?.textContent || ADMIN_USERNAME || 'A').trim();
      $peerAvatar.textContent = n ? n.charAt(0).toUpperCase() : 'A';
    })();

    function esc(s=''){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function fmt(ts){
      try { return new Date(ts).toLocaleString('vi-VN'); }
      catch{ return new Date().toLocaleString('vi-VN'); }
    }
    function hideEmpty(){ if($empty) $empty.style.display='none'; }

    function appendMsg({from, content, timestamp}){
      hideEmpty();
      const row = document.createElement('div');
      const isMe = from === ME;
      row.className = 'msg-row ' + (isMe ? 'me' : 'peer');

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = `${esc(content)}`;
      row.appendChild(bubble);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `${isMe ? 'B·∫°n' : from} ‚Ä¢ ${fmt(timestamp || Date.now())}`;

      const wrap = document.createElement('div');
      wrap.appendChild(row);
      wrap.appendChild(meta);

      $messages.appendChild(wrap);
      $messages.scrollTop = $messages.scrollHeight;
    }

    // Enable/disable send button
    $input.addEventListener('input', () => {
      $send.disabled = !$input.value.trim();
    });

    // STOMP
    let stomp = null;
    let reconnectTimer = null;

    function setOffline(on){
      if(on){ $offline.classList.add('show'); }
      else  { $offline.classList.remove('show'); }
    }

    function connect(){
      const sock = new SockJS('/ws-chat');
      stomp = Stomp.over(sock);
      // T·∫Øt log n·∫øu mu·ªën g·ªçn console:
      // stomp.debug = () => {};
      stomp.connect({}, function(){
        setOffline(false);
        // nh·∫≠n tin nh·∫Øn ri√™ng
        stomp.subscribe('/user/queue/messages', function(frame){
          try{
            const m = JSON.parse(frame.body);
            appendMsg({
              from: m.from || m.sender,
              content: m.content,
              timestamp: m.timestamp || m.sent_at
            });
          }catch(e){}
        });

        loadHistory(); // t·∫£i l·ªãch s·ª≠ n·∫øu API c√≥
      }, function(){ // on error
        setOffline(true);
        if(reconnectTimer) clearTimeout(reconnectTimer);
        reconnectTimer = setTimeout(connect, 2000);
      });

      sock.onclose = () => {
        setOffline(true);
        if(reconnectTimer) clearTimeout(reconnectTimer);
        reconnectTimer = setTimeout(connect, 2000);
      };
    }

    function send(){
      if(!stomp || !stomp.connected) return;
      const text = $input.value.trim();
      if(!text) return;
      // user kh√¥ng c·∫ßn 'to', backend √©p v·ªÅ admin
      stomp.send('/app/chat.send', {}, JSON.stringify({ content: text }));
      $input.value = '';
      $send.disabled = true;
    }

    $send.addEventListener('click', send);
    $input.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    async function loadHistory(){
      try{
        const res = await fetch(`/api/chat/history?with=${encodeURIComponent(ADMIN_USERNAME)}`, {
          headers:{'Accept':'application/json'}
        });
        if(!res.ok) return;
        const data = await res.json(); // m·∫£ng [{sender, content, sent_at}, ...]
        if(Array.isArray(data) && data.length){
          $messages.innerHTML = '';
          data.forEach(m => appendMsg({
            from: m.sender || m.from,
            content: m.content,
            timestamp: m.sent_at || m.timestamp
          }));
        }
        // ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc (n·∫øu API c√≥)
        try{
          await fetch(`/api/chat/mark-read?with=${encodeURIComponent(ADMIN_USERNAME)}`, { method:'POST' });
        }catch(_){}
      }catch(_){}
    }

    // Kickoff
    connect();
  </script>
</body>
</html>
