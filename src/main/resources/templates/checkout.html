<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Thanh toán</title>
  <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
</head>
<body class="container py-5">

  <h1 class="mb-4">Thanh toán</h1>

  <div class="row">
    <!-- GIỎ HÀNG -->
    <div class="col-md-6">
      <h3>Giỏ hàng</h3>

      <!-- Form nhập mã giảm giá -->
      <form th:action="@{/cart/apply-discount}" method="post" class="mb-4">
        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <div class="input-group">
          <input
            type="text"
            name="discountCode"
            class="form-control"
            placeholder="Nhập mã giảm giá"
            th:value="${discountCode != null ? discountCode : session.discountCode}" />
          <button class="btn btn-outline-primary" type="submit">Áp dụng</button>
        </div>
      </form>

      <!-- Flash messages -->
      <div th:if="${success}" class="alert alert-success py-2 px-3" th:text="${success}"></div>
      <div th:if="${error}"   class="alert alert-danger  py-2 px-3" th:text="${error}"></div>

      <table class="table align-middle">
        <thead>
          <tr>
            <th>Hình ảnh</th>
            <th>Sản phẩm</th>
            <th>Số lượng</th>
            <th>Thành tiền</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="item : ${cartItems}">
            <td style="width:80px;">
              <img
                th:src="${item.laptop.imageUrl}"
                th:alt="${item.laptop.name}"
                class="img-fluid rounded"
                style="max-height:60px;" />
            </td>
            <td th:text="${item.laptop.name}">Tên sp</td>
            <td th:text="${item.quantity}">0</td>
            <td th:text="${#numbers.formatDecimal(item.laptop.price * item.quantity,0,'COMMA',0,'POINT')} + ' đ'">0 đ</td>
          </tr>

          <!-- Tổng trước giảm -->
          <tr>
            <th colspan="3" class="text-end">Tổng trước giảm:</th>
            <th th:text="${#numbers.formatDecimal(totalPrice,0,'COMMA',0,'POINT')} + ' đ'">0 đ</th>
          </tr>

          <!-- Giảm giá (nếu có) -->
          <tr th:with="
                da=${discountAmount   != null ? discountAmount   : session.discountAmount},
                dc=${discountCode     != null ? discountCode     : session.discountCode},
                dp=${discountPercent  != null ? discountPercent  : session.discountPercent}
              "
              th:if="${da != null and da > 0}">
            <th colspan="3" class="text-end">
              Giảm giá
              <span class="text-muted">
                (<span th:text="${dc}">CODE</span>
                <span th:if="${dp != null}"> - <span th:text="${dp}">0</span>%</span>)
              </span>:
            </th>
            <th th:text="${#numbers.formatDecimal(da,0,'COMMA',0,'POINT')} + ' đ'">0 đ</th>
          </tr>

          <!-- Tổng thanh toán -->
          <tr th:with="
                da=${discountAmount        != null ? discountAmount        : session.discountAmount},
                tad=${totalAfterDiscount   != null ? totalAfterDiscount    : null}
              ">
            <th colspan="3" class="text-end">Tổng thanh toán:</th>
            <th th:text="${
                (da != null and da > 0)
                ? #numbers.formatDecimal((tad != null ? tad : (totalPrice - da)),0,'COMMA',0,'POINT') + ' đ'
                : #numbers.formatDecimal(totalPrice,0,'COMMA',0,'POINT') + ' đ'
              }">0 đ</th>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- FORM THÔNG TIN KHÁCH HÀNG -->
    <div class="col-md-6">
      <h3>Thông tin khách hàng</h3>
      <form th:action="@{/checkout}" th:object="${checkoutForm}" method="post">
        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

        <!-- bind discount về CheckoutForm (lấy từ model hoặc session) -->
        <input type="hidden" th:field="*{discountCode}"
               th:value="${discountCode != null ? discountCode : session.discountCode}" />
        <input type="hidden" th:field="*{discountPercent}"
               th:value="${discountPercent != null ? discountPercent : session.discountPercent}" />
        <input type="hidden" th:field="*{discountAmount}"
               th:value="${discountAmount != null ? discountAmount : session.discountAmount}" />
        <input type="hidden" th:field="*{totalAfterDiscount}"
               th:value="${
                 (totalAfterDiscount != null and (discountAmount != null and discountAmount > 0))
                 ? totalAfterDiscount
                 : (session.discountAmount != null ? (totalPrice - session.discountAmount) : totalPrice)
               }" />

        <div class="mb-3">
          <label class="form-label">Họ và tên</label>
          <input type="text" class="form-control" th:field="*{fullName}" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" th:field="*{email}" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Địa chỉ</label>
          <textarea class="form-control" rows="3" th:field="*{address}" required></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Số điện thoại</label>
          <input type="tel" class="form-control" th:field="*{phone}" required />
        </div>
        <div class="mb-3">
  <label class="form-label">Phương thức thanh toán <span class="text-danger">*</span></label><br>

  <div class="form-check">
    <input class="form-check-input"
           type="radio"
           id="pmCOD"
           th:field="*{paymentMethod}"
           value="COD"
           required
           th:classappend="${#fields.hasErrors('paymentMethod')}? 'is-invalid'">
    <label class="form-check-label" for="pmCOD">Thanh toán khi nhận hàng (COD)</label>
  </div>

  <div class="form-check">
    <input class="form-check-input"
           type="radio"
           id="pmVNPAY"
           th:field="*{paymentMethod}"
           value="VNPAY"
           th:classappend="${#fields.hasErrors('paymentMethod')}? 'is-invalid'">
    <label class="form-check-label" for="pmVNPAY">Chuyển khoản ngân hàng (VNPAY)</label>
  </div>

  <!-- Thông báo lỗi server-side -->
  <div class="invalid-feedback d-block"
       th:if="${#fields.hasErrors('paymentMethod')}"
       th:errors="*{paymentMethod}">
    Vui lòng chọn phương thức thanh toán.
  </div>
</div>

        <div class="d-flex justify-content-between">
          <a th:href="@{/cart}" class="btn btn-secondary">← Quay lại giỏ hàng</a>
          <button type="submit" class="btn btn-success">Xác nhận thanh toán</button>
        </div>
      </form>
    </div>
  </div>

  <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
