<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Thanh toán</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
  <style>
    :root{
      --brand-50:  #eef2ff;  /* indigo-50 */
      --brand-100: #e0e7ff;  /* indigo-100 */
      --brand-200: #c7d2fe;  /* indigo-200 */
      --brand-600: #4f46e5;  /* indigo-600 */
      --brand-700: #4338ca;  /* indigo-700 */
      --ink-700:   #2b2f36;
      --ink-500:   #495057;
    }

    /* Background */
    .checkout-page {
      background:
        radial-gradient(1200px 800px at -10% -10%, rgba(79,70,229,.20) 0%, rgba(79,70,229,0) 45%),
        radial-gradient(900px 700px at 110% 0%, rgba(67,56,202,.18) 0%, rgba(67,56,202,0) 40%),
        linear-gradient(135deg, var(--brand-600) 0%, var(--brand-700) 65%);
      min-height: 100vh;
    }

    /* Top bar + steps */
    .top-bar {
      color: #fff;
    }
    .steps { display:flex; align-items:center; gap:.75rem; }
    .step {
      display:flex; align-items:center; gap:.5rem; color:#e9ecef; font-weight:600;
    }
    .step .dot{ width:28px; height:28px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.18); color:#fff; font-size:.9rem; border:1px solid rgba(255,255,255,.25);
    }
    .step.active{ color:#fff; }
    .step.active .dot{ background:#fff; color:var(--brand-700); }
    .step + .step::before{
      content:""; display:block; width:36px; height:2px; background: rgba(255,255,255,.35); border-radius:2px; margin-right:.25rem;
    }

    /* Cards */
    .card-glass{
      background: rgba(255,255,255,.9);
      border:1px solid rgba(255,255,255,.6);
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.10);
      backdrop-filter: blur(10px);
    }
    .section-heading{ color: var(--ink-700); font-weight:700; letter-spacing:.2px; }
    .muted { color: var(--ink-500); }

    /* List items */
    .item-thumb{ width:64px; height:64px; object-fit:cover; border-radius:.6rem; }
    .price{ font-weight:700; color: var(--ink-700); }
    .qty{ font-weight:600; color: var(--ink-500); }

    /* Totals */
    .total-box{ background: var(--brand-50); border:1px dashed var(--brand-200); border-radius:.75rem; }
    .line{ display:flex; justify-content:space-between; align-items:center; gap:1rem; padding:.35rem 0; }
    .line.total{ color: var(--brand-700); font-size:1.05rem; font-weight:800; }

    /* Coupon */
    .coupon-label{ font-weight:600; color: var(--ink-700); }

    /* Buttons themed to brand */
    .btn-primary {
      --bs-btn-bg: var(--brand-600);
      --bs-btn-border-color: var(--brand-600);
      --bs-btn-hover-bg: var(--brand-700);
      --bs-btn-hover-border-color: var(--brand-700);
      --bs-btn-focus-shadow-rgb: 79,70,229;
      --bs-btn-active-bg: var(--brand-700);
      --bs-btn-active-border-color: var(--brand-700);
    }
    .btn-success { /* primary CTA follows brand */
      --bs-btn-bg: var(--brand-600);
      --bs-btn-border-color: var(--brand-600);
      --bs-btn-hover-bg: var(--brand-700);
      --bs-btn-hover-border-color: var(--brand-700);
      --bs-btn-focus-shadow-rgb: 79,70,229;
      --bs-btn-active-bg: var(--brand-700);
      --bs-btn-active-border-color: var(--brand-700);
    }
    .btn-outline-light{ --bs-btn-hover-bg:#fff; --bs-btn-hover-color: var(--brand-700); }
    .btn-outline-secondary {
      --bs-btn-color: var(--brand-700);
      --bs-btn-border-color: var(--brand-600);
      --bs-btn-hover-bg: var(--brand-600);
      --bs-btn-hover-border-color: var(--brand-600);
      --bs-btn-hover-color: #fff;
      --bs-btn-focus-shadow-rgb: 79,70,229;
    }

    /* Form focus + radios as segmented buttons */
    .form-control:focus, .form-select:focus {
      border-color: var(--brand-600);
      box-shadow: 0 0 0 .2rem rgba(79,70,229,.15);
    }
    .btn-check:checked + label{
      background: var(--brand-600);
      color:#fff;
      border-color: var(--brand-600);
    }
    .segmented label { margin-right:.5rem; }

    .sticky-summary{ position: sticky; top: 1rem; }

    @media (max-width: 991.98px){ .sticky-summary{ position: static; } }
    @media (max-width: 767.98px){
      .actions-stack{ flex-direction: column; gap: .75rem; }
      .actions-stack .btn{ width:100%; }
    }
  </style>
</head>
<body class="checkout-page">

  <!-- Top bar with back + steps -->
  <header class="top-bar py-3">
    <div class="container d-flex justify-content-between align-items-center">
      <a th:href="@{/cart}" class="btn btn-outline-light btn-sm">← Quay lại giỏ hàng</a>
      <div class="steps">
        <div class="step"><span class="dot">1</span><span>Giỏ hàng</span></div>
        <div class="step"><span class="dot">2</span><span>Thông tin</span></div>
        <div class="step active"><span class="dot">3</span><span>Thanh toán</span></div>
      </div>
    </div>
  </header>

  <main class="container py-4 py-lg-5">
    <div class="row g-4 g-lg-5">
      <!-- Left: Form -->
      <div class="col-lg-7">
        <div class="card-glass p-4 p-lg-5">
          <h2 class="section-heading mb-3">Thông tin thanh toán</h2>
          <p class="muted mb-4">Nhập thông tin người nhận và chọn phương thức thanh toán.</p>

          <form th:action="@{/checkout}" th:object="${checkoutForm}" method="post">
            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

            <!-- Bind discount values to CheckoutForm (unchanged) -->
            <input type="hidden" th:field="*{discountCode}"
                   th:value="${discountCode != null ? discountCode : session.discountCode}" />
            <input type="hidden" th:field="*{discountPercent}"
                   th:value="${discountPercent != null ? discountPercent : session.discountPercent}" />
            <input type="hidden" th:field="*{discountAmount}"
                   th:value="${discountAmount != null ? discountAmount : session.discountAmount}" />
            <input type="hidden" th:field="*{totalAfterDiscount}"
                   th:value="${
                     (totalAfterDiscount != null and (discountAmount != null and discountAmount > 0))
                     ? totalAfterDiscount
                     : (session.discountAmount != null ? (totalPrice - session.discountAmount) : totalPrice)
                   }" />

            <div class="row g-3">
              <div class="col-12">
                <div class="form-floating">
                  <input type="text" class="form-control" id="fullName" placeholder="Họ và tên" th:field="*{fullName}" required>
                  <label for="fullName">Họ và tên</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="email" class="form-control" id="email" placeholder="Email" th:field="*{email}" required>
                  <label for="email">Email</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="tel" class="form-control" id="phone" placeholder="Số điện thoại" th:field="*{phone}" required>
                  <label for="phone">Số điện thoại</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" placeholder="Địa chỉ" id="address" style="height: 100px" th:field="*{address}" required></textarea>
                  <label for="address">Địa chỉ</label>
                </div>
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold mb-2">Phương thức thanh toán <span class="text-danger">*</span></label>
                <div class="segmented d-flex flex-wrap">
                  <input class="btn-check" type="radio" id="pmCOD" th:field="*{paymentMethod}" value="COD" required>
                  <label class="btn btn-outline-secondary" for="pmCOD">Thanh toán khi nhận hàng (COD)</label>

                  <input class="btn-check" type="radio" id="pmVNPAY" th:field="*{paymentMethod}" value="VNPAY">
                  <label class="btn btn-outline-secondary" for="pmVNPAY">Chuyển khoản ngân hàng (VNPAY)</label>
                </div>
                <div class="invalid-feedback d-block"
                     th:if="${#fields.hasErrors('paymentMethod')}"
                     th:errors="*{paymentMethod}">
                  Vui lòng chọn phương thức thanh toán.
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4 actions-stack">
              <a th:href="@{/cart}" class="btn btn-outline-secondary">← Quay lại giỏ hàng</a>
              <button type="submit" class="btn btn-success">Xác nhận thanh toán</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Right: Order summary -->
      <div class="col-lg-5">
        <div class="card-glass p-4 p-lg-5 sticky-summary">
          <h2 class="section-heading mb-3">Tóm tắt đơn hàng</h2>

          <!-- Coupon -->
          <form th:action="@{/cart/apply-discount}" method="post" class="mb-3">
            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <label class="coupon-label mb-2">Mã khuyến mãi</label>
            <div class="input-group">
              <input type="text" name="discountCode" class="form-control" placeholder="Nhập mã giảm giá"
                     th:value="${discountCode != null ? discountCode : session.discountCode}">
              <button class="btn btn-primary" type="submit">Áp dụng</button>
            </div>
          </form>

          <!-- Flash messages -->
          <div th:if="${success}" class="alert alert-success py-2 px-3" th:text="${success}"></div>
          <div th:if="${error}"   class="alert alert-danger  py-2 px-3" th:text="${error}"></div>

          <!-- Items -->
          <div class="mb-3" th:each="item : ${cartItems}">
            <div class="d-flex align-items-center gap-3 py-2 border-bottom">
              <img class="item-thumb" th:src="${item.laptop.imageUrl}" th:alt="${item.laptop.name}">
              <div class="flex-grow-1">
                <div class="fw-semibold" th:text="${item.laptop.name}">Tên sản phẩm</div>
                <div class="qty small">Số lượng: <span th:text="${item.quantity}">0</span></div>
              </div>
              <div class="price" th:text="${#numbers.formatDecimal(item.laptop.price * item.quantity,0,'COMMA',0,'POINT')} + ' ₫'">0 ₫</div>
            </div>
          </div>

          <!-- Totals -->
          <div class="total-box p-3 p-md-4 mt-2">
            <div class="line">
              <span class="muted">Tổng trước giảm</span>
              <span class="fw-semibold" th:text="${#numbers.formatDecimal(totalPrice,0,'COMMA',0,'POINT')} + ' ₫'">0 ₫</span>
            </div>

            <div class="line" th:with="
                  da=${discountAmount   != null ? discountAmount   : session.discountAmount},
                  dc=${discountCode     != null ? discountCode     : session.discountCode},
                  dp=${discountPercent  != null ? discountPercent  : session.discountPercent}
                " th:if="${da != null and da > 0}">
              <span>
                Giảm giá
                <span class="text-muted">(<span th:text="${dc}">CODE</span>
                  <span th:if="${dp != null}"> - <span th:text="${dp}">0</span>%</span>)
                </span>
              </span>
              <span class="fw-semibold" th:text="${#numbers.formatDecimal(da,0,'COMMA',0,'POINT')} + ' ₫'">0 ₫</span>
            </div>

            <div class="line total" th:with="
                  da=${discountAmount        != null ? discountAmount        : session.discountAmount},
                  tad=${totalAfterDiscount   != null ? totalAfterDiscount    : null}
                ">
              <span>Tổng thanh toán</span>
              <span th:text="${
                    (da != null and da > 0)
                    ? #numbers.formatDecimal((tad != null ? tad : (totalPrice - da)),0,'COMMA',0,'POINT') + ' ₫'
                    : #numbers.formatDecimal(totalPrice,0,'COMMA',0,'POINT') + ' ₫'
                  }">0 ₫</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
</body>
</html>

