<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>Danh sách Laptop</title>
  <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body { background: #f8f9fa; }
    .navbar { z-index: 1100; }
    body { padding-top: 72px; }
    @media (max-width: 991.98px) { body { padding-top: 56px; } }

    #hero { width: 100%; }
    #hero .row { display: flex; margin: 0; }
    #hero .col-12 { flex: 1; padding: 0; display: flex; align-items: center; justify-content: center; }
    #hero img { max-width: 100%; width: auto; height: auto; max-height: 340px; object-fit: contain; display: block; margin: 0 auto; }

    .card-product { border: none; border-radius: 1rem; overflow: hidden; transition: transform .3s, box-shadow .3s; }
    .card-product:hover { transform: translateY(-5px); box-shadow: 0 1rem 2rem rgba(0,0,0,.2); }
    .card-product .card-img-top { object-fit: cover; height: 180px; }

    #contact-home { background: #5865f2; color: #fff; padding: 4rem 0; }
    #contact-home .contact-item { text-align: center; margin-bottom: 1.5rem; }
    #contact-home .contact-item i { font-size: 2rem; margin-bottom: .5rem; display: block; }
    #contact-home .contact-item p { margin: 0; font-size: 1.1rem; }

    .offcanvas-end { width: 300px; }

    #chat-toggle {
      position: fixed; bottom: 90px; right: 20px; width: 50px; height: 50px;
      background: #5865f2; color: #fff; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 1200; box-shadow: 0 0 .5rem rgba(0,0,0,.3);
      text-decoration: none;
    }

    #chat-box { position: fixed; bottom: 80px; right: 20px; width: 300px; max-height: 400px; background: #fff; border: 1px solid #ccc; border-radius: .5rem; box-shadow: 0 0 .5rem rgba(0,0,0,.3); display: none; flex-direction: column; z-index: 1200; }
    #chat-box.open { display: flex; }
    #chat-header { padding: 8px; background: #5865f2; color: #fff; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
    #chat-header button { background: transparent; border: none; color: #fff; font-size: 1.2rem; cursor: pointer; }
    #chat-box #messageArea { flex: 1; padding: 10px; overflow-y: auto; }
    #chat-box #inputArea { display: flex; padding: 8px; border-top: 1px solid #eee; }
    #chat-box #inputArea input { flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: .25rem; }
    #chat-box #inputArea button { margin-left: 5px; padding: 5px 10px; }

    .site-annc--hero{
      position: fixed; top:0; left:0; width:100%;
      height: 240px; display:flex; align-items:center; justify-content:center;
      padding: 0 16px; background-size: contain; background-repeat: no-repeat; background-position: center center;
      background-color: #000; box-shadow: 0 10px 30px rgba(0,0,0,.25); z-index: 1300;
    }
    @media (max-width: 991.98px){ .site-annc--hero{ height:200px; } }
    .site-annc__inner{ max-width:1200px; width:100%; position:relative; }
    .site-annc__content{ text-align:center; }
    .site-annc__text{ font-size: clamp(22px, 3.6vw, 40px); font-weight: 800; color: #fff; text-shadow: 0 2px 8px rgba(0,0,0,.35); line-height: 1.2; }
    .site-annc__close{ position:absolute; right:14px; top:14px; font-size: 32px; line-height:1; border:none; background:transparent; color:#fff; opacity:.95; cursor:pointer; }

    .site-annc--info{ background-color:#5aa0ff; }
    .site-annc--success{ background-color:#2e7d32; }
    .site-annc--warning{ background-color:#ff9800; }
    .site-annc--danger{ background-color:#c81e1e; }

    /* ⭐ Rating stars */
    .stars { position:relative; display:inline-block; font-size:14px; line-height:1; }
    .stars::before { content:"★★★★★"; letter-spacing:2px; color:#e5e7eb; }
    .stars .fill { position:absolute; inset:0; width:0; overflow:hidden; white-space:nowrap; }
    .stars .fill::before { content:"★★★★★"; letter-spacing:2px; color:#f59e0b; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow fixed-top">
    <div class="container">
      <a class="navbar-brand fw-bold" th:href="@{/}">Laptop Shop</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
              aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarCollapse">
        <form class="d-flex me-auto" th:action="@{/laptops}" method="get">
          <input class="form-control me-2" type="search" name="brand" th:value="${brand}" placeholder="Bạn cần tìm gì?">
          <input type="hidden" name="size" th:value="${pageLaptops.size}">
          <input type="hidden" name="category" th:value="${category}">
          <input type="hidden" name="categoryId" th:value="${selectedCategoryId}">
          <input type="hidden" name="sort" th:value="${sort}">
          <input type="hidden" name="priceRange" th:value="${priceRange}">
          <input type="hidden" name="ram" th:value="${ram}">
          <input type="hidden" name="cpu" th:value="${cpu}">
          <input type="hidden" name="brandFilter" th:value="${brandFilter}">
          <button class="btn btn-outline-light" type="submit">Tìm</button>
        </form>
        <ul class="navbar-nav mx-auto">
          <li class="nav-item me-2"><a class="btn btn-primary" th:href="@{/contact}">Liên hệ</a></li>
          <li class="nav-item">
            <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#infoModal">Địa chỉ</button>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto align-items-center">
          <li class="nav-item me-2" sec:authorize="!isAuthenticated()">
            <a class="btn btn-primary" th:href="@{/login}">Đăng nhập</a>
          </li>
          <li class="nav-item" sec:authorize="!isAuthenticated()">
            <a class="btn btn-primary" th:href="@{/register}">Đăng ký</a>
          </li>

          <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
            <button class="btn btn-primary dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown">
              <i class="bi bi-person-circle me-1"></i><span sec:authentication="name">User</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
              <li><a class="dropdown-item" th:href="@{/profile}">Hồ sơ</a></li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <form th:action="@{/logout}" method="post" class="m-0">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                  <button type="submit" class="dropdown-item w-100 text-start bg-transparent border-0">Đăng xuất</button>
                </form>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ===== ANNOUNCEMENT HERO ===== -->
  <div sec:authorize="isAuthenticated()"
       th:if="${activeAnn != null and (showDiscountAnn != null ? showDiscountAnn : false)}"
       th:with="variant=${#strings.toLowerCase(activeAnn.variant != null ? activeAnn.variant : 'INFO')}">
    <div id="site-announcement"
         th:class="|site-annc site-annc--hero site-annc--${variant}|"
         th:style="${activeAnn.imageUrl} != null ?
                   'background-image: linear-gradient(rgba(0,0,0,.35), rgba(0,0,0,.35)), url(' + activeAnn.imageUrl + ');'
                   : null">
      <div class="site-annc__inner">
        <div class="site-annc__content">
          <span class="site-annc__text" th:utext="${activeAnn.message}">Thông báo</span>
        </div>
        <button class="site-annc__close" type="button" aria-label="Đóng" onclick="hideAnn()">×</button>
      </div>
    </div>
    <div id="site-annc-spacer"></div>
  </div>

  <!-- Hero Banner -->
  <section id="hero" class="container-fluid px-0 mb-5">
    <div class="row g-0">
      <div class="col-12 col-md-3"><img th:src="@{/images/banner-left.jpg}" alt="" class="img-fluid"></div>
      <div class="col-12 col-md-6"><img th:src="@{/images/banner-center.jpg}" alt="" class="img-fluid"></div>
      <div class="col-12 col-md-3"><img th:src="@{/images/banner-right.jpg}" alt="" class="img-fluid"></div>
    </div>
  </section>

  <!-- 1. Classification Tabs + Controls -->
  <div class="container py-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a class="nav-link"
             th:classappend="${(selectedCategoryId==null and (category=='all' or category==null))}?'active':''"
             th:href="@{/laptops(brand=${brand}, sort=${sort}, priceRange=${priceRange}, ram=${ram}, cpu=${cpu}, brandFilter=${brandFilter}, size=${pageLaptops.size})}">
            Tất cả
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link"
             th:classappend="${selectedCategoryId==1 or category=='office'}?'active':''"
             th:href="@{/laptops(categoryId=1, brand=${brand}, sort=${sort}, priceRange=${priceRange}, ram=${ram}, cpu=${cpu}, brandFilter=${brandFilter}, size=${pageLaptops.size})}">
            Laptop văn phòng
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link"
             th:classappend="${selectedCategoryId==3 or category=='gaming'}?'active':''"
             th:href="@{/laptops(categoryId=3, brand=${brand}, sort=${sort}, priceRange=${priceRange}, ram=${ram}, cpu=${cpu}, brandFilter=${brandFilter}, size=${pageLaptops.size})}">
            Laptop gaming
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link"
             th:classappend="${selectedCategoryId==2 or category=='study'}?'active':''"
             th:href="@{/laptops(categoryId=2, brand=${brand}, sort=${sort}, priceRange=${priceRange}, ram=${ram}, cpu=${cpu}, brandFilter=${brandFilter}, size=${pageLaptops.size})}">
            Laptop sinh viên
          </a>
        </li>
      </ul>
      <div class="d-flex mt-2 mt-md-0">
        <button class="btn btn-outline-secondary me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterOffcanvas">
          <i class="bi bi-funnel-fill me-1"></i>Bộ lọc
        </button>
        <div class="dropdown">
          <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown">
            <i class="bi bi-arrow-down-up me-1"></i>Sắp xếp
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sortDropdown">
            <li><a class="dropdown-item"
                   th:href="@{/laptops(sort='new',      category=${category}, categoryId=${selectedCategoryId}, brand=${brand}, priceRange=${priceRange}, ram=${ram}, cpu=${cpu}, brandFilter=${brandFilter}, size=${pageLaptops.size})}">Mới nhất</a></li>
            <li><a class="dropdown-item"
                   th:href="@{/laptops(sort='priceAsc', category=${category}, categoryId=${selectedCategoryId}, brand=${brand}, priceRange=${priceRange}, ram=${ram}, cpu=${cpu}, brandFilter=${brandFilter}, size=${pageLaptops.size})}">Giá thấp → cao</a></li>
            <li><a class="dropdown-item"
                   th:href="@{/laptops(sort='priceDesc',category=${category}, categoryId=${selectedCategoryId}, brand=${brand}, priceRange=${priceRange}, ram=${ram}, cpu=${cpu}, brandFilter=${brandFilter}, size=${pageLaptops.size})}">Giá cao → thấp</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- 1.1 Offcanvas Filter Sidebar -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="filterOffcanvas">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Bộ lọc</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <form th:action="@{/laptops}" method="get">
        <input type="hidden" name="category"    th:value="${category}"    />
        <input type="hidden" name="categoryId"  th:value="${selectedCategoryId}" />
        <input type="hidden" name="brand"       th:value="${brand}"       />
        <input type="hidden" name="sort"        th:value="${sort}"        />
        <input type="hidden" name="size"        th:value="${pageLaptops.size}" />

        <div class="mb-3">
          <label class="form-label">Giá</label>
          <select class="form-select" name="priceRange">
            <option value=""                   th:selected="${priceRange==null or priceRange==''}">Tất cả</option>
            <option value="0-10000000"         th:selected="${priceRange=='0-10000000'}">Dưới 10 triệu</option>
            <option value="10000000-30000000"  th:selected="${priceRange=='10000000-30000000'}">10–30 triệu</option>
            <option value="30000000-"          th:selected="${priceRange=='30000000-'}">Trên 30 triệu</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">RAM</label>
          <select class="form-select" name="ram">
            <option value=""  th:selected="${ram==null or ram==''}">Tất cả</option>
            <option value="4" th:selected="${ram=='4'}">4 GB</option>
            <option value="8" th:selected="${ram=='8'}">8 GB</option>
            <option value="16" th:selected="${ram=='16'}">16 GB</option>
            <option value="32" th:selected="${ram=='32'}">32 GB</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">CPU</label>
          <select class="form-select" name="cpu">
            <option value=""      th:selected="${cpu==null or cpu==''}">Tất cả</option>
            <option value="Intel" th:selected="${cpu=='Intel'}">Intel</option>
            <option value="AMD"   th:selected="${cpu=='AMD'}">AMD</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Hãng</label>
          <select class="form-select" name="brandFilter">
            <option value=""       th:selected="${brandFilter==null or brandFilter==''}">Tất cả</option>
            <option value="HP"     th:selected="${brandFilter=='HP'}">HP</option>
            <option value="Dell"   th:selected="${brandFilter=='Dell'}">Dell</option>
            <option value="Asus"   th:selected="${brandFilter=='Asus'}">Asus</option>
            <option value="Acer"   th:selected="${brandFilter=='Acer'}">Acer</option>
            <option value="Lenovo" th:selected="${brandFilter=='Lenovo'}">Lenovo</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary">Áp dụng</button>
      </form>
    </div>
  </div>

  <!-- 2. Lưới sản phẩm -->
  <div class="container py-5">
    <h2 class="text-center mb-5 display-6">
      <span th:if="${selectedCategoryId == null}" th:switch="${category}">
        <span th:case="'all'">Gợi ý cho bạn</span>
        <span th:case="'office'">Laptop văn phòng</span>
        <span th:case="'gaming'">Sản phẩm Gaming</span>
        <span th:case="'study'">Laptop sinh viên</span>
        <span th:case="*">Sản phẩm nổi bật</span>
      </span>
      <span th:if="${selectedCategoryId != null}" th:switch="${selectedCategoryId}">
        <span th:case="1">Laptop văn phòng</span>
        <span th:case="2">Laptop sinh viên</span>
        <span th:case="3">Sản phẩm Gaming</span>
        <span th:case="*">Gợi ý cho bạn</span>
      </span>
    </h2>

    <div class="row g-4">
      <div class="col-6 col-md-4 col-lg-3" th:each="lap : ${products}">
        <div class="card card-product h-100 shadow-sm">
          <img th:src="@{${lap.imageUrl}}" th:alt="${lap.name}" class="card-img-top">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title" th:text="${lap.name}">Tên Laptop</h5>
            <p class="text-muted mb-2" th:text="${lap.brand}">Thương hiệu</p>

            <!-- Giá -->
            <h5 class="text-primary fw-bold mt-auto"
                th:text="|${T(java.lang.String).format('%,.0f', lap.price)} ₫|">0 ₫</h5>

            <!-- ⭐ Đánh giá: sao + điểm + (số review) + % -->
            <div class="d-flex align-items-center gap-2 mt-1"
                 th:with="agg=${ratingAgg[lap.id]},
                          avgVal=${agg != null and agg.avg != null ? agg.avg : 0},
                          cntVal=${agg != null ? agg.count : 0},
                          pctVal=${ratingPct[lap.id] != null ? ratingPct[lap.id] : 0}">
              <span class="stars" aria-label="Đánh giá">
                <span class="fill" th:style="|width:${pctVal}%;|"></span>
              </span>
              <small class="text-muted" th:text="|${#numbers.formatDecimal(avgVal,1,1)}/5|">0.0/5</small>
              <small class="text-muted" th:text="|(${cntVal})|">(0)</small>
              <small class="ms-1 text-secondary" th:text="|${pctVal}%|">0%</small>
            </div>

            <a th:href="@{/product/{id}(id=${lap.id})}" class="btn btn-outline-primary mt-3">Xem chi tiết</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Hiện phân trang khi có hơn 1 trang -->
<nav th:if="${pageLaptops.totalPages > 1}">
  <ul class="pagination justify-content-center mt-4">

    <!-- Prev -->
    <li class="page-item" th:classappend="${currentPage == 0}?'disabled':''">
      <a class="page-link"
         th:href="@{/laptops(
            page=${currentPage-1},
            size=${pageLaptops.size},
            brand=${brand},
            category=${category},
            categoryId=${selectedCategoryId},
            sort=${sort},
            priceRange=${priceRange},
            ram=${ram},
            cpu=${cpu},
            brandFilter=${brandFilter}
         )}">« Prev</a>
    </li>

    <!-- Pages -->
    <li class="page-item"
        th:each="i : ${#numbers.sequence(0, pageLaptops.totalPages-1)}"
        th:classappend="${i == currentPage}?'active':''">
      <a class="page-link"
         th:text="${i+1}"
         th:href="@{/laptops(
            page=${i},
            size=${pageLaptops.size},
            brand=${brand},
            category=${category},
            categoryId=${selectedCategoryId},
            sort=${sort},
            priceRange=${priceRange},
            ram=${ram},
            cpu=${cpu},
            brandFilter=${brandFilter}
         )}">1</a>
    </li>

    <!-- Next -->
    <li class="page-item" th:classappend="${currentPage == pageLaptops.totalPages-1}?'disabled':''">
      <a class="page-link"
         th:href="@{/laptops(
            page=${currentPage+1},
            size=${pageLaptops.size},
            brand=${brand},
            category=${category},
            categoryId=${selectedCategoryId},
            sort=${sort},
            priceRange=${priceRange},
            ram=${ram},
            cpu=${cpu},
            brandFilter=${brandFilter}
         )}">Next »</a>
    </li>

  </ul>
</nav>

  </div>

  <!-- store info modal & contact section -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">Thông tin cửa hàng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><i class="bi bi-geo-fill me-2"></i>123 Đường QL1A, Quận 12, TP. HCM</p>
        <p><i class="bi bi-telephone-fill me-2"></i>0394166913</p>
        <p><i class="bi bi-envelope-fill me-2"></i>khoas1612@gmail.com</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div></div>
  </div>

  <section id="contact-home">
    <div class="container text-center">
      <h2>Liên hệ với chúng tôi</h2>
      <div class="row justify-content-center mt-4">
        <div class="col-md-4 contact-item"><i class="bi bi-geo-fill"></i><p>123 Đường QL1A, Quận 12, TP. HCM</p></div>
        <div class="col-md-4 contact-item"><i class="bi bi-telephone-fill"></i><p>0394166913</p></div>
        <div class="col-md-4 contact-item"><i class="bi bi-envelope-fill"></i><p>khoas1612@gmail.com</p></div>
      </div>
      <div class="row justify-content-center mt-4">
        <div class="col-12"><div style="width:100%;height:300px;overflow:hidden;border-radius:1rem;">
          <iframe width="100%" height="100%" frameborder="0" style="border:0"
                  src="https://maps.google.com/maps?q=10.861633,106.657286&z=19&output=embed"
                  allowfullscreen loading="lazy"></iframe>
        </div></div>
      </div>
    </div>
  </section>

  <!-- Floating Cart CTA -->
  <a th:href="@{/cart}"
     class="btn btn-primary position-fixed"
     style="bottom:20px; right:20px; border-radius:50%; width:60px; height:60px;
            display:flex; align-items:center; justify-content:center;
            box-shadow:0 0 .5rem rgba(0,0,0,.3);">
    <i class="bi bi-cart2" style="font-size:1.5rem;"></i>
    <span class="badge bg-danger position-absolute top-0 start-100 translate-middle">
      [[${cartItemCount}]]
    </span>
  </a>

  <!-- ✅ Chat FAB: chuyển trang -->
  <a id="chat-toggle" class="d-inline-flex"
     sec:authorize="isAuthenticated()"
     th:href="@{/chat}"
     title="Chat với Admin">
    <i class="bi bi-chat-dots-fill" style="font-size:1.5rem;"></i>
  </a>
  <a id="chat-toggle" class="d-inline-flex"
     sec:authorize="!isAuthenticated()"
     th:href="@{/login(continue='/chat')}"
     title="Đăng nhập để chat">
    <i class="bi bi-chat-dots-fill" style="font-size:1.5rem;"></i>
  </a>

  <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <!-- Chat panel markup giữ nguyên (luôn ẩn, để đủ file) -->
  <div id="chat-box" aria-hidden="true">
    <div id="chat-header">
      Chat với chúng tôi
      <button id="chat-close" type="button" aria-label="Đóng">&times;</button>
    </div>
    <div id="messageArea"></div>
    <div id="inputArea">
      <input type="text" id="chatInput" placeholder="Nhập tin nhắn..." autocomplete="off"/>
      <button id="sendBtn" type="button">Gửi</button>
    </div>
  </div>

  <!-- Announcement helper -->
  <script>
    function hideAnn(){
      const bar = document.getElementById('site-announcement');
      const sp  = document.getElementById('site-annc-spacer');
      if (bar) bar.style.display = 'none';
      if (sp)  sp.style.display  = 'none';
    }
    function adjustSpacer(){
      const bar = document.getElementById('site-announcement');
      const sp  = document.getElementById('site-annc-spacer');
      if (bar && sp) sp.style.height = bar.offsetHeight + 'px';
    }
    window.addEventListener('load', adjustSpacer);
    window.addEventListener('resize', adjustSpacer);
  </script>
</body>
</html>
