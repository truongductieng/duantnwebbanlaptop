<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Đăng ký – Laptop Shop</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <style>
      :root {
        --brand: #28a745; /* primary green used on login */
        --brand-2: #1f7a3a;
        --bg-1: #a8d8ff; /* light blue */
        --bg-2: #d6b8ff; /* light purple */
        --header-dark: #82abef; /* dark blue header */
        --danger: #db4437;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        /* match login background gradient */
        background: linear-gradient(135deg, var(--bg-1) 0%, var(--bg-2) 100%);
        min-height: 100vh;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, "Apple Color Emoji", "Segoe UI Emoji";
      }
      .card {
        width: 100%;
        max-width: 430px;
        background: #fff;
        border: 0;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 20px 45px rgba(0, 0, 0, 0.25);
      }
      .card-header {
        background: var(--header-dark);
        color: #fff;
        text-align: center;
        padding: 18px 16px;
      }
      .card-body {
        padding: 20px 20px 16px;
      }
      .form-label {
        font-weight: 600;
      }
      .form-control {
        border-radius: 12px;
        border: 1px solid #e6e6ef;
        padding: 10px 14px;
        transition: 0.15s ease;
      }
      .form-control:focus {
        border-color: var(--brand);
        box-shadow: 0 0 0 0.2rem rgba(88, 101, 242, 0.2);
      }
      .btn {
        border-radius: 12px;
        font-weight: 700;
      }
      .btn-primary {
        background: var(--brand);
        border-color: var(--brand);
        color: #fff;
      }
      .btn-primary:hover {
        background: var(--brand-2);
        border-color: var(--brand-2);
        transform: translateY(-1px);
      }
      .input-group-text {
        background: #f0f0f0;
      }
      .position-relative .form-control {
        padding-right: 3rem;
      }
      .position-relative .toggle,
      #togglePassword {
        position: absolute;
        top: 55%;
        right: 1rem;
        transform: translateY(-50%);
        border: 0;
        background: transparent;
        color: #6c757d;
        cursor: pointer;
        padding: 6px;
        line-height: 1;
      }
      .position-relative .toggle:hover,
      #togglePassword:hover {
        color: #495057;
      }
      .alert {
        border-radius: 12px;
      }
      @media (max-width: 480px) {
        .card {
          margin: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="card-header">Đăng ký</div>
      <div class="card-body">
        <div
          id="successMessage"
          class="alert alert-success text-center"
          style="display: none"
        >
          ✅ Đăng ký thành công!
        </div>

        <form
          id="registerForm"
          th:action="@{/register}"
          method="post"
          novalidate
        >
          <input
            type="hidden"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}"
          />

          <!-- Username -->
          <div class="input-group mb-1">
            <span class="input-group-text"><i class="fa fa-user"></i></span>
            <input
              type="text"
              name="username"
              class="form-control"
              placeholder="Chọn tên đăng nhập"
              autocomplete="username"
              required
            />
          </div>
          <div id="usernameError" class="text-danger mb-2"></div>

          <!-- Email -->
          <div class="input-group mb-1">
            <span class="input-group-text"><i class="fa fa-envelope"></i></span>
            <input
              type="email"
              name="email"
              class="form-control"
              placeholder="Nhập email"
              autocomplete="email"
              required
            />
          </div>
          <div id="emailError" class="text-danger mb-2"></div>

          <!-- Phone -->
          <div class="input-group mb-3">
            <span class="input-group-text"><i class="fa fa-phone"></i></span>
            <input
              type="tel"
              name="phone"
              class="form-control"
              placeholder="Nhập số điện thoại"
              pattern="[0-9]{10,15}"
              title="Nhập 10–15 chữ số"
              required
            />
          </div>
          <div id="phoneError" class="text-danger mb-2"></div>

          <!-- Password -->
          <div class="input-group mb-2 position-relative">
            <span class="input-group-text"><i class="fa fa-lock"></i></span>
            <input
              id="password"
              type="password"
              name="password"
              class="form-control"
              placeholder="Chọn mật khẩu (tối thiểu 6 ký tự)"
              minlength="6"
              autocomplete="new-password"
              required
            />
            <span id="togglePassword"><i class="fa fa-eye"></i></span>
          </div>
          <div id="passwordError" class="text-danger mb-3"></div>

          <button type="submit" id="btnSubmit" class="btn btn-primary w-100">
            Đăng ký
          </button>
        </form>

        <hr />
        <p class="text-center mb-0">
          Đã có tài khoản?
          <a th:href="@{/login}">Đăng nhập ngay</a>
        </p>
      </div>
    </div>

    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script>
      // Toggle show/hide password
      document
        .getElementById("togglePassword")
        .addEventListener("click", () => {
          const pwd = document.getElementById("password");
          pwd.type = pwd.type === "password" ? "text" : "password";
          const icon = document.querySelector("#togglePassword i");
          icon.classList.toggle("fa-eye");
          icon.classList.toggle("fa-eye-slash");
        });

      // ====== Uniqueness check + Submit AJAX ======
      const form = document.getElementById("registerForm");
      const successMsg = document.getElementById("successMessage");
      const btnSubmit = document.getElementById("btnSubmit");

      const usernameInput = form.querySelector('input[name="username"]');
      const emailInput = form.querySelector('input[name="email"]');
      const phoneInput = form.querySelector('input[name="phone"]');
      const passwordInput = form.querySelector('input[name="password"]');

      const usernameError = document.getElementById("usernameError");
      const emailError = document.getElementById("emailError");
      const phoneError = document.getElementById("phoneError");
      const passwordError = document.getElementById("passwordError");

      let debounceTimer;
      function debounce(fn, delay) {
        return function () {
          clearTimeout(debounceTimer);
          const ctx = this,
            args = arguments;
          debounceTimer = setTimeout(() => fn.apply(ctx, args), delay);
        };
      }

      async function checkUnique() {
        const params = new URLSearchParams();
        if (usernameInput.value.trim())
          params.append("username", usernameInput.value.trim());
        if (emailInput.value.trim())
          params.append("email", emailInput.value.trim());

        if (![...params.keys()].length) {
          usernameError.textContent = "";
          emailError.textContent = "";
          updateSubmitState();
          return;
        }

        try {
          // Endpoint công khai (permitAll) để check trùng ngay khi gõ
          const res = await fetch(`/auth/check-unique?${params.toString()}`, {
            method: "GET",
          });
          if (!res.ok) return;
          const data = await res.json();

          usernameError.textContent = data.usernameTaken
            ? "Tên đăng nhập đã tồn tại, vui lòng chọn tên khác."
            : "";
          emailError.textContent = data.emailTaken
            ? "Email đã tồn tại, vui lòng nhập email khác."
            : "";
        } catch (e) {
          // im lặng nếu lỗi mạng
        } finally {
          updateSubmitState();
        }
      }

      function validatePassword() {
        if (!passwordInput.value || passwordInput.value.length < 6) {
          passwordError.textContent = "Mật khẩu phải tối thiểu 6 ký tự.";
        } else {
          passwordError.textContent = "";
        }
      }

      function validatePhone() {
        const ok = /^[0-9]{10,15}$/.test(phoneInput.value);
        phoneError.textContent = ok ? "" : "Số điện thoại phải gồm 10 chữ số.";
      }

      function updateSubmitState() {
        const hasErr =
          !!usernameError.textContent ||
          !!emailError.textContent ||
          !!passwordError.textContent ||
          !!phoneError.textContent;

        btnSubmit.disabled = hasErr;
      }

      const onTyping = debounce(() => {
        validatePassword();
        validatePhone();
        checkUnique();
      }, 250);

      // Gắn sự kiện
      usernameInput.addEventListener("input", onTyping);
      usernameInput.addEventListener("blur", checkUnique);

      emailInput.addEventListener("input", onTyping);
      emailInput.addEventListener("blur", checkUnique);

      phoneInput.addEventListener("input", onTyping);
      passwordInput.addEventListener("input", onTyping);

      // Submit AJAX + nhận JSON lỗi { field, message }
      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        successMsg.style.display = "none";

        // Re-validate trước khi submit
        validatePassword();
        validatePhone();
        await checkUnique();
        if (btnSubmit.disabled) return;

        // Xóa lỗi cũ từ server
        ["usernameError", "emailError", "phoneError", "passwordError"].forEach(
          (id) => (document.getElementById(id).textContent = "")
        );

        try {
          const resp = await fetch(form.action, {
            method: "POST",
            body: new FormData(form),
          });

          if (resp.ok) {
            // Tuỳ backend: nếu trả JSON có message thì có thể đọc thêm
            successMsg.style.display = "block";
            form.reset();
            updateSubmitState();
            // Nếu muốn chuyển về trang đăng nhập sau 1.5s:
            // setTimeout(() => window.location.href = '/login', 1500);
          } else {
            const err = await resp.json().catch(() => ({}));
            if (err && err.field && err.message) {
              const el = document.getElementById(err.field + "Error");
              if (el) el.textContent = err.message;
              else alert(err.message);
            } else {
              alert(err.message || "Đăng ký thất bại.");
            }
            updateSubmitState();
          }
        } catch (ex) {
          alert("Không thể kết nối máy chủ. Vui lòng thử lại.");
        }
      });
    </script>
  </body>
</html>
