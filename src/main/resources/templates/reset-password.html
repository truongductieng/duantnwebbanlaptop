<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Đặt lại mật khẩu</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea, #764ba2);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #fff;
      }
      .reset-box {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(12px);
        padding: 2.5rem;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        width: 100%;
        max-width: 460px;
        animation: fadeIn 1s ease;
      }
      .reset-box h3 {
        font-weight: 700;
        text-align: center;
        margin-bottom: 1.5rem;
      }
      .form-label {
        font-weight: 500;
      }
      .form-control {
        border-radius: 12px;
        padding: 0.75rem 1rem;
        border: none;
        outline: none;
      }
      .input-group-text {
        border: none;
        border-radius: 12px;
      }
      .btn-custom {
        width: 100%;
        background: #5865f2;
        color: #fff;
        font-weight: 600;
        border-radius: 12px;
        padding: 0.75rem;
        transition: all 0.3s ease;
      }
      .btn-custom:hover {
        background: #4752c4;
        transform: translateY(-2px);
      }
      .extra-links {
        text-align: center;
        margin-top: 1rem;
      }
      .extra-links a {
        color: #fff;
        text-decoration: none;
        font-weight: 500;
      }
      .extra-links a:hover {
        text-decoration: underline;
      }
      .alert {
        border: none;
        border-radius: 12px;
      }
      .strength {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
        margin-top: 0.5rem;
      }
      .bar {
        height: 6px;
        background: rgba(255, 255, 255, 0.35);
        border-radius: 6px;
        transition: background 0.3s ease;
      }
      .bar.active-1 {
        background: #ff4d4f;
      }
      .bar.active-2 {
        background: #ffa940;
      }
      .bar.active-3 {
        background: #faad14;
      }
      .bar.active-4 {
        background: #52c41a;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
    <!-- Optional: favicon could go here -->
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#5865f2" />
    <meta name="description" content="Đặt lại mật khẩu tài khoản Laptop Shop" />
    <meta name="robots" content="noindex, nofollow" />
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <script>
      // Avoid submitting twice
      function preventDoubleSubmit(btn) {
        btn.disabled = true;
        btn.innerHTML =
          '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';
        return true;
      }
    </script>
    <noscript>
      <style>
        .strength {
          display: none;
        }
      </style>
    </noscript>
    <!-- security headers suggestion (served by server) -->
    <!-- Content-Security-Policy could be configured in server if needed -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-Frame-Options" content="DENY" />
    <meta http-equiv="Referrer-Policy" content="no-referrer" />
  </head>
  <body>
    <div class="reset-box">
      <h3><i class="fas fa-key me-2"></i>Đặt lại mật khẩu</h3>

      <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
      <div
        th:if="${message}"
        class="alert alert-success"
        th:text="${message}"
      ></div>

      <form
        th:action="@{/reset-password}"
        method="post"
        onsubmit="return onSubmitReset(this);"
      >
        <input
          type="hidden"
          th:name="${_csrf.parameterName}"
          th:value="${_csrf.token}"
        />
        <input type="hidden" name="token" th:value="${token}" />

        <div class="mb-3">
          <label for="password" class="form-label">Mật khẩu mới</label>
          <div class="input-group">
            <input
              id="password"
              name="password"
              type="password"
              class="form-control"
              minlength="6"
              placeholder="Nhập mật khẩu mới"
              required
              oninput="updateStrength();"
            />
            <button
              class="input-group-text"
              type="button"
              onclick="togglePw('password', this)"
              title="Hiện/ẩn mật khẩu"
            >
              <i class="fa-regular fa-eye"></i>
            </button>
          </div>
          <div class="form-text text-light">
            Tối thiểu 6 ký tự. Nên có chữ hoa, số và ký tự đặc biệt.
          </div>
          <div class="strength" aria-hidden="true">
            <div class="bar" id="b1"></div>
            <div class="bar" id="b2"></div>
            <div class="bar" id="b3"></div>
            <div class="bar" id="b4"></div>
          </div>
        </div>

        <div class="mb-3">
          <label for="confirm" class="form-label">Nhập lại mật khẩu</label>
          <div class="input-group">
            <input
              id="confirm"
              type="password"
              class="form-control"
              minlength="6"
              placeholder="Nhập lại mật khẩu"
              required
            />
            <button
              class="input-group-text"
              type="button"
              onclick="togglePw('confirm', this)"
              title="Hiện/ẩn mật khẩu"
            >
              <i class="fa-regular fa-eye"></i>
            </button>
          </div>
        </div>

        <button type="submit" class="btn btn-custom">
          <i class="fas fa-save me-2"></i>Cập nhật mật khẩu
        </button>
      </form>

      <div class="extra-links">
        <a th:href="@{/login}"
          ><i class="fas fa-arrow-left"></i> Quay lại đăng nhập</a
        >
      </div>
    </div>

    <script>
      function togglePw(id, btn) {
        const inp = document.getElementById(id);
        const icon = btn.querySelector("i");
        if (inp.type === "password") {
          inp.type = "text";
          icon.classList.remove("fa-eye");
          icon.classList.add("fa-eye-slash");
        } else {
          inp.type = "password";
          icon.classList.remove("fa-eye-slash");
          icon.classList.add("fa-eye");
        }
      }

      function scorePassword(p) {
        let s = 0;
        if (!p) return s;
        const letters = {};
        for (let i = 0; i < p.length; i++) {
          letters[p[i]] = (letters[p[i]] || 0) + 1;
          s += 5.0 / letters[p[i]];
        }
        const variations = {
          digits: /\d/.test(p),
          lower: /[a-z]/.test(p),
          upper: /[A-Z]/.test(p),
          nonWords: /[^\w]/.test(p),
        };
        let variationCount = 0;
        for (let k in variations) {
          variationCount += variations[k] === true ? 1 : 0;
        }
        s += (variationCount - 1) * 10; // more variety -> stronger
        if (p.length >= 10) s += 10;
        return parseInt(s);
      }

      function updateStrength() {
        const pwd = document.getElementById("password").value;
        const val = scorePassword(pwd);
        const bars = [
          document.getElementById("b1"),
          document.getElementById("b2"),
          document.getElementById("b3"),
          document.getElementById("b4"),
        ];
        bars.forEach((b) => {
          b.className = "bar";
        });
        if (!pwd) return;
        const lvl = val < 20 ? 1 : val < 40 ? 2 : val < 70 ? 3 : 4;
        for (let i = 0; i < lvl; i++) {
          bars[i].classList.add("active-" + lvl);
        }
      }

      function onSubmitReset(form) {
        const p1 = document.getElementById("password").value.trim();
        const p2 = document.getElementById("confirm").value.trim();
        if (p1 !== p2) {
          alert("Mật khẩu nhập lại không khớp!");
          return false;
        }
        return preventDoubleSubmit(form.querySelector('button[type="submit"]'));
      }
    </script>

    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
  </body>
</html>
